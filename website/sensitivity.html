<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Engelberg Property Investment - Sensitivity Analysis</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary: #1a1a2e;
        --secondary: #0f3460;
        --accent: #667eea;
        --success: #28a745;
        --danger: #dc3545;
        --warning: #ffc107;
        --info: #17a2b8;
        --light: #f8f9fa;
        --dark: #2c3e50;
        --border: #dee2e6;
        --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        --sidebar-width: 250px;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto",
          "Helvetica Neue", Arial, sans-serif;
        background: #f5f6fa;
        color: var(--dark);
        line-height: 1.5;
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
      }

      /* Top Navigation Bar */
      .top-bar {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        color: white;
        padding: 12px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: var(--shadow);
        z-index: 1000;
      }

      .top-bar h1 {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
      }

      .case-selector {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .case-selector label {
        font-weight: 500;
        font-size: 0.9rem;
      }

      .case-selector select {
        padding: 6px 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        font-size: 0.9rem;
        min-width: 200px;
      }

      .case-selector select option {
        background: var(--primary);
        color: white;
      }

      /* Main Layout */
      .main-layout {
        display: flex;
        flex: 1;
        overflow: hidden;
      }

      /* Sidebar */
      .sidebar {
        width: var(--sidebar-width);
        background: white;
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        box-shadow: var(--shadow);
      }

      .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid var(--border);
        background: var(--light);
        font-weight: 600;
        color: var(--primary);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .sidebar-menu {
        list-style: none;
        padding: 10px 0;
      }

      .sidebar-menu-item {
        padding: 12px 20px;
        cursor: pointer;
        transition: all 0.2s ease;
        border-left: 4px solid transparent;
        display: flex;
        align-items: center;
        gap: 10px;
        text-decoration: none;
        color: var(--dark);
      }

      .sidebar-menu-item:hover {
        background: var(--light);
        border-left-color: var(--accent);
      }

      .sidebar-menu-item.active {
        background: rgba(102, 126, 234, 0.1);
        border-left-color: var(--accent);
      }

      .sidebar-menu-item i {
        width: 20px;
        text-align: center;
      }

      /* Main Content Area */
      .content-area {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f5f6fa;
      }

      /* Loading State */
      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 60vh;
        flex-direction: column;
        gap: 20px;
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--border);
        border-top: 4px solid var(--accent);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* KPI Cards */
      .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 20px;
      }

      .kpi-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: var(--shadow);
        border-left: 4px solid var(--accent);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      }

      .kpi-card h3 {
        font-size: 0.85rem;
        color: #7f8c8d;
        margin-bottom: 8px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .kpi-card .value {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 4px;
      }

      .kpi-card .value.positive {
        color: var(--success);
      }

      .kpi-card .value.negative {
        color: var(--danger);
      }

      .kpi-card .unit {
        font-size: 0.8rem;
        color: #95a5a6;
        font-weight: 500;
      }

      /* Chart Containers */
      .chart-container {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: var(--shadow);
      }

      .chart-container h3 {
        margin-bottom: 20px;
        color: var(--primary);
        font-size: 1.2rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .chart-wrapper {
        min-height: 400px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: white;
      }

      /* Data Tables */
      .data-table {
        background: white;
        border-radius: 12px;
        margin-bottom: 25px;
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      .data-table h3 {
        padding: 20px;
        margin: 0;
        border-bottom: 2px solid var(--border);
        background: #f8f9fa;
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--primary);
      }

      .data-table table {
        width: 100%;
        border-collapse: collapse;
      }

      .data-table th,
      .data-table td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid var(--border);
      }

      .data-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: var(--primary);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .data-table tbody tr:hover {
        background: #f8f9fa;
      }

      /* Section Styling */
      .section {
        margin-bottom: 30px;
      }

      .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      /* Tooltip Styling */
      .kpi-card[data-tooltip]:hover::before,
      .sidebar-menu-item[data-tooltip]:hover::before {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: var(--dark);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.8rem;
        white-space: nowrap;
        z-index: 1000;
        opacity: 0.95;
        box-shadow: var(--shadow);
        max-width: 300px;
        white-space: normal;
        word-wrap: break-word;
      }

      .kpi-card[data-tooltip]:hover::after,
      .sidebar-menu-item[data-tooltip]:hover::after {
        content: "";
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 5px solid transparent;
        border-top-color: var(--dark);
        margin-bottom: -5px;
        z-index: 1000;
      }

      /* Sidebar specific tooltip positioning */
      .sidebar-menu-item[data-tooltip]:hover::before {
        left: 100%;
        top: 50%;
        bottom: auto;
        transform: translateY(-50%);
        margin-left: 10px;
        max-width: 250px;
      }

      .sidebar-menu-item[data-tooltip]:hover::after {
        left: 100%;
        top: 50%;
        bottom: auto;
        transform: translateY(-50%);
        border: 5px solid transparent;
        border-left-color: var(--dark);
        margin-left: 5px;
        border-top: none;
        border-bottom: none;
        margin-bottom: 0;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .sidebar {
          width: 200px;
        }

        .kpi-grid {
          grid-template-columns: 1fr;
        }

        .top-bar h1 {
          font-size: 1.2rem;
        }

        .case-selector select {
          min-width: 150px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Top Navigation Bar -->
    <div class="top-bar">
      <h1><i class="fas fa-chart-line"></i> Engelberg Property Investment</h1>
      <div class="case-selector">
        <label for="caseSelect">Case:</label>
        <select id="caseSelect">
          <option value="base_case">Base Case</option>
          <option value="3_owners">3 Owners</option>
          <option value="4_owners">4 Owners</option>
          <option value="5_owners">5 Owners</option>
          <option value="900k_house">900K House Price</option>
          <option value="90day_restriction">90-Day Airbnb Restriction</option>
          <option value="climate_risk">Climate Risk Scenario</option>
          <option value="early_exit">Early Exit (Poor Performance)</option>
          <option value="interest_rate_spike">Interest Rate Spike</option>
          <option value="migros">Migros Scenario</option>
          <option value="saron_mortgage">SARON Mortgage</option>
        </select>
      </div>
    </div>

    <!-- Main Layout -->
    <div class="main-layout">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-header">
          <i class="fas fa-list"></i> Analysis Types
        </div>
        <ul class="sidebar-menu" id="analysisMenu">
          <li class="sidebar-menu-item" data-tooltip="Homepage - Overview of key financial metrics, purchase price, revenue, expenses, cash flow analysis, return metrics, and main cash requirements per owner. Start here to understand the basic investment performance.">
            <a href="index.html" style="display: flex; align-items: center; gap: 10px; text-decoration: none; color: inherit; width: 100%;">
              <i class="fas fa-home"></i> Homepage
            </a>
          </li>
          <li class="sidebar-menu-item active" data-tooltip="Sensitivity - Analyze how changes in key parameters (like occupancy rate, pricing, costs, etc.) impact monthly cash flow per owner. Use tornado charts to identify which variables have the biggest effect on your investment returns.">
            <a href="sensitivity.html" style="display: flex; align-items: center; gap: 10px; text-decoration: none; color: inherit; width: 100%;">
              <i class="fas fa-sliders-h"></i> Sensitivity
            </a>
          </li>
          <li class="sidebar-menu-item" data-tooltip="Monte Carlo - Probabilistic risk analysis showing NPV distribution and probability of success across 10,000 simulations. Understand the range of possible outcomes and quantify investment uncertainty.">
            <a href="monte_carlo.html" style="display: flex; align-items: center; gap: 10px; text-decoration: none; color: inherit; width: 100%;">
              <i class="fas fa-dice"></i> Monte Carlo
            </a>
          </li>
        </ul>
      </div>

      <!-- Main Content Area -->
      <div class="content-area" id="contentArea">
        <div class="loading">
          <div class="loading-spinner"></div>
          <p>Loading sensitivity analysis...</p>
        </div>
      </div>
    </div>

    <script>
      // State management
      const State = {
        currentCase: 'base_case',
        data: {},
        initialized: false
      };

      // Initialize the application
      async function initializeApp() {
        try {
          // Load cases index
          const casesResponse = await fetch('data/cases_index.json');
          if (!casesResponse.ok) {
            throw new Error('Failed to load cases index');
          }
          State.casesIndex = await casesResponse.json();

          // Set initial case from URL or default
          const urlParams = new URLSearchParams(window.location.search);
          State.currentCase = urlParams.get('case') || 'base_case';

          // Update UI
          document.getElementById('caseSelect').value = State.currentCase;

          // Load initial data
          await loadDataForCase(State.currentCase);

          State.initialized = true;
        } catch (error) {
          console.error('Failed to initialize app:', error);
          document.getElementById('contentArea').innerHTML = `
            <div style="text-align: center; padding: 50px; color: var(--danger);">
              <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
              <h2>Failed to Load Data</h2>
              <p>${error.message}</p>
              <p style="margin-top: 20px; color: #666;">
                Make sure you have run the analysis scripts to generate the data files.
              </p>
            </div>
          `;
        }
      }

      // Load data for a specific case
      async function loadDataForCase(caseName) {
        try {
          // Show loading
          document.getElementById('contentArea').innerHTML = `
            <div class="loading">
              <div class="loading-spinner"></div>
              <p>Loading sensitivity analysis for ${caseName}...</p>
            </div>
          `;

          // Load sensitivity data
          const sensitivityResponse = await fetch(`data/${caseName}_sensitivity_ncf.json`);
          if (!sensitivityResponse.ok) {
            throw new Error(`Failed to load sensitivity data for ${caseName}`);
          }
          const sensitivityData = await sensitivityResponse.json();
          State.data[caseName] = { sensitivity_ncf: sensitivityData };

          // Render the sensitivity analysis
          ChartRenderer.renderSensitivityNCF(sensitivityData);

        } catch (error) {
          console.error('Failed to load data:', error);
          document.getElementById('contentArea').innerHTML = `
            <div style="text-align: center; padding: 50px; color: var(--danger);">
              <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
              <h2>Failed to Load Data</h2>
              <p>${error.message}</p>
            </div>
          `;
        }
      }

      // Chart renderer for sensitivity analysis
      const ChartRenderer = {
        formatValue(value, parameter) {
          // Handle percentage-based parameters
          if (
            parameter.includes("Rate") ||
            parameter.includes("LTV") ||
            parameter.includes("Fee") ||
            parameter.includes("Occupancy")
          ) {
            return (value * 100).toFixed(2) + "%";
          }
          // Handle currency values
          else if (parameter.includes("Price") || parameter.includes("Cost")) {
            return (
              "CHF " +
              value.toLocaleString("en-US", { maximumFractionDigits: 0 })
            );
          }
          // Handle nights/days
          else if (parameter.includes("Stay")) {
            return value.toFixed(1) + " nights";
          }
          // Default: 2 decimal places
          else {
            return value.toFixed(2);
          }
        },

        renderSensitivityNCF(data) {
          const content = document.getElementById("contentArea");
          const sensitivities = data.sensitivities || [];
          const baseNCF = data.base_ncf || 0;

          // Parameter info for NCF sensitivity
          const parameterInfo = {
            "Purchase Price": {
              range: "CHF 1.275M to 1.725M (¬±15%)",
              rationale:
                "Higher purchase price means more debt and higher mortgage payments, directly reducing monthly cash flow. Negotiating down CHF 50k = CHF 8/month savings per owner.",
            },
            "Interest Rate": {
              range: "0.3% to 2.3% (¬±1%)",
              rationale:
                "Interest rate directly affects mortgage payments. With leverage, even 0.5% difference matters significantly for monthly cash flow.",
            },
            "Amortization Rate": {
              range: "0% (interest-only) to 2%",
              rationale:
                "Amortization directly reduces cash flow. Interest-only (0%) maximizes cash flow but keeps debt higher. 2% amortization improves equity but hurts cash flow.",
            },
            "Maintenance Reserve Rate": {
              range: "0% to 1% of property value",
              rationale:
                "Maintenance reserve is a large annual expense. Going from 1% to 0% saves CHF 13,000/year = CHF 3,250 per owner. But may defer needed work.",
            },
            "Average Daily Rate": {
              range: "CHF 160 to 240 (¬±20%)",
              rationale:
                "Pricing strategy directly impacts revenue and thus cash flow. 20% rate increase can turn negative into positive cash flow.",
            },
            "Occupancy Rate": {
              range: "56.7% to 69.3% (¬±10%)",
              rationale:
                "Higher occupancy = more revenue = better cash flow. Every 1% occupancy increase adds ~CHF 700 revenue/month.",
            },
            "Property Management Fee": {
              range: "15% to 25% (¬±5%)",
              rationale:
                "Management fees are % of revenue. Lower fees = better cash flow. Negotiating from 20% to 18% saves CHF 1,400/year.",
            },
            "Cleaning Cost per Stay": {
              range: "CHF 49 to 91 (¬±30%)",
              rationale:
                "With ~130 turnovers/year, cleaning is a major expense. Negotiating from CHF 80 to CHF 60 saves CHF 2,600/year.",
            },
            "Average Length of Stay": {
              range: "1.19 to 2.21 nights (¬±30%)",
              rationale:
                "Longer stays = fewer turnovers = lower cleaning costs = better cash flow. Encouraging 3+ night stays can meaningfully improve cash flow.",
            },
            "Insurance Rate": {
              range: "0.3% to 0.5% of property value",
              rationale:
                "Annual insurance costs. Lower rates = better cash flow. Shopping around can save CHF 1,300-2,600 annually.",
            },
            "Winter Season Occupancy": {
              range: "63.75% to 86.25% (¬±15%)",
              rationale:
                "Premium ski season. Higher winter occupancy = more high-rate revenue. Winter marketing is crucial for cash flow.",
            },
            "Inflation Rate": {
              range: "0.5% to 1.5% (¬±0.5%)",
              rationale:
                "Inflation affects future revenue growth. Higher inflation increases future rents but also future costs. Net effect on monthly cash flow is relatively neutral.",
            },
            "Revenue Growth Rate": {
              range: "1.2% to 3.8% (¬±1%)",
              rationale:
                "Annual revenue growth affects future income. But since we focus on first-year monthly cash flow, this has minimal impact on our analysis.",
            },
            "Initial Investment": {
              range: "CHF 950K to 1.15M (¬±10%)",
              rationale:
                "Higher initial investment requires more equity. But since we analyze cash flow per owner, this affects the denominator rather than numerator.",
            },
            "Annual Revenue": {
              range: "CHF 345K to 555K (¬±15%)",
              rationale:
                "Base revenue directly affects cash flow. Higher revenue = better cash flow. Marketing and pricing strategy are key drivers.",
            },
            "Operating Costs": {
              range: "CHF 225K to 375K (¬±15%)",
              rationale:
                "Operating costs directly reduce cash flow. Lower costs = better cash flow. Negotiation and efficiency improvements are crucial.",
            },
          };

          let html = `
            <div class="section">
              <h2 class="section-title">üéØ Sensitivity Analysis - Monthly Net Cash Flow per Owner</h2>

              <!-- Info Box -->
              <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 14px 18px; border-radius: 8px; margin-bottom: 20px;">
                <p style="margin: 0; font-size: 0.85em; line-height: 1.5; opacity: 0.95;">
                  üí° <strong>Monthly Net Cash Flow (NCF) Sensitivity</strong> ‚Äî How your monthly cash contribution per owner changes with parameter variations. This is the most practical metric for investment viability. Hover for details.
                </p>
              </div>

              <!-- Summary KPIs -->
              <div class="kpi-grid">
                <div class="kpi-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white;" data-tooltip="Base case Monthly Net Cash Flow per owner before any parameter variations. This is your expected monthly contribution to keep the investment running.">
                  <h3 style="color: rgba(255,255,255,0.9);">Base Monthly NCF</h3>
                  <div class="value" style="color: white; font-size: 1.6em;">CHF ${baseNCF.toFixed(0)}/month</div>
                  <div class="unit" style="color: rgba(255,255,255,0.8);">per owner</div>
                </div>
                <div class="kpi-card" data-tooltip="Number of parameters tested in this sensitivity analysis. Each parameter is varied to see its impact on monthly cash flow per owner.">
                  <h3>Parameters Tested</h3>
                  <div class="value" style="color: var(--info); font-size: 1.6em;">${sensitivities.length}</div>
                </div>
                <div class="kpi-card" data-tooltip="The parameter with the largest impact on monthly cash flow. Shows how much monthly cash flow changes when this parameter varies.">
                  <h3>Top Impact Parameter</h3>
                  <div class="value" style="color: var(--warning); font-size: 1.4em;">¬±${(sensitivities[0]?.impact || 0).toFixed(1)}%</div>
                  <div class="unit">${sensitivities[0]?.parameter || "N/A"}</div>
                </div>
                <div class="kpi-card" data-tooltip="The full range of monthly cash flow per owner across all parameter variations. Shows best-case and worst-case monthly contributions.">
                  <h3>Cash Flow Range</h3>
                  <div class="value" style="font-size: 1.2em;">
                    CHF ${Math.min(...sensitivities.map((s) => Math.min(s.low.irr, s.high.irr))).toFixed(0)}<br>
                    to<br>
                    CHF ${Math.max(...sensitivities.map((s) => Math.max(s.low.irr, s.high.irr))).toFixed(0)}
                  </div>
                  <div class="unit">per owner/month</div>
                </div>
              </div>

              <!-- Tornado Chart -->
              <div class="chart-container">
                <h3><i class="fas fa-chart-bar"></i> Tornado Chart - Parameter Impact on Monthly Cash Flow</h3>
                <p style="color: #7f8c8d; margin-bottom: 15px; font-size: 0.85em; line-height: 1.5;">
                  <span style="color: #2ecc71;">‚ñ†</span> Green = better cash flow (lower monthly contribution) |
                  <span style="color: #e74c3c;">‚ñ†</span> Red = worse cash flow (higher monthly contribution) |
                  Hover for details
                </p>
                <div class="chart-wrapper" id="tornadoChart"></div>
              </div>

              <!-- Insights Panel -->
              <div style="background: #f8f9fa; border-left: 5px solid #667eea; padding: 25px; border-radius: 8px; margin-bottom: 25px;">
                <h3 style="margin-top: 0; color: var(--primary); font-size: 1.2em;">üîç Key Cash Flow Insights</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 15px;">
                  ${sensitivities.slice(0, 3).map((sens, i) => {
                    const info = parameterInfo[sens.parameter] || { rationale: "No description available." };
                    const isPositiveImpact = sens.high.irr > sens.low.irr;
                    return `
                      <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
                        <div style="font-size: 1.8em; margin-bottom: 8px;">${i + 1}Ô∏è‚É£</div>
                        <div style="font-weight: 600; color: var(--secondary); margin-bottom: 8px;">${sens.parameter}</div>
                        <div style="font-size: 0.9em; color: #666; line-height: 1.5;">
                          <strong>Impact:</strong> ¬±${sens.impact.toFixed(1)}%<br>
                          <strong>Monthly Range:</strong> CHF ${Math.min(sens.low.irr, sens.high.irr).toFixed(0)} to CHF ${Math.max(sens.low.irr, sens.high.irr).toFixed(0)}<br>
                          <strong style="color: ${isPositiveImpact ? "#2ecc71" : "#e74c3c"};">
                            ${isPositiveImpact ? "‚Üë Higher values improve cash flow" : "‚Üì Higher values reduce cash flow"}
                          </strong>
                        </div>
                      </div>
                    `;
                  }).join("")}
                </div>
              </div>

              <!-- Parameter Details Table -->
              <div class="data-table">
                <h3><i class="fas fa-table"></i> Detailed Parameter Analysis</h3>
                <table>
                  <thead>
                    <tr>
                      <th>Parameter</th>
                      <th>Base Value</th>
                      <th>Low Scenario</th>
                      <th>High Scenario</th>
                      <th>Cash Flow Impact</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${sensitivities.map((sens, index) => {
                      const info = parameterInfo[sens.parameter] || {};
                      const hasImpact = Math.abs(sens.impact) > 0.1;
                      const lowBetter = sens.low.irr > baseNCF;
                      const highBetter = sens.high.irr > baseNCF;
                      const lowBgColor = lowBetter ? "#f0fdf4" : "#fff5f5";
                      const lowTextColor = lowBetter ? "#2ecc71" : "#e74c3c";
                      const highBgColor = highBetter ? "#f0fdf4" : "#fff5f5";
                      const highTextColor = highBetter ? "#2ecc71" : "#e74c3c";

                      return `
                        <tr style="border-bottom: 1px solid #f0f0f0; ${index < 3 ? "background: #fffbf0;" : ""} ${!hasImpact ? "opacity: 0.5;" : ""}">
                          <td style="padding: 15px;">
                            <div style="font-weight: 600; color: var(--primary);">
                              ${sens.parameter}
                            </div>
                            ${!hasImpact ? '<small style="color: #999;">(Minimal monthly impact)</small>' : ""}
                          </td>
                          <td style="text-align: center; padding: 15px;">
                            <strong>${this.formatValue(sens.base_value, sens.parameter)}</strong>
                          </td>
                          <td style="text-align: center; padding: 15px; background: ${lowBgColor};">
                            ${this.formatValue(sens.low.value, sens.parameter)}<br>
                            <span style="color: ${lowTextColor}; font-weight: bold; font-size: 1.1em;">CHF ${sens.low.irr.toFixed(0)}</span><br>
                            <small style="color: #999;">(${sens.low.delta_irr >= 0 ? "+" : ""}CHF ${sens.low.delta_irr.toFixed(0)})</small>
                          </td>
                          <td style="text-align: center; padding: 15px; background: ${highBgColor};">
                            ${this.formatValue(sens.high.value, sens.parameter)}<br>
                            <span style="color: ${highTextColor}; font-weight: bold; font-size: 1.1em;">CHF ${sens.high.irr.toFixed(0)}</span><br>
                            <small style="color: #999;">(${sens.high.delta_irr >= 0 ? "+" : ""}CHF ${sens.high.delta_irr.toFixed(0)})</small>
                          </td>
                          <td style="text-align: center; padding: 15px;">
                            <div style="background: ${index < 3 ? "#667eea" : "#e9ecef"}; color: ${index < 3 ? "white" : "#666"}; padding: 6px 12px; border-radius: 20px; display: inline-block; font-weight: bold;">
                              ¬±${sens.impact.toFixed(1)}%
                            </div>
                          </td>
                        </tr>
                      `;
                    }).join("")}
                  </tbody>
                </table>
              </div>
            </div>
          `;

          content.innerHTML = html;

          // Create tornado chart
          if (sensitivities.length > 0) {
            const parameters = [];
            const lowValues = [];
            const highValues = [];
            const customData = [];

            sensitivities.forEach((sens) => {
              parameters.push(sens.parameter);
              lowValues.push(sens.low.irr - baseNCF);
              highValues.push(sens.high.irr - baseNCF);

              const info = parameterInfo[sens.parameter] || {
                range: "Variable",
                rationale: "No description available."
              };
              customData.push({
                param: sens.parameter,
                baseValue: sens.base_value,
                lowValue: sens.low.value,
                lowNCF: sens.low.irr,
                highValue: sens.high.value,
                highNCF: sens.high.irr,
                impact: sens.impact,
                range: info.range,
                rationale: info.rationale,
              });
            });

            // Dynamic colors for bars
            const lowColors = lowValues.map((delta, i) => {
              const lowNCF = customData[i].lowNCF;
              return lowNCF > baseNCF ? "#2ecc71" : "#e74c3c";
            });

            const highColors = highValues.map((delta, i) => {
              const highNCF = customData[i].highNCF;
              return highNCF > baseNCF ? "#2ecc71" : "#e74c3c";
            });

            const traceLow = {
              y: parameters,
              x: lowValues,
              name: "Low Value Scenario",
              type: "bar",
              orientation: "h",
              marker: {
                color: lowColors,
                line: { color: "#c0392b", width: 1 },
              },
              customdata: customData,
              hovertemplate:
                "<b>%{customdata.param}</b><br><br>" +
                "<b>üìâ Low Value Scenario:</b><br>" +
                "Parameter: %{customdata.lowValue}<br>" +
                "Monthly Cash Flow: CHF %{customdata.lowNCF:.0f}<br>" +
                "Change from Base: CHF %{x:+.0f}<br>" +
                "<br><b>üìä Tested Range:</b> %{customdata.range}<br>" +
                "<br><b>üí° Why This Matters:</b><br>%{customdata.rationale}" +
                "<extra></extra>",
              hoverlabel: {
                bgcolor: "rgba(44, 62, 80, 0.95)",
                font: { size: 13, color: "white", family: "Segoe UI, Arial" },
                bordercolor: "#2c3e50",
                namelength: -1,
                align: "left",
              },
            };

            const traceHigh = {
              y: parameters,
              x: highValues,
              name: "High Value Scenario",
              type: "bar",
              orientation: "h",
              marker: {
                color: highColors,
                line: { color: "#27ae60", width: 1 },
              },
              customdata: customData,
              hovertemplate:
                "<b>%{customdata.param}</b><br><br>" +
                "<b>üìà High Value Scenario:</b><br>" +
                "Parameter: %{customdata.highValue}<br>" +
                "Monthly Cash Flow: CHF %{customdata.highNCF:.0f}<br>" +
                "Change from Base: CHF %{x:+.0f}<br>" +
                "<br><b>üìä Tested Range:</b> %{customdata.range}<br>" +
                "<br><b>üí° Why This Matters:</b><br>%{customdata.rationale}" +
                "<extra></extra>",
              hoverlabel: {
                bgcolor: "rgba(44, 62, 80, 0.95)",
                font: { size: 13, color: "white", family: "Segoe UI, Arial" },
                bordercolor: "#2c3e50",
                namelength: -1,
                align: "left",
              },
            };

            const layout = {
              barmode: "overlay",
              hovermode: "closest",
              xaxis: {
                title: {
                  text: "Change in Monthly Cash Flow (CHF)",
                  font: { size: 13, color: "#2c3e50", family: "Segoe UI" },
                  standoff: 10,
                },
                zeroline: true,
                zerolinewidth: 2,
                zerolinecolor: "#667eea",
                gridcolor: "#e8ecef",
                tickfont: { size: 11, color: "#5a6c7d" },
              },
              yaxis: {
                title: "",
                autorange: "reversed",
                tickfont: { size: 11, color: "#2c3e50", family: "Segoe UI" },
              },
              showlegend: true,
              legend: {
                orientation: "h",
                x: 0.5,
                xanchor: "center",
                y: 1.08,
                bgcolor: "rgba(255,255,255,0.9)",
                bordercolor: "#ddd",
                borderwidth: 1,
                font: { size: 11, color: "#2c3e50" },
              },
              margin: { l: 200, r: 30, t: 50, b: 60 },
              height: Math.max(420, 300 + sensitivities.length * 40),
              paper_bgcolor: "#ffffff",
              plot_bgcolor: "#fafbfc",
              font: { family: "Segoe UI, Arial", size: 11, color: "#2c3e50" },
              annotations: [
                {
                  text: `<b>Base Cash Flow:</b> CHF ${baseNCF.toFixed(0)}/month`,
                  xref: "paper",
                  yref: "paper",
                  x: 0.01,
                  y: 0.99,
                  xanchor: "left",
                  yanchor: "top",
                  showarrow: false,
                  font: { size: 11, color: "#667eea" },
                  bgcolor: "rgba(255,255,255,0.9)",
                  bordercolor: "#667eea",
                  borderwidth: 1,
                  borderpad: 4,
                },
              ],
            };

            Plotly.newPlot("tornadoChart", [traceLow, traceHigh], layout, {
              responsive: true,
              displayModeBar: true,
              modeBarButtonsToRemove: ["lasso2d", "select2d"],
              displaylogo: false,
            });
          }
        }
      };

      // Event listeners
      document.getElementById('caseSelect').addEventListener('change', async (e) => {
        const newCase = e.target.value;
        State.currentCase = newCase;

        // Update URL without page reload
        const url = new URL(window.location);
        url.searchParams.set('case', newCase);
        window.history.pushState({}, '', url);

        // Load data for new case
        await loadDataForCase(newCase);
      });

      // Initialize the application
      initializeApp();
    </script>
  </body>
</html>
