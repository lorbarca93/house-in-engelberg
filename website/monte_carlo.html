<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Engelberg Property Investment - Monte Carlo Analysis</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary: #1a1a2e;
        --secondary: #0f3460;
        --accent: #667eea;
        --success: #28a745;
        --danger: #dc3545;
        --warning: #ffc107;
        --info: #17a2b8;
        --light: #f8f9fa;
        --dark: #2c3e50;
        --border: #dee2e6;
        --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        --sidebar-width: 250px;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto",
          "Helvetica Neue", Arial, sans-serif;
        background: #f5f6fa;
        color: var(--dark);
        line-height: 1.5;
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
      }

      /* Top Navigation Bar */
      .top-bar {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        color: white;
        padding: 12px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: var(--shadow);
        z-index: 1000;
      }

      .top-bar h1 {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
      }

      .case-selector {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .case-selector label {
        font-weight: 500;
        font-size: 0.9rem;
      }

      .case-selector select {
        padding: 6px 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        font-size: 0.9rem;
        min-width: 200px;
      }

      .case-selector select option {
        background: var(--primary);
        color: white;
      }

      /* Main Layout */
      .main-layout {
        display: flex;
        flex: 1;
        overflow: hidden;
      }

      /* Sidebar */
      .sidebar {
        width: var(--sidebar-width);
        background: white;
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        box-shadow: var(--shadow);
      }

      .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid var(--border);
        background: var(--light);
        font-weight: 600;
        color: var(--primary);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .sidebar-menu {
        list-style: none;
        padding: 10px 0;
      }

      .sidebar-menu-item {
        padding: 12px 20px;
        cursor: pointer;
        transition: all 0.2s ease;
        border-left: 4px solid transparent;
        display: flex;
        align-items: center;
        gap: 10px;
        text-decoration: none;
        color: var(--dark);
      }

      .sidebar-menu-item:hover {
        background: var(--light);
        border-left-color: var(--accent);
      }

      .sidebar-menu-item.active {
        background: rgba(102, 126, 234, 0.1);
        border-left-color: var(--accent);
      }

      .sidebar-menu-item i {
        width: 20px;
        text-align: center;
      }

      /* Main Content Area */
      .content-area {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f5f6fa;
      }

      /* Loading State */
      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 60vh;
        flex-direction: column;
        gap: 20px;
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--border);
        border-top: 4px solid var(--accent);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* KPI Cards */
      .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 20px;
      }

      .kpi-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: var(--shadow);
        border-left: 4px solid var(--accent);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      }

      .kpi-card h3 {
        font-size: 0.85rem;
        color: #7f8c8d;
        margin-bottom: 8px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .kpi-card .value {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 4px;
      }

      .kpi-card .value.positive {
        color: var(--success);
      }

      .kpi-card .value.negative {
        color: var(--danger);
      }

      .kpi-card .unit {
        font-size: 0.8rem;
        color: #95a5a6;
        font-weight: 500;
      }

      /* Chart Containers */
      .chart-container {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: var(--shadow);
      }

      .chart-container h3 {
        margin-bottom: 20px;
        color: var(--primary);
        font-size: 1.2rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .chart-wrapper {
        min-height: 400px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: white;
      }

      /* Statistics Table */
      .stats-table {
        background: white;
        border-radius: 12px;
        margin-bottom: 25px;
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      .stats-table h3 {
        padding: 20px;
        margin: 0;
        border-bottom: 2px solid var(--border);
        background: #f8f9fa;
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--primary);
      }

      .stats-table table {
        width: 100%;
        border-collapse: collapse;
      }

      .stats-table th,
      .stats-table td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid var(--border);
      }

      .stats-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: var(--primary);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .stats-table tbody tr:hover {
        background: #f8f9fa;
      }

      /* Section Styling */
      .section {
        margin-bottom: 30px;
      }

      .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      /* Tooltip Styling */
      .kpi-card[data-tooltip]:hover::before {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: var(--dark);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.8rem;
        white-space: nowrap;
        z-index: 1000;
        opacity: 0.95;
        box-shadow: var(--shadow);
      }

      .kpi-card[data-tooltip]:hover::after {
        content: "";
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 5px solid transparent;
        border-top-color: var(--dark);
        margin-bottom: -5px;
        z-index: 1000;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .sidebar {
          width: 200px;
        }

        .kpi-grid {
          grid-template-columns: 1fr;
        }

        .top-bar h1 {
          font-size: 1.2rem;
        }

        .case-selector select {
          min-width: 150px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Top Navigation Bar -->
    <div class="top-bar">
      <h1><i class="fas fa-chart-line"></i> Engelberg Property Investment</h1>
      <div class="case-selector">
        <label for="caseSelect">Case:</label>
        <select id="caseSelect">
          <option value="base_case">Base Case</option>
          <option value="3_owners">3 Owners</option>
          <option value="4_owners">4 Owners</option>
          <option value="5_owners">5 Owners</option>
          <option value="900k_house">900K House Price</option>
          <option value="90day_restriction">90-Day Airbnb Restriction</option>
          <option value="climate_risk">Climate Risk Scenario</option>
          <option value="early_exit">Early Exit (Poor Performance)</option>
          <option value="interest_rate_spike">Interest Rate Spike</option>
          <option value="migros">Migros Scenario</option>
          <option value="saron_mortgage">SARON Mortgage</option>
        </select>
      </div>
    </div>

    <!-- Main Layout -->
    <div class="main-layout">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-header">
          <i class="fas fa-list"></i> Analysis Types
        </div>
        <ul class="sidebar-menu" id="analysisMenu">
          <li class="sidebar-menu-item">
            <a href="index.html" style="display: flex; align-items: center; gap: 10px; text-decoration: none; color: inherit; width: 100%;">
              <i class="fas fa-home"></i> Simulation KPIs
            </a>
          </li>
          <li class="sidebar-menu-item">
            <a href="sensitivity.html" style="display: flex; align-items: center; gap: 10px; text-decoration: none; color: inherit; width: 100%;">
              <i class="fas fa-sliders-h"></i> Sensitivity - Monthly NCF
            </a>
          </li>
          <li class="sidebar-menu-item active">
            <a href="monte_carlo.html" style="display: flex; align-items: center; gap: 10px; text-decoration: none; color: inherit; width: 100%;">
              <i class="fas fa-dice"></i> Monte Carlo
            </a>
          </li>
        </ul>
      </div>

      <!-- Main Content Area -->
      <div class="content-area" id="contentArea">
        <div class="loading">
          <div class="loading-spinner"></div>
          <p>Loading Monte Carlo analysis...</p>
        </div>
      </div>
    </div>

    <script>
      // State management
      const State = {
        currentCase: 'base_case',
        data: {},
        initialized: false
      };

      // Initialize the application
      async function initializeApp() {
        try {
          // Load cases index
          const casesResponse = await fetch('data/cases_index.json');
          if (!casesResponse.ok) {
            throw new Error('Failed to load cases index');
          }
          State.casesIndex = await casesResponse.json();

          // Set initial case from URL or default
          const urlParams = new URLSearchParams(window.location.search);
          State.currentCase = urlParams.get('case') || 'base_case';

          // Update UI
          document.getElementById('caseSelect').value = State.currentCase;

          // Load initial data
          await loadDataForCase(State.currentCase);

          State.initialized = true;
        } catch (error) {
          console.error('Failed to initialize app:', error);
          document.getElementById('contentArea').innerHTML = `
            <div style="text-align: center; padding: 50px; color: var(--danger);">
              <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
              <h2>Failed to Load Data</h2>
              <p>${error.message}</p>
              <p style="margin-top: 20px; color: #666;">
                Make sure you have run the analysis scripts to generate the data files.
              </p>
            </div>
          `;
        }
      }

      // Load data for a specific case
      async function loadDataForCase(caseName) {
        try {
          // Show loading
          document.getElementById('contentArea').innerHTML = `
            <div class="loading">
              <div class="loading-spinner"></div>
              <p>Loading Monte Carlo analysis for ${caseName}...</p>
            </div>
          `;

          // Load Monte Carlo data
          const monteCarloResponse = await fetch(`data/${caseName}_monte_carlo.json`);
          if (!monteCarloResponse.ok) {
            throw new Error(`Failed to load Monte Carlo data for ${caseName}`);
          }
          const monteCarloData = await monteCarloResponse.json();
          State.data[caseName] = { monte_carlo: monteCarloData };

          // Render the Monte Carlo analysis
          ChartRenderer.renderMonteCarlo(monteCarloData);

        } catch (error) {
          console.error('Failed to load data:', error);
          document.getElementById('contentArea').innerHTML = `
            <div style="text-align: center; padding: 50px; color: var(--danger);">
              <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
              <h2>Failed to Load Data</h2>
              <p>${error.message}</p>
            </div>
          `;
        }
      }

      // Chart renderer for Monte Carlo analysis
      const ChartRenderer = {
        renderMonteCarlo(data) {
          const content = document.getElementById("contentArea");
          const stats = data.statistics || {};
          const sampleData = data.sample_data || [];

          let html = `
            <div class="section">
              <h2 class="section-title">ðŸŽ² Monte Carlo Simulation Analysis</h2>

              <!-- Info Box -->
              <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 14px 18px; border-radius: 8px; margin-bottom: 20px;">
                <p style="margin: 0; font-size: 0.85em; line-height: 1.5; opacity: 0.95;">
                  ðŸ’¡ <strong>Monte Carlo Analysis</strong> â€” ${data.total_simulations || 2000} probabilistic simulations showing NPV distribution and risk metrics. Accounts for parameter uncertainty and correlations.
                </p>
              </div>

              <!-- Key Risk Metrics -->
              <div class="kpi-grid">
                <div class="kpi-card" data-tooltip="Average Net Present Value across all ${data.total_simulations || 2000} simulations. This is the expected NPV considering all parameter uncertainties.">
                  <h3>Mean NPV</h3>
                  <div class="value ${stats.npv?.mean >= 0 ? 'positive' : 'negative'}">$${Math.round(stats.npv?.mean || 0).toLocaleString()}</div>
                </div>
                <div class="kpi-card" data-tooltip="Median (50th percentile) Net Present Value. Half of simulations are above this value, half are below. More robust than mean as it's less affected by extreme outliers.">
                  <h3>Median NPV</h3>
                  <div class="value ${stats.npv?.median >= 0 ? 'positive' : 'negative'}">$${Math.round(stats.npv?.median || 0).toLocaleString()}</div>
                </div>
                <div class="kpi-card" data-tooltip="Percentage of Monte Carlo simulations where NPV is positive. Shows the probability that the investment will exceed the required return. Higher percentage = lower risk of underperformance.">
                  <h3>Probability NPV > 0</h3>
                  <div class="value" style="color: var(--info);">${((stats.npv?.positive_prob || 0) * 100).toFixed(1)}%</div>
                </div>
                <div class="kpi-card" data-tooltip="Standard deviation of NPV across all simulations. Measures the volatility of potential outcomes. Higher values indicate greater risk.">
                  <h3>NPV Volatility</h3>
                  <div class="value">$${Math.round(stats.npv?.std || 0).toLocaleString()}</div>
                  <div class="unit">standard deviation</div>
                </div>
              </div>

              <!-- Distribution Chart -->
              <div class="chart-container">
                <h3><i class="fas fa-chart-area"></i> NPV Distribution</h3>
                <p style="color: #7f8c8d; margin-bottom: 15px; font-size: 0.85em; line-height: 1.5;">
                  Distribution of Net Present Value across ${data.total_simulations || 2000} Monte Carlo simulations.
                  <span style="color: #2ecc71;">â– </span> Green lines show key percentiles.
                </p>
                <div class="chart-wrapper" id="npvChart"></div>
              </div>

              <!-- Risk Metrics Table -->
              <div class="stats-table">
                <h3><i class="fas fa-table"></i> Risk Metrics Summary</h3>
                <table>
                  <thead>
                    <tr>
                      <th>Metric</th>
                      <th>Value</th>
                      <th>Description</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td><strong>Mean NPV</strong></td>
                      <td>$${Math.round(stats.npv?.mean || 0).toLocaleString()}</td>
                      <td>Average Net Present Value across all simulations</td>
                    </tr>
                    <tr>
                      <td><strong>Median NPV</strong></td>
                      <td>$${Math.round(stats.npv?.median || 0).toLocaleString()}</td>
                      <td>50th percentile - half simulations above, half below</td>
                    </tr>
                    <tr>
                      <td><strong>Standard Deviation</strong></td>
                      <td>$${Math.round(stats.npv?.std || 0).toLocaleString()}</td>
                      <td>Measure of outcome variability (risk)</td>
                    </tr>
                    <tr>
                      <td><strong>P5 (Worst 5%)</strong></td>
                      <td>$${Math.round(stats.npv?.p5 || 0).toLocaleString()}</td>
                      <td>5th percentile - only 5% of outcomes are worse</td>
                    </tr>
                    <tr>
                      <td><strong>P95 (Best 5%)</strong></td>
                      <td>$${Math.round(stats.npv?.p95 || 0).toLocaleString()}</td>
                      <td>95th percentile - only 5% of outcomes are better</td>
                    </tr>
                    <tr>
                      <td><strong>Probability NPV > 0</strong></td>
                      <td>${((stats.npv?.positive_prob || 0) * 100).toFixed(1)}%</td>
                      <td>Chance of positive return (beating discount rate)</td>
                    </tr>
                    <tr>
                      <td><strong>Skewness</strong></td>
                      <td>${(stats.npv?.skewness || 0).toFixed(2)}</td>
                      <td>Distribution asymmetry (negative = long left tail)</td>
                    </tr>
                    <tr>
                      <td><strong>Range (Max - Min)</strong></td>
                      <td>$${Math.round((stats.npv?.max || 0) - (stats.npv?.min || 0)).toLocaleString()}</td>
                      <td>Total spread from best to worst outcome</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Cumulative Distribution -->
              <div class="chart-container">
                <h3><i class="fas fa-chart-line"></i> Cumulative Distribution Function</h3>
                <p style="color: #7f8c8d; margin-bottom: 15px; font-size: 0.85em; line-height: 1.5;">
                  Shows the probability that NPV will be less than or equal to a given value.
                  <span style="color: #e74c3c;">â– </span> Red line marks P(NPV < 0) = ${((1 - (stats.npv?.positive_prob || 0)) * 100).toFixed(1)}%
                </p>
                <div class="chart-wrapper" id="cdfChart"></div>
              </div>

              <!-- Risk Assessment -->
              <div style="background: #f8f9fa; border-left: 5px solid #f5576c; padding: 25px; border-radius: 8px; margin-bottom: 25px;">
                <h3 style="margin-top: 0; color: #f5576c; font-size: 1.2em;">ðŸŽ¯ Risk Assessment</h3>
                <div style="margin-top: 15px;">
                  ${(() => {
                    const probPositive = (stats.npv?.positive_prob || 0) * 100;
                    const std = stats.npv?.std || 0;
                    const mean = stats.npv?.mean || 0;

                    let riskLevel, riskColor, assessment;
                    if (probPositive > 80 && std < Math.abs(mean) * 0.5) {
                      riskLevel = "LOW RISK";
                      riskColor = "#28a745";
                      assessment = "High probability of success with low variability. Investment appears robust.";
                    } else if (probPositive > 60 && std < Math.abs(mean)) {
                      riskLevel = "MODERATE RISK";
                      riskColor = "#ffc107";
                      assessment = "Reasonable chance of success but with notable uncertainty. Further analysis recommended.";
                    } else {
                      riskLevel = "HIGH RISK";
                      riskColor = "#dc3545";
                      assessment = "Low probability of success or high variability. Significant downside risk identified.";
                    }

                    return `
                      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
                          <div style="font-size: 1.5em; margin-bottom: 10px;">ðŸ“Š</div>
                          <div style="font-weight: 600; margin-bottom: 8px;">Overall Risk Level</div>
                          <div style="font-size: 1.3em; font-weight: bold; color: ${riskColor};">${riskLevel}</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
                          <div style="font-size: 1.5em; margin-bottom: 10px;">ðŸŽ²</div>
                          <div style="font-weight: 600; margin-bottom: 8px;">Key Statistics</div>
                          <div style="font-size: 0.9em; line-height: 1.5;">
                            â€¢ Success Rate: ${probPositive.toFixed(1)}%<br>
                            â€¢ Expected NPV: $${Math.round(mean).toLocaleString()}<br>
                            â€¢ Worst Case (P5): $${Math.round(stats.npv?.p5 || 0).toLocaleString()}
                          </div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
                          <div style="font-size: 1.5em; margin-bottom: 10px;">ðŸ’¡</div>
                          <div style="font-weight: 600; margin-bottom: 8px;">Assessment</div>
                          <div style="font-size: 0.9em; line-height: 1.5; color: #666;">
                            ${assessment}
                          </div>
                        </div>
                      </div>
                    `;
                  })()}
                </div>
              </div>
            </div>
          `;

          content.innerHTML = html;

          // Render charts if sample data available
          if (sampleData.length > 0) {
            this.renderNPVDistribution(sampleData, stats);
            this.renderCDF(sampleData, stats);
          }
        },

        renderNPVDistribution(sampleData, stats) {
          // Prepare data for histogram
          const npvValues = sampleData.map((d) => d.npv || 0).filter((v) => !isNaN(v));

          // Create histogram with density
          const traceHist = {
            x: npvValues,
            type: 'histogram',
            nbinsx: 50,
            name: 'NPV Distribution',
            opacity: 0.7,
            marker: {
              color: 'skyblue',
              line: { color: 'black', width: 1 }
            },
            histnorm: 'probability density'
          };

          // Add density curve
          const density = this.kernelDensityEstimate(npvValues, 100);
          const traceDensity = {
            x: density.x,
            y: density.y,
            type: 'scatter',
            mode: 'lines',
            name: 'Density',
            line: { color: 'red', width: 2 }
          };

          // Add vertical lines for key statistics
          const verticalLines = [
            {
              type: 'line',
              x0: stats.npv?.mean || 0,
              y0: 0,
              x1: stats.npv?.mean || 0,
              y1: Math.max(...density.y) * 1.1,
              line: { color: 'red', width: 2, dash: 'dash' },
              name: `Mean: $${Math.round(stats.npv?.mean || 0).toLocaleString()}`
            },
            {
              type: 'line',
              x0: stats.npv?.median || 0,
              y0: 0,
              x1: stats.npv?.median || 0,
              y1: Math.max(...density.y) * 1.1,
              line: { color: 'green', width: 2, dash: 'dash' },
              name: `Median: $${Math.round(stats.npv?.median || 0).toLocaleString()}`
            },
            {
              type: 'line',
              x0: stats.npv?.p5 || 0,
              y0: 0,
              x1: stats.npv?.p5 || 0,
              y1: Math.max(...density.y) * 1.1,
              line: { color: 'orange', width: 2, dash: 'dot' },
              name: `P5: $${Math.round(stats.npv?.p5 || 0).toLocaleString()}`
            },
            {
              type: 'line',
              x0: stats.npv?.p95 || 0,
              y0: 0,
              x1: stats.npv?.p95 || 0,
              y1: Math.max(...density.y) * 1.1,
              line: { color: 'purple', width: 2, dash: 'dot' },
              name: `P95: $${Math.round(stats.npv?.p95 || 0).toLocaleString()}`
            }
          ];

          const layout = {
            title: '',
            xaxis: {
              title: 'Net Present Value ($)',
              gridcolor: '#e8ecef'
            },
            yaxis: {
              title: 'Density',
              gridcolor: '#e8ecef'
            },
            showlegend: true,
            legend: { x: 0.8, y: 0.9 },
            shapes: verticalLines,
            paper_bgcolor: '#ffffff',
            plot_bgcolor: '#fafbfc',
            font: { family: 'Segoe UI, Arial', size: 11, color: '#2c3e50' },
            margin: { l: 60, r: 30, t: 20, b: 60 }
          };

          Plotly.newPlot('npvChart', [traceHist, traceDensity], layout, {
            responsive: true,
            displayModeBar: false
          });
        },

        renderCDF(sampleData, stats) {
          // Prepare data for CDF
          const npvValues = sampleData.map((d) => d.npv || 0).filter((v) => !isNaN(v));
          const sortedValues = npvValues.sort((a, b) => a - b);
          const yVals = Array.from({length: sortedValues.length}, (_, i) =>
            (i + 1) / sortedValues.length
          );

          const traceCDF = {
            x: sortedValues,
            y: yVals,
            type: 'scatter',
            mode: 'lines',
            name: 'CDF',
            line: { color: 'blue', width: 2 }
          };

          // Add line for P(NPV < 0)
          const probNegative = 1 - (stats.npv?.positive_prob || 0);
          const zeroIndex = sortedValues.findIndex(v => v >= 0);

          const layout = {
            title: '',
            xaxis: {
              title: 'Net Present Value ($)',
              gridcolor: '#e8ecef'
            },
            yaxis: {
              title: 'Cumulative Probability',
              gridcolor: '#e8ecef',
              range: [0, 1]
            },
            showlegend: false,
            paper_bgcolor: '#ffffff',
            plot_bgcolor: '#fafbfc',
            font: { family: 'Segoe UI, Arial', size: 11, color: '#2c3e50' },
            margin: { l: 60, r: 30, t: 20, b: 60 },
            shapes: probNegative > 0.01 ? [{
              type: 'line',
              x0: 0,
              y0: 0,
              x1: 0,
              y1: probNegative,
              line: { color: 'red', width: 2, dash: 'dash' }
            }, {
              type: 'line',
              x0: Math.min(...sortedValues) * 0.5,
              y0: probNegative,
              x1: 0,
              y1: probNegative,
              line: { color: 'red', width: 2, dash: 'dash' }
            }] : [],
            annotations: probNegative > 0.01 ? [{
              x: 0,
              y: probNegative,
              xref: 'x',
              yref: 'y',
              text: `P(NPV < 0) = ${(probNegative * 100).toFixed(1)}%`,
              showarrow: true,
              arrowhead: 2,
              arrowsize: 1,
              arrowwidth: 2,
              arrowcolor: 'red',
              ax: 40,
              ay: -30,
              bgcolor: 'rgba(255,255,255,0.9)',
              bordercolor: 'red',
              borderwidth: 1,
              borderpad: 4
            }] : []
          };

          Plotly.newPlot('cdfChart', [traceCDF], layout, {
            responsive: true,
            displayModeBar: false
          });
        },

        kernelDensityEstimate(data, nPoints = 100) {
          // Simple kernel density estimation
          const sortedData = data.sort((a, b) => a - b);
          const minVal = sortedData[0];
          const maxVal = sortedData[sortedData.length - 1];
          const bandwidth = (maxVal - minVal) / 20; // Simple bandwidth estimate

          const x = [];
          const y = [];

          for (let i = 0; i < nPoints; i++) {
            const xi = minVal + (maxVal - minVal) * i / (nPoints - 1);
            x.push(xi);

            let density = 0;
            for (const point of data) {
              const kernel = Math.exp(-0.5 * Math.pow((xi - point) / bandwidth, 2)) /
                           (bandwidth * Math.sqrt(2 * Math.PI));
              density += kernel;
            }
            y.push(density / data.length);
          }

          return { x, y };
        }
      };

      // Event listeners
      document.getElementById('caseSelect').addEventListener('change', async (e) => {
        const newCase = e.target.value;
        State.currentCase = newCase;

        // Update URL without page reload
        const url = new URL(window.location);
        url.searchParams.set('case', newCase);
        window.history.pushState({}, '', url);

        // Load data for new case
        await loadDataForCase(newCase);
      });

      // Initialize the application
      initializeApp();
    </script>
  </body>
</html>
