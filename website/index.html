<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Engelberg Property Investment - Dynamic Dashboard</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        /* Primary color palette */
        --primary: #1a1a2e;
        --secondary: #0f3460;
        --accent: #667eea;

        /* Semantic colors for consistent meaning */
        --color-positive: #28a745;
        --color-negative: #dc3545;
        --color-warning: #ffc107;
        --color-info: #17a2b8;
        --success: #28a745;
        --danger: #dc3545;
        --warning: #ffc107;
        --info: #17a2b8;

        /* Neutral palette */
        --gray-50: #f8f9fa;
        --gray-100: #e9ecef;
        --gray-200: #dee2e6;
        --gray-300: #ced4da;
        --gray-500: #6c757d;
        --gray-700: #495057;
        --gray-900: #212529;
        --light: #f8f9fa;
        --dark: #2c3e50;
        --border: #dee2e6;

        /* Spacing scale */
        --space-xs: 4px;
        --space-sm: 8px;
        --space-md: 16px;
        --space-lg: 24px;
        --space-xl: 32px;
        --space-2xl: 48px;

        /* Typography */
        --font-size-xs: 0.75rem;
        --font-size-sm: 0.875rem;
        --font-size-base: 1rem;
        --font-size-lg: 1.125rem;
        --font-size-xl: 1.25rem;
        --font-size-2xl: 1.5rem;
        --font-size-3xl: 2rem;

        /* Shadows */
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.15);
        --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);

        /* Border radius */
        --radius-sm: 4px;
        --radius-md: 8px;
        --radius-lg: 12px;
        --radius-xl: 16px;

        /* Layout */
        --sidebar-width: 250px;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto",
          "Helvetica Neue", Arial, sans-serif;
        background: #f5f6fa;
        color: var(--dark);
        line-height: 1.5;
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
      }

      /* Top Navigation Bar */
      .top-bar {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        color: white;
        padding: 15px 30px;
        box-shadow: var(--shadow);
        display: flex;
        align-items: center;
        justify-content: space-between;
        z-index: 1000;
      }

      .top-bar h1 {
        font-size: 1.5em;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .case-selector {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .case-selector label {
        font-weight: 600;
        margin-right: 10px;
      }

      .case-selector select {
        padding: 8px 15px;
        border-radius: 6px;
        border: none;
        background: white;
        color: var(--primary);
        font-size: 0.95em;
        cursor: pointer;
        min-width: 200px;
      }

      .case-selector select:focus {
        outline: 2px solid var(--accent);
      }

      /* Main Layout */
      .main-layout {
        display: flex;
        flex: 1;
        overflow: hidden;
      }

      /* Sidebar */
      .sidebar {
        width: var(--sidebar-width);
        background: white;
        border-right: 1px solid var(--border);
        overflow-y: auto;
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.05);
      }

      .sidebar-header {
        padding: 20px;
        background: var(--light);
        border-bottom: 1px solid var(--border);
        font-weight: 600;
        color: var(--primary);
      }

      .sidebar-menu {
        list-style: none;
        padding: 10px 0;
      }

      .sidebar-menu-item {
        padding: 12px 20px;
        cursor: pointer;
        transition: all 0.2s;
        border-left: 3px solid transparent;
      }

      .sidebar-menu-item:hover {
        background: var(--light);
        border-left-color: var(--accent);
      }

      .sidebar-menu-item.active {
        background: rgba(102, 126, 234, 0.1);
        border-left-color: var(--accent);
        font-weight: 600;
        color: var(--accent);
      }

      .sidebar-menu-item i {
        width: 20px;
        margin-right: 10px;
      }

      /* Main Content Area */
      .content-area {
        flex: 1;
        overflow-y: auto;
        padding: 30px;
        background: #f5f6fa;
      }

      .loading {
        text-align: center;
        padding: 60px 20px;
        color: #666;
      }

      .loading i {
        font-size: 3em;
        margin-bottom: 20px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .error {
        background: #fee;
        border: 1px solid var(--danger);
        color: var(--danger);
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
      }

      /* KPI Cards */
      .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: var(--space-md);
        margin-bottom: var(--space-lg);
      }

      .kpi-card {
        background: white;
        padding: 18px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border-left: 4px solid var(--accent);
        min-width: 140px;
        transition:
          transform 0.2s,
          box-shadow 0.2s;
      }

      .kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .kpi-card h3 {
        font-size: var(--font-size-sm);
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: var(--space-sm);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        line-height: 1.3;
      }

      .kpi-card .value {
        font-size: var(--font-size-2xl);
        font-weight: 700;
        color: var(--gray-900);
        line-height: 1.2;
      }

      .kpi-card .value.positive {
        color: var(--color-positive);
      }

      .kpi-card .value.negative {
        color: var(--color-negative);
      }

      /* Chart Container */
      .chart-container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 40px;
      }

      .chart-container h3 {
        margin-bottom: 20px;
        color: var(--primary);
        font-size: 1.3em;
        font-weight: 700;
        line-height: 1.4;
      }

      .chart-wrapper {
        width: 100%;
        height: 400px;
      }

      /* Table */
      .data-table {
        background: white;
        border-radius: 8px;
        box-shadow: var(--shadow);
        overflow: hidden;
        margin-bottom: 30px;
      }

      .data-table table {
        width: 100%;
        border-collapse: collapse;
      }

      .data-table th {
        background: var(--gray-100);
        padding: var(--space-sm) var(--space-md);
        text-align: left;
        font-weight: 700;
        font-size: var(--font-size-base);
        color: var(--primary);
        border-bottom: 3px solid var(--border);
      }

      .data-table td {
        padding: var(--space-sm) var(--space-md);
        border-bottom: 1px solid var(--border);
        font-size: var(--font-size-sm);
        line-height: 1.6;
      }

      .data-table tbody tr:nth-child(even) {
        background-color: var(--gray-50);
      }

      .data-table tr:hover {
        background: var(--light);
        transition: background 0.2s;
      }

      /* Section Container */
      .section {
        background: white;
        border-radius: var(--radius-lg);
        padding: var(--space-xl);
        margin-bottom: var(--space-xl);
        box-shadow: var(--shadow-sm);
      }

      .section-title {
        font-size: var(--font-size-2xl);
        font-weight: 700;
        color: var(--primary);
        margin-bottom: var(--space-lg);
        padding-bottom: var(--space-md);
        line-height: 1.4;
        border-bottom: 3px solid var(--accent);
      }

      .section-subtitle {
        font-size: var(--font-size-xl);
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 20px;
        margin-top: 0;
        padding-bottom: 8px;
        line-height: 1.4;
        border-bottom: 1px solid var(--border);
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .main-layout {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
          max-height: 200px;
          border-right: none;
          border-bottom: 1px solid var(--border);
        }

        .top-bar {
          flex-direction: column;
          gap: var(--space-md);
          padding: var(--space-md);
        }

        .case-selector {
          width: 100%;
        }

        .case-selector select {
          width: 100%;
        }

        .kpi-grid {
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }

        .content-area {
          padding: var(--space-md);
        }

        .section {
          padding: var(--space-md);
        }

        .data-table {
          overflow-x: auto;
        }

        .data-table table {
          min-width: 800px;
        }

        .chart-wrapper {
          height: 300px;
        }
      }

      @media print {
        .sidebar {
          display: none;
        }

        .section {
          page-break-inside: avoid;
          box-shadow: none;
          border: 1px solid var(--border);
        }

        .kpi-card {
          page-break-inside: avoid;
        }

        .chart-container {
          page-break-inside: avoid;
        }
      }
    </style>
  </head>
  <body>
    <!-- Top Navigation Bar -->
    <div class="top-bar">
      <h1><i class="fas fa-chart-line"></i> Engelberg Property Investment</h1>
      <div class="case-selector">
        <label for="caseSelect">Case:</label>
        <select id="caseSelect">
          <option value="">Loading cases...</option>
        </select>
      </div>
    </div>

    <!-- Main Layout -->
    <div class="main-layout">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-header">
          <i class="fas fa-list"></i> Analysis Types
        </div>
        <ul class="sidebar-menu" id="analysisMenu">
          <li class="sidebar-menu-item active" data-analysis="base_case">
            <i class="fas fa-home"></i> Simulation KPIs
          </li>
          <li class="sidebar-menu-item" data-analysis="sensitivity">
            <i class="fas fa-sliders-h"></i> Model Sensitivity - Equity IRR
          </li>
          <li class="sidebar-menu-item" data-analysis="sensitivity_coc">
            <i class="fas fa-dollar-sign"></i> Model Sensitivity - Cash-on-Cash
          </li>
          <li class="sidebar-menu-item" data-analysis="sensitivity_ncf">
            <i class="fas fa-wallet"></i> Model Sensitivity - Monthly NCF
          </li>
          <li class="sidebar-menu-item" data-analysis="monte_carlo">
            <i class="fas fa-dice"></i> Monte Carlo
          </li>
          <li class="sidebar-menu-item" data-analysis="monte_carlo_sensitivity">
            <i class="fas fa-chart-line"></i> MC Sensitivity
          </li>
          <li class="sidebar-menu-item" data-analysis="scenario_comparison">
            <i class="fas fa-balance-scale"></i> Scenario Comparison
          </li>
        </ul>
      </div>

      <!-- Main Content Area -->
      <div class="content-area" id="contentArea">
        <div class="loading">
          <i class="fas fa-spinner"></i>
          <p>Loading data...</p>
        </div>
      </div>
    </div>

    <script>
      // State Management
      const State = {
        currentCase: null,
        currentAnalysis: "base_case",
        cases: [],
        data: {},
      };

      // Data Manager
      const DataManager = {
        async loadCasesIndex() {
          try {
            const response = await fetch("data/cases_index.json");
            if (!response.ok) {
              // If cases_index.json doesn't exist, create a default one with base_case
              console.warn("cases_index.json not found, using default");
              return {
                cases: [
                  {
                    case_name: "base_case",
                    display_name: "Base Case",
                    data_files: {
                      base_case_analysis: "base_case_base_case_analysis.json",
                    },
                  },
                ],
              };
            }
            const index = await response.json();
            State.cases = index.cases || [];
            return index;
          } catch (error) {
            console.error("Error loading cases index:", error);
            // Return default case if index doesn't exist
            return {
              cases: [
                {
                  case_name: "base_case",
                  display_name: "Base Case",
                  data_files: {
                    base_case_analysis: "base_case_base_case_analysis.json",
                  },
                },
              ],
            };
          }
        },

        async loadCaseData(caseName, analysisType) {
          const key = `${caseName}_${analysisType}`;
          if (State.data[key]) {
            return State.data[key];
          }

          try {
            let path;
            if (analysisType === "base_case") {
              // Handle both naming conventions
              path = `data/${caseName}_base_case_analysis.json`;
              // For base_case, also try the alternative naming
              if (caseName === "base_case") {
                // Try alternative path first
                const altPath = "data/base_case_base_case_analysis.json";
                try {
                  const altResponse = await fetch(altPath);
                  if (altResponse.ok) {
                    const data = await altResponse.json();
                    State.data[key] = data;
                    return data;
                  }
                } catch (e) {
                  // Fall through to try main path
                }
              }
            } else if (analysisType === "sensitivity") {
              path = `data/${caseName}_sensitivity.json`;
            } else if (analysisType === "sensitivity_coc") {
              path = `data/${caseName}_sensitivity_coc.json`;
            } else if (analysisType === "sensitivity_ncf") {
              path = `data/${caseName}_sensitivity_ncf.json`;
            } else if (analysisType === "monte_carlo") {
              path = `data/${caseName}_monte_carlo.json`;
            } else if (analysisType === "monte_carlo_sensitivity") {
              path = `data/${caseName}_monte_carlo_sensitivity.json`;
            }

            const response = await fetch(path);
            if (!response.ok) {
              throw new Error(
                `Failed to load ${path}. Make sure you have run the analysis scripts to generate the data files.`,
              );
            }
            const data = await response.json();
            State.data[key] = data;
            return data;
          } catch (error) {
            console.error(`Error loading ${analysisType} data:`, error);
            throw error;
          }
        },
      };

      // UI Manager
      const UIManager = {
        populateCaseSelector() {
          const select = document.getElementById("caseSelect");
          select.innerHTML = "";

          if (State.cases.length === 0) {
            select.innerHTML = '<option value="">No cases available</option>';
            return;
          }

          State.cases.forEach((caseInfo) => {
            const option = document.createElement("option");
            option.value = caseInfo.case_name;
            option.textContent = caseInfo.display_name || caseInfo.case_name;
            if (caseInfo.case_name === "base_case") {
              option.selected = true;
              State.currentCase = "base_case";
            }
            select.appendChild(option);
          });
        },

        updateAnalysisMenu(activeAnalysis) {
          document.querySelectorAll(".sidebar-menu-item").forEach((item) => {
            item.classList.remove("active");
            if (item.dataset.analysis === activeAnalysis) {
              item.classList.add("active");
            }
          });
        },

        showLoading() {
          const content = document.getElementById("contentArea");
          content.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>Loading data...</p>
                    </div>
                `;
        },

        showError(message) {
          const content = document.getElementById("contentArea");
          content.innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-triangle"></i> ${message}
                    </div>
                `;
        },
      };

      // Unified Chart Configuration
      const unifiedChartConfig = {
        paper_bgcolor: "#ffffff",
        plot_bgcolor: "#fafbfc",
        font: { family: "Segoe UI, Arial", size: 13, color: "#2c3e50" },
        margin: { l: 240, r: 40, t: 70, b: 80 },
        hovermode: "closest",
        showlegend: true,
        legend: {
          orientation: "h",
          x: 0.5,
          xanchor: "center",
          y: 1.08,
          bgcolor: "rgba(255,255,255,0.95)",
          bordercolor: "#ddd",
          borderwidth: 1,
          font: { size: 13, color: "#2c3e50" },
        },
        colors: {
          positive: "#2ecc71",
          negative: "#e74c3c",
          neutral: "#95a5a6",
          base: "#667eea",
        },
      };

      // Chart Renderer
      const ChartRenderer = {
        renderBaseCase(data) {
          const content = document.getElementById("contentArea");
          const results = data.annual_results || {};
          const kpis = data.kpis || {};
          const irr = data.irr_results || {};
          const projection = data.projection_15yr || [];
          const numOwners = data.config?.financing?.num_owners || 1;

          // Helper function to format currency
          const formatCHF = (value) => {
            return value.toLocaleString("en-US", {
              style: "currency",
              currency: "CHF",
              maximumFractionDigits: 0,
            });
          };

          // Calculate per-person monthly values
          const interestMonthlyPerPerson =
            (results.interest_payment || 0) / 12 / numOwners;
          const principalMonthlyPerPerson =
            (results.amortization_payment || 0) / 12 / numOwners;
          const maintenanceMonthlyPerPerson =
            (results.maintenance_reserve || 0) / 12 / numOwners;
          const operatingExpensesMonthlyPerPerson =
            (results.total_operating_expenses || 0) / 12 / numOwners;
          const airbnbCashflowMonthlyPerPerson =
            (results.cash_flow_per_owner || 0) / 12;
          const taxSavingsMonthlyPerPerson =
            (results.tax_savings_per_owner || 0) / 12;
          const afterTaxCashflowMonthlyPerPerson =
            (results.after_tax_cash_flow_per_owner || 0) / 12;
          const propertyManagementMonthlyPerPerson =
            (results.property_management_cost || 0) / 12 / numOwners;
          const cleaningMonthlyPerPerson =
            (results.cleaning_cost || 0) / 12 / numOwners;
          const insuranceMonthlyPerPerson =
            (results.insurance || 0) / 12 / numOwners;
          const grossRentalIncomeMonthlyPerPerson =
            (results.gross_rental_income || 0) / 12 / numOwners;

          // Calculate total monthly values
          const interestMonthlyTotal = (results.interest_payment || 0) / 12;
          const principalMonthlyTotal =
            (results.amortization_payment || 0) / 12;
          const maintenanceMonthlyTotal =
            (results.maintenance_reserve || 0) / 12;
          const operatingExpensesMonthlyTotal =
            (results.total_operating_expenses || 0) / 12;
          const airbnbCashflowMonthlyTotal =
            (results.cash_flow_after_debt_service || 0) / 12;
          const taxSavingsMonthlyTotal = (results.tax_savings_total || 0) / 12;
          const afterTaxCashflowMonthlyTotal =
            (results.after_tax_cash_flow_total || 0) / 12;
          const propertyManagementMonthlyTotal =
            (results.property_management_cost || 0) / 12;
          const cleaningMonthlyTotal = (results.cleaning_cost || 0) / 12;
          const insuranceMonthlyTotal = (results.insurance || 0) / 12;
          const grossRentalIncomeMonthlyTotal =
            (results.gross_rental_income || 0) / 12;

          // Calculate additional metrics for new structure
          const purchasePrice =
            data.config?.financing?.purchase_price ||
            results.purchase_price ||
            0;
          const loanAmount =
            data.config?.financing?.loan_amount || results.loan_amount || 0;
          const equityTotal =
            data.config?.financing?.equity_total || results.equity_total || 0;
          const acquisitionCostsTotal =
            data.config?.financing?.acquisition_costs_total || 0;
          const totalInitialInvestment =
            data.config?.financing?.total_initial_investment ||
            equityTotal + acquisitionCostsTotal;
          const totalInitialInvestmentPerOwner =
            data.config?.financing?.total_initial_investment_per_owner ||
            totalInitialInvestment / numOwners;
          const grossRentalIncome = results.gross_rental_income || 0;
          const otaFeesTotal = results.ota_fees_total || 0;
          const netRentalIncome =
            results.net_rental_income || grossRentalIncome;
          const noi = results.net_operating_income || 0;
          const debtService = results.debt_service || 0;
          const preTaxCashFlow = results.cash_flow_after_debt_service || 0;
          const taxSavingsTotal = results.tax_savings_total || 0;
          const afterTaxCashFlow =
            results.after_tax_cash_flow_total || preTaxCashFlow;

          let html = `
                    <!-- Section 1: Investment Overview -->
                    <div class="section">
                        <h2 class="section-title">üí∞ Investment Overview</h2>
                        <div class="kpi-grid">
                            <div class="kpi-card">
                                <h3>Purchase Price</h3>
                                <div class="value">${formatCHF(purchasePrice)}</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Loan Amount</h3>
                                <div class="value">${formatCHF(loanAmount)}</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Equity Total</h3>
                                <div class="value">${formatCHF(equityTotal)}</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Acquisition Costs</h3>
                                <div class="value">${formatCHF(acquisitionCostsTotal)}</div>
                            </div>
                            <div class="kpi-card" style="border: 2px solid var(--accent); background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%);">
                                <h3>Total Initial Investment</h3>
                                <div class="value" style="color: var(--accent);">${formatCHF(totalInitialInvestment)}</div>
                            </div>
                            <div class="kpi-card" style="border: 2px solid var(--accent); background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%);">
                                <h3>Total Investment per Owner</h3>
                                <div class="value" style="color: var(--accent);">${formatCHF(totalInitialInvestmentPerOwner)}</div>
                            </div>
                            <div class="kpi-card">
                                <h3>LTV</h3>
                                <div class="value">${((data.config?.financing?.ltv || 0) * 100).toFixed(0)}%</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Interest Rate</h3>
                                <div class="value">${((data.config?.financing?.interest_rate || 0) * 100).toFixed(2)}%</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Number of Owners</h3>
                                <div class="value">${numOwners}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 2: Revenue & Operating Model -->
                    <div class="section">
                        <h2 class="section-title">üìä Revenue & Operating Model</h2>
                        <div class="kpi-grid" style="margin-bottom: var(--space-lg);">
                            <div class="kpi-card">
                                <h3>Gross Rental Income</h3>
                                <div class="value positive">${formatCHF(grossRentalIncome)}</div>
                                <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">annual</div>
                            </div>
                            <div class="kpi-card">
                                <h3>OTA Platform Fees</h3>
                                <div class="value negative">-${formatCHF(otaFeesTotal)}</div>
                                <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">${((otaFeesTotal / grossRentalIncome) * 100).toFixed(1)}% of gross</div>
                            </div>
                            <div class="kpi-card" style="border: 2px solid var(--color-info);">
                                <h3>Net Rental Income</h3>
                                <div class="value positive" style="color: var(--color-info);">${formatCHF(netRentalIncome)}</div>
                                <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">after OTA fees</div>
                            </div>
                        </div>
                        <h3 class="section-subtitle">Operating Expenses</h3>
                        <div class="kpi-grid" style="margin-bottom: var(--space-lg);">
                            <div class="kpi-card">
                                <h3>Property Management</h3>
                                <div class="value">${formatCHF(results.property_management_cost || 0)}</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Cleaning Cost</h3>
                                <div class="value">${formatCHF(results.cleaning_cost || 0)}</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Tourist Tax</h3>
                                <div class="value">${formatCHF(results.tourist_tax || 0)}</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Insurance</h3>
                                <div class="value">${formatCHF(results.insurance || 0)}</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Nubbing Costs</h3>
                                <div class="value">${formatCHF(results.nubbing_costs || 0)}</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Electricity & Internet</h3>
                                <div class="value">${formatCHF(results.electricity_internet || 0)}</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Maintenance Reserve</h3>
                                <div class="value">${formatCHF(results.maintenance_reserve || 0)}</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Total Operating Expenses</h3>
                                <div class="value">${formatCHF(results.total_operating_expenses || 0)}</div>
                            </div>
                        </div>
                        <div class="kpi-card" style="border: 2px solid var(--color-positive); background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); margin-top: var(--space-md);">
                            <h3>Net Operating Income (NOI)</h3>
                            <div class="value positive" style="font-size: var(--font-size-3xl);">${formatCHF(noi)}</div>
                            <div class="unit" style="font-size: var(--font-size-sm); color: var(--gray-500); margin-top: var(--space-xs);">Revenue - Operating Expenses</div>
                        </div>
                    </div>

                    <!-- Section 3: Cash Flow Analysis (KEY SECTION) -->
                    <div class="section" style="border: 2px solid var(--accent); background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);">
                        <h2 class="section-title">üíµ Cash Flow Analysis</h2>
                        <div class="kpi-grid" style="margin-bottom: var(--space-lg);">
                            <div class="kpi-card">
                                <h3>Debt Service (Interest)</h3>
                                <div class="value negative">-${formatCHF(results.interest_payment || 0)}</div>
                                <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">annual</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Debt Service (Principal)</h3>
                                <div class="value negative">-${formatCHF(results.amortization_payment || 0)}</div>
                                <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">annual</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Total Debt Service</h3>
                                <div class="value negative">-${formatCHF(debtService)}</div>
                            </div>
                        </div>
                        <div class="kpi-card" style="border: 1px solid var(--gray-300); margin-bottom: var(--space-md);">
                            <h3>Pre-Tax Cash Flow</h3>
                            <div class="value ${preTaxCashFlow >= 0 ? "positive" : "negative"}">${formatCHF(preTaxCashFlow)}</div>
                            <div class="unit" style="font-size: var(--font-size-sm); color: var(--gray-500); margin-top: var(--space-xs);">NOI - Debt Service</div>
                        </div>
                        <div class="kpi-card" style="border: 2px solid var(--color-positive); background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); margin-bottom: var(--space-md);">
                            <h3>Tax Savings</h3>
                            <div class="value positive" style="font-size: var(--font-size-2xl);">+${formatCHF(taxSavingsTotal)}</div>
                            <div class="unit" style="font-size: var(--font-size-sm); color: var(--gray-500); margin-top: var(--space-xs);">Interest √ó 30% tax rate</div>
                        </div>
                        <div class="kpi-card" style="border: 3px solid var(--accent); background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%);">
                            <h3>After-Tax Cash Flow (KEY METRIC)</h3>
                            <div class="value ${afterTaxCashFlow >= 0 ? "positive" : "negative"}" style="font-size: var(--font-size-3xl);">${formatCHF(afterTaxCashFlow)}</div>
                            <div class="unit" style="font-size: var(--font-size-sm); color: var(--gray-500); margin-top: var(--space-xs);">Pre-tax + Tax Savings</div>
                        </div>
                        <div style="margin-top: var(--space-lg); padding: var(--space-md); background: var(--gray-50); border-radius: var(--radius-md);">
                            <h3 class="section-subtitle" style="margin-top: 0;">Per-Person Monthly Breakdown</h3>
                            <div class="kpi-grid">
                                <div class="kpi-card">
                                    <h3>Pre-Tax Cashflow</h3>
                                    <div class="value ${airbnbCashflowMonthlyPerPerson >= 0 ? "positive" : "negative"}">${formatCHF(airbnbCashflowMonthlyPerPerson)}</div>
                                    <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">per person/month</div>
                                </div>
                                <div class="kpi-card">
                                    <h3>Tax Savings</h3>
                                    <div class="value positive">${formatCHF(taxSavingsMonthlyPerPerson)}</div>
                                    <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">per person/month</div>
                                </div>
                                <div class="kpi-card" style="border: 2px solid var(--accent);">
                                    <h3>After-Tax Cashflow</h3>
                                    <div class="value ${afterTaxCashflowMonthlyPerPerson >= 0 ? "positive" : "negative"}">${formatCHF(afterTaxCashflowMonthlyPerPerson)}</div>
                                    <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">per person/month</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 4: Investment Returns & Performance -->
                    <div class="section">
                        <h2 class="section-title">üìà Investment Returns & Performance</h2>
                        <div class="kpi-grid">
                            <div class="kpi-grid">
                                <div class="kpi-card">
                                    <h3>Interest Payment</h3>
                                    <div class="value">${formatCHF(interestMonthlyPerPerson)}</div>
                                    <div class="unit" style="font-size: 0.75em; color: #666; margin-top: 4px;">per person/month</div>
                                </div>
                                <div class="kpi-card">
                                    <h3>Principal Payment</h3>
                                    <div class="value">${formatCHF(principalMonthlyPerPerson)}</div>
                                    <div class="unit" style="font-size: 0.75em; color: #666; margin-top: 4px;">per person/month</div>
                                </div>
                                <div class="kpi-card">
                                    <h3>Maintenance Reserve</h3>
                                    <div class="value">${formatCHF(maintenanceMonthlyPerPerson)}</div>
                                    <div class="unit" style="font-size: 0.75em; color: #666; margin-top: 4px;">per person/month</div>
                                </div>
                                <div class="kpi-card">
                                    <h3>Operating Expenses</h3>
                                    <div class="value">${formatCHF(operatingExpensesMonthlyPerPerson)}</div>
                                    <div class="unit" style="font-size: 0.75em; color: #666; margin-top: 4px;">per person/month</div>
                                </div>
                                <div class="kpi-card">
                                    <h3>Pre-Tax Cashflow</h3>
                                    <div class="value ${
                                      airbnbCashflowMonthlyPerPerson >= 0
                                        ? "positive"
                                        : "negative"
                                    }">${formatCHF(airbnbCashflowMonthlyPerPerson)}</div>
                                    <div class="unit" style="font-size: 0.75em; color: #666; margin-top: 4px;">per person/month</div>
                                </div>
                                <div class="kpi-card">
                                    <h3>Tax Savings</h3>
                                    <div class="value positive">${formatCHF(taxSavingsMonthlyPerPerson)}</div>
                                    <div class="unit" style="font-size: 0.75em; color: #666; margin-top: 4px;">per person/month</div>
                                </div>
                                <div class="kpi-card">
                                    <h3>After-Tax Cashflow</h3>
                                    <div class="value ${
                                      afterTaxCashflowMonthlyPerPerson >= 0
                                        ? "positive"
                                        : "negative"
                                    }">${formatCHF(afterTaxCashflowMonthlyPerPerson)}</div>
                                    <div class="unit" style="font-size: 0.75em; color: #666; margin-top: 4px;">per person/month</div>
                                </div>
                                <div class="kpi-card">
                                    <h3>Property Management</h3>
                                    <div class="value">${formatCHF(propertyManagementMonthlyPerPerson)}</div>
                                    <div class="unit" style="font-size: 0.75em; color: #666; margin-top: 4px;">per person/month</div>
                                </div>
                                <div class="kpi-card">
                                    <h3>Cleaning Cost</h3>
                                    <div class="value">${formatCHF(cleaningMonthlyPerPerson)}</div>
                                    <div class="unit" style="font-size: 0.75em; color: #666; margin-top: 4px;">per person/month</div>
                                </div>
                                <div class="kpi-card">
                                    <h3>Insurance</h3>
                                    <div class="value">${formatCHF(insuranceMonthlyPerPerson)}</div>
                                    <div class="unit" style="font-size: 0.75em; color: #666; margin-top: 4px;">per person/month</div>
                                </div>
                                <div class="kpi-card">
                                    <h3>Gross Rental Income</h3>
                                    <div class="value positive">${formatCHF(grossRentalIncomeMonthlyPerPerson)}</div>
                                    <div class="unit" style="font-size: 0.75em; color: #666; margin-top: 4px;">per person/month</div>
                                </div>
                            </div>
                        </div>

                        <!-- Section 2: Total Monthly Cash Flow -->
                        <div style="margin-bottom: 40px;">
                            <h3 class="section-subtitle">üíº Total Monthly Cash Flow</h3>
                            <div class="kpi-grid">
                                <div class="kpi-card">
                                    <h3>Interest Payment</h3>
                                    <div class="value">${formatCHF(interestMonthlyTotal)}</div>
                                    <div class="unit" style="font-size: 0.75em; color: #666; margin-top: 4px;">total/month</div>
                                </div>
                                <div class="kpi-card">
                                    <h3>Principal Payment</h3>
                                    <div class="value">${formatCHF(principalMonthlyTotal)}</div>
                                    <div class="unit" style="font-size: 0.75em; color: #666; margin-top: 4px;">total/month</div>
                                </div>
                                <div class="kpi-card">
                                    <h3>Maintenance Reserve</h3>
                                    <div class="value">${formatCHF(maintenanceMonthlyTotal)}</div>
                                    <div class="unit" style="font-size: 0.75em; color: #666; margin-top: 4px;">total/month</div>
                                </div>
                                <div class="kpi-card">
                                    <h3>Operating Expenses</h3>
                                    <div class="value">${formatCHF(operatingExpensesMonthlyTotal)}</div>
                                    <div class="unit" style="font-size: 0.75em; color: #666; margin-top: 4px;">total/month</div>
                                </div>
                                <div class="kpi-card">
                                    <h3>Pre-Tax Cashflow</h3>
                                    <div class="value ${
                                      airbnbCashflowMonthlyTotal >= 0
                                        ? "positive"
                                        : "negative"
                                    }">${formatCHF(airbnbCashflowMonthlyTotal)}</div>
                                    <div class="unit" style="font-size: 0.75em; color: #666; margin-top: 4px;">total/month</div>
                                </div>
                                <div class="kpi-card">
                                    <h3>Tax Savings</h3>
                                    <div class="value positive">${formatCHF(taxSavingsMonthlyTotal)}</div>
                                    <div class="unit" style="font-size: 0.75em; color: #666; margin-top: 4px;">total/month</div>
                                </div>
                                <div class="kpi-card">
                                    <h3>After-Tax Cashflow</h3>
                                    <div class="value ${
                                      afterTaxCashflowMonthlyTotal >= 0
                                        ? "positive"
                                        : "negative"
                                    }">${formatCHF(afterTaxCashflowMonthlyTotal)}</div>
                                    <div class="unit" style="font-size: 0.75em; color: #666; margin-top: 4px;">total/month</div>
                                </div>
                                <div class="kpi-card">
                                    <h3>Property Management</h3>
                                    <div class="value">${formatCHF(propertyManagementMonthlyTotal)}</div>
                                    <div class="unit" style="font-size: 0.75em; color: #666; margin-top: 4px;">total/month</div>
                                </div>
                                <div class="kpi-card">
                                    <h3>Cleaning Cost</h3>
                                    <div class="value">${formatCHF(cleaningMonthlyTotal)}</div>
                                    <div class="unit" style="font-size: 0.75em; color: #666; margin-top: 4px;">total/month</div>
                                </div>
                                <div class="kpi-card">
                                    <h3>Insurance</h3>
                                    <div class="value">${formatCHF(insuranceMonthlyTotal)}</div>
                                    <div class="unit" style="font-size: 0.75em; color: #666; margin-top: 4px;">total/month</div>
                                </div>
                                <div class="kpi-card">
                                    <h3>Gross Rental Income</h3>
                                    <div class="value positive">${formatCHF(grossRentalIncomeMonthlyTotal)}</div>
                                    <div class="unit" style="font-size: 0.75em; color: #666; margin-top: 4px;">total/month</div>
                                </div>
                            </div>
                        </div>

                            <div class="kpi-card">
                                <h3>Equity IRR (15Y)</h3>
                                <div class="value positive">${(
                                  irr.equity_irr_with_sale_pct || 0
                                ).toFixed(2)}%</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Project IRR</h3>
                                <div class="value positive">${(
                                  irr.project_irr_with_sale_pct || 0
                                ).toFixed(2)}%</div>
                            </div>
                            <div class="kpi-card">
                                <h3>NPV @ 5%</h3>
                                <div class="value ${
                                  (irr.npv_at_5pct || 0) >= 0
                                    ? "positive"
                                    : "negative"
                                }">${formatCHF(irr.npv_at_5pct || 0)}</div>
                            </div>
                            <div class="kpi-card">
                                <h3>MOIC</h3>
                                <div class="value ${
                                  (irr.moic || 0) >= 1 ? "positive" : "negative"
                                }">${(irr.moic || 0).toFixed(2)}x</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Cash-on-Cash Return</h3>
                                <div class="value ${
                                  (results.cash_on_cash_return_pct ||
                                    kpis.cash_on_cash_return_pct ||
                                    0) >= 0
                                    ? "positive"
                                    : "negative"
                                }">${(
                                  results.cash_on_cash_return_pct ||
                                  kpis.cash_on_cash_return_pct ||
                                  0
                                ).toFixed(2)}%</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Payback Period</h3>
                                <div class="value">${
                                  irr.payback_period_years
                                    ? irr.payback_period_years + "Y"
                                    : "N/A"
                                }</div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 5: Property Fundamentals -->
                    <div class="section">
                        <h2 class="section-title">üè† Property Fundamentals</h2>
                        <div class="kpi-grid">
                            <div class="kpi-card">
                                <h3>Property Value</h3>
                                <div class="value">${formatCHF(purchasePrice)}</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Loan Balance</h3>
                                <div class="value">${formatCHF(loanAmount)}</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Equity</h3>
                                <div class="value">${formatCHF(equityTotal)}</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Cap Rate</h3>
                                <div class="value">${(
                                  kpis.cap_rate_pct ||
                                  results.cap_rate_pct ||
                                  0
                                ).toFixed(2)}%</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Debt Coverage Ratio</h3>
                                <div class="value">${(
                                  results.debt_coverage_ratio ||
                                  kpis.debt_coverage_ratio ||
                                  0
                                ).toFixed(2)}x</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Operating Expense Ratio</h3>
                                <div class="value">${(
                                  results.operating_expense_ratio_pct || 0
                                ).toFixed(1)}%</div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 6: 15-Year Projection -->
                    <div class="section">
                        <h2 class="section-title">üìÖ 15-Year Financial Projection</h2>
                        
                        <!-- Summary Row -->
                        ${
                          projection.length > 0
                            ? `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-md); margin-bottom: var(--space-lg); padding: var(--space-md); background: var(--gray-50); border-radius: var(--radius-md);">
                            <div>
                                <strong style="color: var(--secondary); font-size: var(--font-size-sm);">Year 1</strong>
                                <div style="margin-top: var(--space-xs);">
                                    <div>Cash Flow: <strong style="color: ${projection[0]?.cash_flow_after_debt_service >= 0 ? "var(--color-positive)" : "var(--color-negative)"}">${formatCHF(projection[0]?.cash_flow_after_debt_service || 0)}</strong></div>
                                    <div>Property Value: <strong>${formatCHF(projection[0]?.property_value || 0)}</strong></div>
                                </div>
                            </div>
                            ${
                              projection.length >= 5
                                ? `
                            <div>
                                <strong style="color: var(--secondary); font-size: var(--font-size-sm);">Year 5</strong>
                                <div style="margin-top: var(--space-xs);">
                                    <div>Cash Flow: <strong style="color: ${projection[4]?.cash_flow_after_debt_service >= 0 ? "var(--color-positive)" : "var(--color-negative)"}">${formatCHF(projection[4]?.cash_flow_after_debt_service || 0)}</strong></div>
                                    <div>Property Value: <strong>${formatCHF(projection[4]?.property_value || 0)}</strong></div>
                                </div>
                            </div>
                            `
                                : ""
                            }
                            ${
                              projection.length >= 10
                                ? `
                            <div>
                                <strong style="color: var(--secondary); font-size: var(--font-size-sm);">Year 10</strong>
                                <div style="margin-top: var(--space-xs);">
                                    <div>Cash Flow: <strong style="color: ${projection[9]?.cash_flow_after_debt_service >= 0 ? "var(--color-positive)" : "var(--color-negative)"}">${formatCHF(projection[9]?.cash_flow_after_debt_service || 0)}</strong></div>
                                    <div>Property Value: <strong>${formatCHF(projection[9]?.property_value || 0)}</strong></div>
                                </div>
                            </div>
                            `
                                : ""
                            }
                            ${
                              projection.length >= 15
                                ? `
                            <div>
                                <strong style="color: var(--secondary); font-size: var(--font-size-sm);">Year 15</strong>
                                <div style="margin-top: var(--space-xs);">
                                    <div>Cash Flow: <strong style="color: ${projection[14]?.cash_flow_after_debt_service >= 0 ? "var(--color-positive)" : "var(--color-negative)"}">${formatCHF(projection[14]?.cash_flow_after_debt_service || 0)}</strong></div>
                                    <div>Property Value: <strong>${formatCHF(projection[14]?.property_value || 0)}</strong></div>
                                </div>
                            </div>
                            `
                                : ""
                            }
                        </div>
                        `
                            : ""
                        }
                        
                        <!-- Assumptions Summary -->
                        <div class="chart-container" style="background: #f8f9fa; border-left: 4px solid var(--accent);">
                            <h3 style="color: var(--primary); margin-bottom: 15px;">üìã Main Assumptions</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; font-size: 0.9em;">
                                <div>
                                    <strong style="color: var(--secondary);">Financing</strong>
                                    <div style="margin-top: 8px; line-height: 1.8;">
                                        ‚Ä¢ Purchase Price: <strong>CHF ${(
                                          data.config?.financing
                                            ?.purchase_price || 0
                                        ).toLocaleString()}</strong><br>
                                        ‚Ä¢ LTV: <strong>${(
                                          (data.config?.financing?.ltv || 0) *
                                          100
                                        ).toFixed(0)}%</strong> (Loan: CHF ${(
                                          data.config?.financing?.loan_amount ||
                                          0
                                        ).toLocaleString()})<br>
                                        ‚Ä¢ Interest Rate: <strong>${(
                                          (data.config?.financing
                                            ?.interest_rate || 0) * 100
                                        ).toFixed(2)}%</strong><br>
                                        ‚Ä¢ Amortization: <strong>${(
                                          (data.config?.financing
                                            ?.amortization_rate || 0) * 100
                                        ).toFixed(1)}%</strong> per year<br>
                                        ‚Ä¢ Owners: <strong>${
                                          data.config?.financing?.num_owners ||
                                          0
                                        }</strong> (Equity: CHF ${(
                                          (data.config?.financing
                                            ?.equity_total || 0) /
                                          (data.config?.financing?.num_owners ||
                                            1)
                                        ).toLocaleString()}/owner)
                                    </div>
                                </div>
                                <div>
                                    <strong style="color: var(--secondary);">Rental Income</strong>
                                    <div style="margin-top: 8px; line-height: 1.8;">
                                        ‚Ä¢ Occupancy Rate: <strong>${(
                                          (data.config?.rental
                                            ?.occupancy_rate || 0) * 100
                                        ).toFixed(0)}%</strong><br>
                                        ‚Ä¢ Average Daily Rate: <strong>CHF ${(
                                          data.config?.rental
                                            ?.average_daily_rate || 0
                                        ).toFixed(0)}</strong><br>
                                        ‚Ä¢ Rentable Nights: <strong>${
                                          results.rentable_nights || 0
                                        }</strong> nights/year<br>
                                        ‚Ä¢ Rented Nights: <strong>${
                                          results.rented_nights || 0
                                        }</strong> nights/year<br>
                                        ‚Ä¢ Owner Nights: <strong>${
                                          data.config?.rental
                                            ?.owner_nights_per_person || 0
                                        } per owner</strong>
                                    </div>
                                </div>
                                <div>
                                    <strong style="color: var(--secondary);">Projections & Exit</strong>
                                    <div style="margin-top: 8px; line-height: 1.8;">
                                        ‚Ä¢ Inflation: <strong>0.8%</strong> per year<br>
                                        ‚Ä¢ Property Appreciation: <strong>1.5%</strong> per year<br>
                                        ‚Ä¢ Projection Period: <strong>15 years</strong> (2026-2040)<br>
                                        ‚Ä¢ Selling Costs (Year 15): <strong>7.8%</strong><br>
                                        ‚Ä¢ Discount Rate (NPV): <strong>5.0%</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Enhanced 15-Year Projection Table -->
                        <div class="data-table">
                            <h3 style="padding: var(--space-md); margin: 0; border-bottom: 2px solid var(--border); background: var(--gray-50); font-size: var(--font-size-lg);">15-Year Financial Projection</h3>
                            <table style="font-size: var(--font-size-sm);">
                                <thead>
                                    <tr style="background: var(--gray-100);">
                                        <th style="padding: var(--space-sm) var(--space-md);">Year</th>
                                        <th style="padding: var(--space-sm) var(--space-md);">Revenue</th>
                                        <th style="padding: var(--space-sm) var(--space-md);">Expenses</th>
                                        <th style="padding: var(--space-sm) var(--space-md);">NOI</th>
                                        <th style="padding: var(--space-sm) var(--space-md);">Debt Service</th>
                                        <th style="padding: var(--space-sm) var(--space-md);">Cash Flow</th>
                                        <th style="padding: var(--space-sm) var(--space-md);">CF/Owner</th>
                                        <th style="padding: var(--space-sm) var(--space-md);">Property Value</th>
                                        <th style="padding: var(--space-sm) var(--space-md);">Loan Balance</th>
                                        <th style="padding: var(--space-sm) var(--space-md);">Equity</th>
                                        <th style="padding: var(--space-sm) var(--space-md);">Cap Rate</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${projection
                                      .slice(0, 15)
                                      .map((year, index) => {
                                        const equity =
                                          year.property_value -
                                          year.remaining_loan_balance;
                                        const isKeyYear =
                                          index === 0 ||
                                          index === 4 ||
                                          index === 9 ||
                                          index === 14;
                                        return `
                                        <tr style="${isKeyYear ? "background: #fffbf0; font-weight: 600;" : ""} ${index % 2 === 0 ? "background-color: " + (isKeyYear ? "#fffbf0" : "transparent") + ";" : "background-color: var(--gray-50);"}">
                                            <td style="padding: var(--space-sm) var(--space-md);"><strong>${
                                              year.year
                                            }</strong></td>
                                            <td style="padding: var(--space-sm) var(--space-md);">${(
                                              year.gross_rental_income || 0
                                            ).toLocaleString("en-US", {
                                              style: "currency",
                                              currency: "CHF",
                                              maximumFractionDigits: 0,
                                            })}</td>
                                            <td style="padding: var(--space-sm) var(--space-md);">${(
                                              year.total_operating_expenses || 0
                                            ).toLocaleString("en-US", {
                                              style: "currency",
                                              currency: "CHF",
                                              maximumFractionDigits: 0,
                                            })}</td>
                                            <td style="padding: var(--space-sm) var(--space-md);">${(
                                              year.net_operating_income || 0
                                            ).toLocaleString("en-US", {
                                              style: "currency",
                                              currency: "CHF",
                                              maximumFractionDigits: 0,
                                            })}</td>
                                            <td style="padding: var(--space-sm) var(--space-md);">${(
                                              year.debt_service || 0
                                            ).toLocaleString("en-US", {
                                              style: "currency",
                                              currency: "CHF",
                                              maximumFractionDigits: 0,
                                            })}</td>
                                            <td style="padding: var(--space-sm) var(--space-md); color: ${
                                              year.cash_flow_after_debt_service >=
                                              0
                                                ? "var(--color-positive)"
                                                : "var(--color-negative)"
                                            }">${(
                                              year.cash_flow_after_debt_service ||
                                              0
                                            ).toLocaleString("en-US", {
                                              style: "currency",
                                              currency: "CHF",
                                              maximumFractionDigits: 0,
                                            })}</td>
                                            <td style="padding: var(--space-sm) var(--space-md); color: ${
                                              year.cash_flow_per_owner >= 0
                                                ? "var(--color-positive)"
                                                : "var(--color-negative)"
                                            }">${(
                                              year.cash_flow_per_owner || 0
                                            ).toLocaleString("en-US", {
                                              style: "currency",
                                              currency: "CHF",
                                              maximumFractionDigits: 0,
                                            })}</td>
                                            <td style="padding: var(--space-sm) var(--space-md);">${(
                                              year.property_value || 0
                                            ).toLocaleString("en-US", {
                                              style: "currency",
                                              currency: "CHF",
                                              maximumFractionDigits: 0,
                                            })}</td>
                                            <td style="padding: var(--space-sm) var(--space-md);">${(
                                              year.remaining_loan_balance || 0
                                            ).toLocaleString("en-US", {
                                              style: "currency",
                                              currency: "CHF",
                                              maximumFractionDigits: 0,
                                            })}</td>
                                            <td style="padding: var(--space-sm) var(--space-md);">${equity.toLocaleString(
                                              "en-US",
                                              {
                                                style: "currency",
                                                currency: "CHF",
                                                maximumFractionDigits: 0,
                                              },
                                            )}</td>
                                            <td style="padding: var(--space-sm) var(--space-md);">${year.cap_rate_pct.toFixed(
                                              2,
                                            )}%</td>
                                        </tr>
                                    `;
                                      })
                                      .join("")}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

          content.innerHTML = html;
        },

        renderSensitivity(data) {
          const content = document.getElementById("contentArea");
          const sensitivities = data.sensitivities || [];
          const baseIRR = data.base_irr || 0;
          const baseATCF = data.base_atcf || 0; // After-tax cash flow per person (monthly)

          // Use unified styling
          const chartColors = unifiedChartConfig.colors;

          // Helper function to format currency
          const formatCHF = (value) => {
            return value.toLocaleString("en-US", {
              style: "currency",
              currency: "CHF",
              maximumFractionDigits: 0,
            });
          };

          // Parameter explanations and rationales
          const parameterInfo = {
            "Property Appreciation Rate": {
              range: "1.5% to 3.5% (¬±1%)",
              rationale:
                "Property appreciation is the dominant driver of long-term returns. Swiss real estate historically appreciates 2-3% annually. This tests downside (1.5%) and upside (3.5%) scenarios.",
              icon: "üìà",
            },
            "Maintenance Reserve Rate": {
              range: "0.2% to 1.2% (¬±0.5%)",
              rationale:
                "Maintenance reserve accounts for property upkeep and repairs. 0.7% of property value is balanced, but actual costs can vary. Lower rates assume newer property; higher rates account for aging or unexpected repairs.",
              icon: "üîß",
            },
            "Property Management Fee": {
              range: "15% to 25% (¬±5%)",
              rationale:
                "Management companies charge 15-25% of gross revenue. Lower fees possible with local operators or self-management; higher fees include premium services or peak season surcharges.",
              icon: "üè¢",
            },
            "Purchase Price": {
              range: "CHF 1.17M to 1.43M (¬±10%)",
              rationale:
                "Property prices can vary based on negotiation, market conditions, and property condition. Testing ¬±10% shows sensitivity to purchase timing and negotiation success.",
              icon: "üí∞",
            },
            "Occupancy Rate": {
              range: "56.7% to 69.3% (¬±10%)",
              rationale:
                "Occupancy varies with marketing effectiveness, property quality, and market demand. Engelberg averages 63% but can swing based on snow conditions and tourism trends.",
              icon: "üìÖ",
            },
            "Average Daily Rate": {
              range: "CHF 160 to 240 (¬±20%)",
              rationale:
                "Nightly rates fluctuate with seasonality and competition. CHF 200 is the average but can range from CHF 150 (off-peak) to CHF 250+ (peak ski season). Tests pricing strategy impact.",
              icon: "üíµ",
            },
            "Interest Rate": {
              range: "0.3% to 2.3% (¬±1%)",
              rationale:
                "Swiss mortgage rates are currently low (~1.3%) but can change with refinancing or market conditions. Testing ¬±1% covers scenarios from ultra-low to moderate rates.",
              icon: "üìä",
            },
            "Loan-to-Value (LTV)": {
              range: "67.5% to 82.5% (¬±10%)",
              rationale:
                "LTV affects leverage and equity requirement. Swiss banks typically offer 60-80% LTV for investment properties. Higher LTV means less equity needed but more debt risk.",
              icon: "üè¶",
            },
            "Inflation Rate": {
              range: "0.5% to 1.5% (¬±0.5%)",
              rationale:
                "Inflation affects both revenue and expense growth over the 15-year projection. Higher inflation increases future rents but also future costs. Net effect is relatively neutral but compounds over time.",
              icon: "üìä",
            },
            "Amortization Rate": {
              range: "0% (interest-only) to 2%",
              rationale:
                "Amortization rate determines annual principal paydown. 0% (interest-only) maximizes cash flow but keeps debt high. 2% builds equity faster but reduces annual cash flow. Most Swiss mortgages use 1% amortization.",
              icon: "üí≥",
            },
            "Cleaning Cost per Stay": {
              range: "CHF 49 to 91 (¬±30%)",
              rationale:
                "Professional cleaning cost per turnover. With ~130 turnovers annually, this is a significant expense. Negotiating from CHF 80 to CHF 60 saves CHF 2,600/year = CHF 650 per owner.",
              icon: "üßπ",
            },
            "Average Length of Stay": {
              range: "1.19 to 2.21 nights (¬±30%)",
              rationale:
                "Average booking length affects cleaning frequency. Longer stays = fewer turnovers = lower cleaning costs = better cash flow. Offering multi-night discounts can encourage longer stays.",
              icon: "üìÖ",
            },
            "Insurance Rate": {
              range: "0.3% to 0.5% of property value",
              rationale:
                "Annual property insurance as % of value. Covers building, liability, and rental interruption. Shopping around can save CHF 1,300-2,600 annually. Rates vary by coverage level and provider.",
              icon: "üõ°Ô∏è",
            },
            "Winter Season Occupancy": {
              range: "63.75% to 86.25% (¬±15%)",
              rationale:
                "Occupancy specifically during winter ski season (Dec-Mar). This is the premium season with highest rates (CHF 250/night). Targeted winter marketing can significantly boost returns.",
              icon: "‚õ∑Ô∏è",
            },
            "Selling Costs Rate": {
              range: "5.8% to 9.8% (¬±2%)",
              rationale:
                "Total transaction costs when selling at Year 15. Includes broker fees (3%, negotiable 2-4%), notary (1.5%), and transfer tax (3.3% in Obwalden, varies by canton 1-3.3%). Lower costs = more net proceeds.",
              icon: "üìù",
            },
          };

          // Sort sensitivities by after-tax cash flow impact for the first chart
          const sensitivitiesForATCF = sensitivities
            .filter((s) => s.impact_atcf !== undefined)
            .map((s) => ({
              ...s,
              impact: s.impact_atcf || 0,
            }))
            .sort((a, b) => (b.impact_atcf || 0) - (a.impact_atcf || 0));

          // Sort sensitivities by IRR impact for the second chart (original)
          const sensitivitiesForIRR = [...sensitivities].sort(
            (a, b) => b.impact - a.impact,
          );

          let html = `
                    <div class="section">
                        <h2 class="section-title">üéØ Model Sensitivity Analysis</h2>
                        
                        <!-- Info Box -->
                        <div style="background: linear-gradient(135deg, var(--accent) 0%, var(--secondary) 100%); color: white; padding: var(--space-md) var(--space-lg); border-radius: var(--radius-lg); margin-bottom: var(--space-lg); box-shadow: var(--shadow-md);">
                            <p style="margin: 0; font-size: var(--font-size-sm); line-height: 1.6; opacity: 0.98; font-weight: 500;">
                                üí° <strong>Model Sensitivity Analysis</strong> ‚Äî How key metrics change with parameter variations. Two views: After-Tax Cash Flow per Person (Monthly impact) and Equity IRR (15-year return). Hover for details.
                            </p>
                        </div>
                        
                        <!-- Summary KPIs -->
                        <div class="kpi-grid" style="margin-bottom: var(--space-lg);">
                            <div class="kpi-card" style="background: linear-gradient(135deg, var(--accent) 0%, var(--secondary) 100%); border: none; color: white; padding: var(--space-lg); box-shadow: var(--shadow-md);">
                                <h3 style="color: rgba(255,255,255,0.95); font-size: var(--font-size-sm); font-weight: 600;">Base After-Tax Cash Flow (Monthly)</h3>
                                <div class="value" style="color: white; font-size: var(--font-size-2xl); font-weight: 700;">${formatCHF(baseATCF)}</div>
                                <div class="unit" style="font-size: var(--font-size-xs); color: rgba(255,255,255,0.8); margin-top: var(--space-xs);">per person/month</div>
                                <div class="unit" style="font-size: var(--font-size-xs); color: rgba(255,255,255,0.8); margin-top: var(--space-xs);">per person/year</div>
                            </div>
                            <div class="kpi-card" style="background: linear-gradient(135deg, var(--accent) 0%, var(--secondary) 100%); border: none; color: white; padding: var(--space-lg); box-shadow: var(--shadow-md);">
                                <h3 style="color: rgba(255,255,255,0.95); font-size: var(--font-size-sm); font-weight: 600;">Base Equity IRR</h3>
                                <div class="value" style="color: white; font-size: var(--font-size-2xl); font-weight: 700;">${baseIRR.toFixed(
                                  2,
                                )}%</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Parameters</h3>
                                <div class="value" style="color: var(--color-info);">${
                                  sensitivities.length
                                }</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Top ATCF Impact (Monthly)</h3>
                                <div class="value" style="color: var(--color-warning);">${formatCHF(
                                  sensitivitiesForATCF[0]?.impact_atcf || 0,
                                )}</div>
                                <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">${
                                  sensitivitiesForATCF[0]?.parameter || "N/A"
                                }</div>
                            </div>
                        </div>
                        
                        <!-- FIRST Tornado Chart: After-Tax Cash Flow per Person -->
                        <div class="chart-container" style="padding: var(--space-lg); margin-bottom: var(--space-xl);">
                            <h3 style="margin-bottom: var(--space-md); font-size: var(--font-size-xl); color: var(--primary); font-weight: 700;">
                                üìä Tornado Chart - Parameter Impact on Monthly After-Tax Cash Flow per Person
                            </h3>
                            <p style="color: var(--gray-500); margin-bottom: var(--space-md); font-size: var(--font-size-sm); line-height: 1.6;">
                                <span style="color: var(--color-positive); font-weight: 600;">‚ñ†</span> Green = higher cash flow | 
                                <span style="color: var(--color-negative); font-weight: 600;">‚ñ†</span> Red = lower cash flow | 
                                Hover for details
                            </p>
                            <div class="chart-wrapper" id="tornadoChartATCF" style="min-height: 500px; height: auto; overflow: visible;"></div>
                        </div>
                        
                        <!-- SECOND Tornado Chart: Equity IRR -->
                        <div class="chart-container" style="padding: var(--space-lg); margin-bottom: var(--space-xl);">
                            <h3 style="margin-bottom: var(--space-md); font-size: var(--font-size-xl); color: var(--primary); font-weight: 700;">
                                üìä Tornado Chart - Parameter Impact on Equity IRR
                            </h3>
                            <p style="color: var(--gray-500); margin-bottom: var(--space-md); font-size: var(--font-size-sm); line-height: 1.6;">
                                <span style="color: var(--color-positive); font-weight: 600;">‚ñ†</span> Green = better IRR | 
                                <span style="color: var(--color-negative); font-weight: 600;">‚ñ†</span> Red = worse IRR | 
                                Hover for details
                            </p>
                            <div class="chart-wrapper" id="tornadoChartIRR" style="min-height: 500px; height: auto; overflow: visible;"></div>
                        </div>
                        
                        <!-- Insights Panel -->
                        <div class="chart-container" style="background: linear-gradient(135deg, var(--gray-50), var(--gray-100)); border-left: 4px solid var(--accent); margin-bottom: var(--space-xl); box-shadow: var(--shadow-sm);">
                            <h3 style="margin-top: 0; color: var(--primary); font-size: var(--font-size-xl); font-weight: 700; margin-bottom: var(--space-md);">üîç Key Insights</h3>
                            <div class="kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
                                ${sensitivities
                                  .slice(0, 3)
                                  .map((sens, i) => {
                                    const info = parameterInfo[
                                      sens.parameter
                                    ] || { icon: "üìå", range: "N/A" };
                                    const isPositiveImpact =
                                      sens.high.irr > sens.low.irr;
                                    return `
                                        <div class="kpi-card" style="${i < 3 ? "border: 2px solid var(--warning); background: #fffbf0;" : ""}">
                                            <div style="font-size: 2em; margin-bottom: var(--space-sm);">${
                                              info.icon || "üìå"
                                            }</div>
                                            <div style="font-weight: 700; color: var(--secondary); margin-bottom: var(--space-sm); font-size: var(--font-size-base);">${
                                              i + 1
                                            }. ${sens.parameter}</div>
                                            <div style="font-size: var(--font-size-sm); color: var(--gray-700); line-height: 1.6;">
                                                <strong>Impact:</strong> ¬±${sens.impact.toFixed(
                                                  2,
                                                )}%<br>
                                                <strong>Range:</strong> ${
                                                  info.range
                                                }<br>
                                                ${
                                                  isPositiveImpact
                                                    ? '<strong style="color: var(--color-positive); font-size: var(--font-size-base);">‚Üë Higher values improve IRR</strong>'
                                                    : '<strong style="color: var(--color-negative); font-size: var(--font-size-base);">‚Üì Higher values reduce IRR</strong>'
                                                }
                                            </div>
                                        </div>
                                    `;
                                  })
                                  .join("")}
                            </div>
                        </div>
                        
                        <!-- Parameter Details Table -->
                        <div class="data-table" style="margin-top: var(--space-xl); clear: both;">
                            <h3 style="padding: var(--space-md); margin: 0; border-bottom: 3px solid var(--border); background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%); font-size: var(--font-size-xl); font-weight: 700; color: var(--primary);">
                                üìã Detailed Parameter Analysis
                            </h3>
                            <table style="font-size: var(--font-size-sm);">
                                <thead>
                                    <tr style="background: linear-gradient(135deg, var(--accent) 0%, var(--secondary) 100%); color: white;">
                                        <th style="text-align: left; padding: var(--space-sm) var(--space-md); font-size: var(--font-size-base); font-weight: 700;">Parameter</th>
                                        <th style="text-align: center; padding: var(--space-sm) var(--space-md); font-size: var(--font-size-base); font-weight: 700;">Base Value</th>
                                        <th style="text-align: center; padding: var(--space-sm) var(--space-md); font-size: var(--font-size-base); font-weight: 700;">Low Scenario</th>
                                        <th style="text-align: center; padding: var(--space-sm) var(--space-md); font-size: var(--font-size-base); font-weight: 700;">High Scenario</th>
                                        <th style="text-align: center; padding: var(--space-sm) var(--space-md); font-size: var(--font-size-base); font-weight: 700;">IRR Impact</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${sensitivities
                                      .map((sens, index) => {
                                        const info = parameterInfo[
                                          sens.parameter
                                        ] || { icon: "üìå" };
                                        // DYNAMIC COLOR LOGIC: Green if better, Red if worse
                                        const lowBetter =
                                          sens.low.irr > baseIRR;
                                        const highBetter =
                                          sens.high.irr > baseIRR;
                                        const lowBgColor = lowBetter
                                          ? "#f0fdf4"
                                          : "#fff5f5";
                                        const lowTextColor = lowBetter
                                          ? chartColors.positive
                                          : chartColors.negative;
                                        const highBgColor = highBetter
                                          ? "#f0fdf4"
                                          : "#fff5f5";
                                        const highTextColor = highBetter
                                          ? chartColors.positive
                                          : chartColors.negative;

                                        return `
                                        <tr style="border-bottom: 2px solid var(--gray-200); transition: background 0.2s; ${
                                          index < 3
                                            ? "background: #fffbf0;"
                                            : ""
                                        } ${index % 2 === 0 ? "" : "background-color: var(--gray-50);"}" onmouseover="this.style.background='var(--gray-100)'" onmouseout="this.style.background='${index < 3 ? "#fffbf0" : index % 2 === 0 ? "transparent" : "var(--gray-50)"}'">
                                            <td style="padding: var(--space-sm) var(--space-md); font-weight: 600; color: var(--primary);">
                                                <div style="font-size: var(--font-size-base);">
                                                    ${info.icon || ""} ${
                                                      sens.parameter
                                                    }
                                                </div>
                                            </td>
                                            <td style="text-align: center; padding: var(--space-sm) var(--space-md);">
                                                <strong style="font-size: var(--font-size-base);">${this.formatValue(
                                                  sens.base_value,
                                                  sens.parameter,
                                                )}</strong>
                                            </td>
                                            <td style="text-align: center; padding: var(--space-sm) var(--space-md); background: ${lowBgColor}; border-left: 3px solid ${lowTextColor};">
                                                <div style="font-size: var(--font-size-sm); margin-bottom: var(--space-xs);">${this.formatValue(
                                                  sens.low.value,
                                                  sens.parameter,
                                                )}</div>
                                                <div style="color: ${lowTextColor}; font-weight: bold; font-size: var(--font-size-lg); margin-bottom: var(--space-xs);">‚Üí ${sens.low.irr.toFixed(
                                                  2,
                                                )}%</div>
                                                <small style="color: var(--gray-500); font-size: var(--font-size-xs);">(${
                                                  sens.low.delta_irr >= 0
                                                    ? "+"
                                                    : ""
                                                }${sens.low.delta_irr.toFixed(
                                                  2,
                                                )}%)</small>
                                            </td>
                                            <td style="text-align: center; padding: var(--space-sm) var(--space-md); background: ${highBgColor}; border-left: 3px solid ${highTextColor};">
                                                <div style="font-size: var(--font-size-sm); margin-bottom: var(--space-xs);">${this.formatValue(
                                                  sens.high.value,
                                                  sens.parameter,
                                                )}</div>
                                                <div style="color: ${highTextColor}; font-weight: bold; font-size: var(--font-size-lg); margin-bottom: var(--space-xs);">‚Üí ${sens.high.irr.toFixed(
                                                  2,
                                                )}%</div>
                                                <small style="color: var(--gray-500); font-size: var(--font-size-xs);">(${
                                                  sens.high.delta_irr >= 0
                                                    ? "+"
                                                    : ""
                                                }${sens.high.delta_irr.toFixed(
                                                  2,
                                                )}%)</small>
                                            </td>
                                            <td style="text-align: center; padding: var(--space-sm) var(--space-md);">
                                                <div style="background: ${
                                                  index < 3
                                                    ? "var(--warning)"
                                                    : "var(--gray-200)"
                                                }; color: ${
                                                  index < 3
                                                    ? "white"
                                                    : "var(--gray-700)"
                                                }; padding: var(--space-sm) var(--space-md); border-radius: 25px; display: inline-block; font-weight: 700; font-size: var(--font-size-base); box-shadow: var(--shadow-sm);">
                                                    ¬±${sens.impact.toFixed(2)}%
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                      })
                                      .join("")}
                                </tbody>
                            </table>
                        </div>
                `;

          html += "</div>";
          content.innerHTML = html;

          // ============================================================
          // FIRST TORNADO CHART: After-Tax Cash Flow per Person
          // ============================================================
          if (sensitivitiesForATCF.length > 0) {
            const atcfParameters = [];
            const atcfLowValues = [];
            const atcfHighValues = [];
            const atcfCustomData = [];

            sensitivitiesForATCF.forEach((sens) => {
              if (
                sens.low?.atcf !== undefined &&
                sens.high?.atcf !== undefined
              ) {
                atcfParameters.push(sens.parameter);
                atcfLowValues.push((sens.low.atcf || 0) - baseATCF);
                atcfHighValues.push((sens.high.atcf || 0) - baseATCF);

                const info = parameterInfo[sens.parameter] || {
                  range: "N/A",
                  rationale: "No description available.",
                };
                atcfCustomData.push({
                  param: sens.parameter,
                  baseValue: this.formatValue(sens.base_value, sens.parameter),
                  lowValue: this.formatValue(sens.low.value, sens.parameter),
                  lowATCF: sens.low.atcf || 0,
                  lowATCFFormatted: formatCHF(sens.low.atcf || 0),
                  highValue: this.formatValue(sens.high.value, sens.parameter),
                  highATCF: sens.high.atcf || 0,
                  highATCFFormatted: formatCHF(sens.high.atcf || 0),
                  impact: sens.impact_atcf || 0,
                  range: info.range,
                  rationale: info.rationale,
                });
              }
            });

            // Determine colors based on whether result is better or worse than base
            const atcfLowColors = atcfLowValues.map((delta, i) => {
              const lowATCF = atcfCustomData[i].lowATCF;
              return lowATCF > baseATCF
                ? chartColors.positive
                : lowATCF < baseATCF
                  ? chartColors.negative
                  : chartColors.neutral;
            });

            const atcfHighColors = atcfHighValues.map((delta, i) => {
              const highATCF = atcfCustomData[i].highATCF;
              return highATCF > baseATCF
                ? chartColors.positive
                : highATCF < baseATCF
                  ? chartColors.negative
                  : chartColors.neutral;
            });

            // Low case bars
            const atcfTraceLow = {
              y: atcfParameters,
              x: atcfLowValues,
              name: "Low Value Scenario",
              type: "bar",
              orientation: "h",
              marker: {
                color: atcfLowColors,
                line: {
                  color: atcfLowColors.map((c) =>
                    c === chartColors.negative
                      ? "#c0392b"
                      : c === chartColors.positive
                        ? "#27ae60"
                        : "#7f8c8d",
                  ),
                  width: 1,
                },
              },
              customdata: atcfCustomData,
              hovertemplate:
                "<b>%{customdata.param}</b><br>" +
                "<br>" +
                "<b style='color:#ff6b6b;'>üìâ Low Value Scenario</b><br>" +
                "  Parameter: <b>%{customdata.lowValue}</b><br>" +
                "  Resulting ATCF (monthly): <b>%{customdata.lowATCFFormatted}</b><br>" +
                "  Change from Base: <b>%{x:+,.0f} CHF/month</b><br>" +
                "<br>" +
                "<b>üìä Tested Range:</b> %{customdata.range}<br>" +
                "<br>" +
                "<b>üí° Why this matters:</b><br>" +
                "%{customdata.rationale}<br>" +
                "<extra></extra>",
              hoverlabel: {
                bgcolor: "rgba(102, 126, 234, 0.98)",
                font: { size: 13, color: "white", family: "Segoe UI, Arial" },
                bordercolor: chartColors.base,
                borderwidth: 2,
                namelength: -1,
                align: "left",
                padding: 12,
              },
            };

            // High case bars
            const atcfTraceHigh = {
              y: atcfParameters,
              x: atcfHighValues,
              name: "High Value Scenario",
              type: "bar",
              orientation: "h",
              marker: {
                color: atcfHighColors,
                line: {
                  color: atcfHighColors.map((c) =>
                    c === chartColors.negative
                      ? "#c0392b"
                      : c === chartColors.positive
                        ? "#27ae60"
                        : "#7f8c8d",
                  ),
                  width: 1,
                },
              },
              customdata: atcfCustomData,
              hovertemplate:
                "<b>%{customdata.param}</b><br>" +
                "<br>" +
                "<b style='color:#51cf66;'>üìà High Value Scenario</b><br>" +
                "  Parameter: <b>%{customdata.highValue}</b><br>" +
                "  Resulting ATCF (monthly): <b>%{customdata.highATCFFormatted}</b><br>" +
                "  Change from Base: <b>%{x:+,.0f} CHF/month</b><br>" +
                "<br>" +
                "<b>üìä Tested Range:</b> %{customdata.range}<br>" +
                "<br>" +
                "<b>üí° Why this matters:</b><br>" +
                "%{customdata.rationale}<br>" +
                "<extra></extra>",
              hoverlabel: {
                bgcolor: "rgba(102, 126, 234, 0.98)",
                font: { size: 13, color: "white", family: "Segoe UI, Arial" },
                bordercolor: chartColors.base,
                borderwidth: 2,
                namelength: -1,
                align: "left",
                padding: 12,
              },
            };

            const atcfLayout = {
              ...unifiedChartConfig,
              barmode: "overlay",
              xaxis: {
                title: {
                  text: "Change in Monthly After-Tax Cash Flow per Person (CHF)",
                  font: { size: 15, color: "#2c3e50", family: "Segoe UI" },
                  standoff: 12,
                },
                zeroline: true,
                zerolinewidth: 3,
                zerolinecolor: chartColors.base,
                gridcolor: "#e0e4e7",
                gridwidth: 1,
                tickformat: "+,.0f",
                tickprefix: "CHF ",
                tickfont: { size: 13, color: "#5a6c7d" },
              },
              yaxis: {
                title: "",
                autorange: "reversed",
                tickfont: { size: 13, color: "#2c3e50", family: "Segoe UI" },
              },
              height: Math.max(500, 350 + atcfParameters.length * 45),
              annotations: [
                {
                  text: `<b>Base ATCF (monthly):</b> ${formatCHF(baseATCF)}`,
                  xref: "paper",
                  yref: "paper",
                  x: 0.01,
                  y: 0.99,
                  xanchor: "left",
                  yanchor: "top",
                  showarrow: false,
                  font: {
                    size: 13,
                    color: chartColors.base,
                    family: "Segoe UI",
                  },
                  bgcolor: "rgba(255,255,255,0.95)",
                  bordercolor: chartColors.base,
                  borderwidth: 2,
                  borderpad: 6,
                },
                // Add annotations at the ends of bars showing final values
                ...atcfParameters
                  .map((param, i) => {
                    const lowATCF = atcfCustomData[i].lowATCF;
                    const highATCF = atcfCustomData[i].highATCF;
                    const lowX = atcfLowValues[i];
                    const highX = atcfHighValues[i];

                    return [
                      // Left side annotation (low value)
                      {
                        x: lowX,
                        y: param,
                        text: formatCHF(lowATCF),
                        xref: "x",
                        yref: "y",
                        xanchor: lowX < 0 ? "right" : "left",
                        yanchor: "middle",
                        showarrow: false,
                        font: {
                          size: 11,
                          color:
                            atcfLowColors[i] === chartColors.positive
                              ? "#1e7e34"
                              : atcfLowColors[i] === chartColors.negative
                                ? "#c82333"
                                : "#495057",
                          family: "Segoe UI",
                          weight: "bold",
                        },
                        bgcolor: "rgba(255,255,255,0.9)",
                        bordercolor:
                          atcfLowColors[i] === chartColors.positive
                            ? "#28a745"
                            : atcfLowColors[i] === chartColors.negative
                              ? "#dc3545"
                              : "#6c757d",
                        borderwidth: 1.5,
                        borderpad: 4,
                        xshift: lowX < 0 ? -8 : 8,
                      },
                      // Right side annotation (high value)
                      {
                        x: highX,
                        y: param,
                        text: formatCHF(highATCF),
                        xref: "x",
                        yref: "y",
                        xanchor: highX < 0 ? "right" : "left",
                        yanchor: "middle",
                        showarrow: false,
                        font: {
                          size: 11,
                          color:
                            atcfHighColors[i] === chartColors.positive
                              ? "#1e7e34"
                              : atcfHighColors[i] === chartColors.negative
                                ? "#c82333"
                                : "#495057",
                          family: "Segoe UI",
                          weight: "bold",
                        },
                        bgcolor: "rgba(255,255,255,0.9)",
                        bordercolor:
                          atcfHighColors[i] === chartColors.positive
                            ? "#28a745"
                            : atcfHighColors[i] === chartColors.negative
                              ? "#dc3545"
                              : "#6c757d",
                        borderwidth: 1.5,
                        borderpad: 4,
                        xshift: highX < 0 ? -8 : 8,
                      },
                    ];
                  })
                  .flat(),
              ],
            };

            Plotly.newPlot(
              "tornadoChartATCF",
              [atcfTraceLow, atcfTraceHigh],
              atcfLayout,
              {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ["lasso2d", "select2d"],
                displaylogo: false,
              },
            ).then(() => {
              const chartDiv = document.getElementById("tornadoChartATCF");
              if (chartDiv && chartDiv.layout) {
                chartDiv.style.height = atcfLayout.height + "px";
                chartDiv.style.minHeight = atcfLayout.height + "px";
                chartDiv.style.overflow = "visible";
              }
            });
          }

          // ============================================================
          // SECOND TORNADO CHART: Equity IRR
          // ============================================================
          if (sensitivitiesForIRR.length > 0) {
            // Prepare data
            const parameters = [];
            const lowValues = [];
            const highValues = [];
            const customData = [];

            sensitivitiesForIRR.forEach((sens) => {
              parameters.push(sens.parameter);
              lowValues.push(sens.low.irr - baseIRR);
              highValues.push(sens.high.irr - baseIRR);

              const info = parameterInfo[sens.parameter] || {
                range: "N/A",
                rationale: "No description available.",
              };
              customData.push({
                param: sens.parameter,
                baseValue: this.formatValue(sens.base_value, sens.parameter),
                lowValue: this.formatValue(sens.low.value, sens.parameter),
                lowIRR: sens.low.irr,
                highValue: this.formatValue(sens.high.value, sens.parameter),
                highIRR: sens.high.irr,
                impact: sens.impact,
                range: info.range,
                rationale: info.rationale,
              });
            });

            // Determine colors based on whether result is better or worse than base
            // Red = worse IRR, Green = better IRR (regardless of which side of zero)
            const lowColors = lowValues.map((delta, i) => {
              const lowIRR = customData[i].lowIRR;
              const highIRR = customData[i].highIRR;
              // Low value produces lower IRR ‚Üí red (worse)
              // Low value produces higher IRR ‚Üí green (better, counterintuitive)
              return lowIRR < baseIRR
                ? chartColors.negative
                : lowIRR > baseIRR
                  ? chartColors.positive
                  : chartColors.neutral;
            });

            const highColors = highValues.map((delta, i) => {
              const lowIRR = customData[i].lowIRR;
              const highIRR = customData[i].highIRR;
              // High value produces higher IRR ‚Üí green (better)
              // High value produces lower IRR ‚Üí red (worse, counterintuitive)
              return highIRR > baseIRR
                ? chartColors.positive
                : highIRR < baseIRR
                  ? chartColors.negative
                  : chartColors.neutral;
            });

            // Low case bars
            const traceLow = {
              y: parameters,
              x: lowValues,
              name: "Low Value Scenario",
              type: "bar",
              orientation: "h",
              marker: {
                color: lowColors,
                line: {
                  color: lowColors.map((c) =>
                    c === chartColors.negative
                      ? "#c0392b"
                      : c === chartColors.positive
                        ? "#27ae60"
                        : "#7f8c8d",
                  ),
                  width: 1,
                },
              },
              customdata: customData,
              hovertemplate:
                "<b>%{customdata.param}</b><br>" +
                "<br>" +
                "<b style='color:#ff6b6b;'>üìâ Low Value Scenario</b><br>" +
                "  Parameter: <b>%{customdata.lowValue}</b><br>" +
                "  Resulting IRR: <b>%{customdata.lowIRR:.2f}%</b><br>" +
                "  Change from Base: <b>%{x:+.2f}%</b><br>" +
                "<br>" +
                "<b>üìä Tested Range:</b> %{customdata.range}<br>" +
                "<br>" +
                "<b>üí° Why this matters:</b><br>" +
                "%{customdata.rationale}<br>" +
                "<extra></extra>",
              hoverlabel: {
                bgcolor: "rgba(102, 126, 234, 0.98)",
                font: { size: 13, color: "white", family: "Segoe UI, Arial" },
                bordercolor: chartColors.base,
                borderwidth: 2,
                namelength: -1,
                align: "left",
                padding: 12,
              },
            };

            // High case bars
            const traceHigh = {
              y: parameters,
              x: highValues,
              name: "High Value Scenario",
              type: "bar",
              orientation: "h",
              marker: {
                color: highColors,
                line: {
                  color: highColors.map((c) =>
                    c === chartColors.negative
                      ? "#c0392b"
                      : c === chartColors.positive
                        ? "#27ae60"
                        : "#7f8c8d",
                  ),
                  width: 1,
                },
              },
              customdata: customData,
              hovertemplate:
                "<b>%{customdata.param}</b><br>" +
                "<br>" +
                "<b style='color:#51cf66;'>üìà High Value Scenario</b><br>" +
                "  Parameter: <b>%{customdata.highValue}</b><br>" +
                "  Resulting IRR: <b>%{customdata.highIRR:.2f}%</b><br>" +
                "  Change from Base: <b>%{x:+.2f}%</b><br>" +
                "<br>" +
                "<b>üìä Tested Range:</b> %{customdata.range}<br>" +
                "<br>" +
                "<b>üí° Why this matters:</b><br>" +
                "%{customdata.rationale}<br>" +
                "<extra></extra>",
              hoverlabel: {
                bgcolor: "rgba(102, 126, 234, 0.98)",
                font: { size: 13, color: "white", family: "Segoe UI, Arial" },
                bordercolor: chartColors.base,
                borderwidth: 2,
                namelength: -1,
                align: "left",
                padding: 12,
              },
            };

            const layout = {
              ...unifiedChartConfig,
              barmode: "overlay",
              xaxis: {
                title: {
                  text: "Change in Equity IRR (%)",
                  font: { size: 15, color: "#2c3e50", family: "Segoe UI" },
                  standoff: 12,
                },
                zeroline: true,
                zerolinewidth: 3,
                zerolinecolor: chartColors.base,
                gridcolor: "#e0e4e7",
                gridwidth: 1,
                tickfont: { size: 13, color: "#5a6c7d" },
              },
              yaxis: {
                title: "",
                autorange: "reversed",
                tickfont: { size: 13, color: "#2c3e50", family: "Segoe UI" },
              },
              height: Math.max(500, 350 + sensitivitiesForIRR.length * 45),
              annotations: [
                {
                  text: `<b>Base IRR:</b> ${baseIRR.toFixed(2)}%`,
                  xref: "paper",
                  yref: "paper",
                  x: 0.01,
                  y: 0.99,
                  xanchor: "left",
                  yanchor: "top",
                  showarrow: false,
                  font: {
                    size: 13,
                    color: chartColors.base,
                    family: "Segoe UI",
                  },
                  bgcolor: "rgba(255,255,255,0.95)",
                  bordercolor: chartColors.base,
                  borderwidth: 2,
                  borderpad: 6,
                },
                // Add annotations at the ends of bars showing final IRR values
                ...parameters
                  .map((param, i) => {
                    const lowIRR = customData[i].lowIRR;
                    const highIRR = customData[i].highIRR;
                    const lowX = lowValues[i];
                    const highX = highValues[i];

                    return [
                      // Left side annotation (low value)
                      {
                        x: lowX,
                        y: param,
                        text: `${lowIRR.toFixed(2)}%`,
                        xref: "x",
                        yref: "y",
                        xanchor: lowX < 0 ? "right" : "left",
                        yanchor: "middle",
                        showarrow: false,
                        font: {
                          size: 11,
                          color:
                            lowColors[i] === chartColors.positive
                              ? "#1e7e34"
                              : lowColors[i] === chartColors.negative
                                ? "#c82333"
                                : "#495057",
                          family: "Segoe UI",
                          weight: "bold",
                        },
                        bgcolor: "rgba(255,255,255,0.9)",
                        bordercolor:
                          lowColors[i] === chartColors.positive
                            ? "#28a745"
                            : lowColors[i] === chartColors.negative
                              ? "#dc3545"
                              : "#6c757d",
                        borderwidth: 1.5,
                        borderpad: 4,
                        xshift: lowX < 0 ? -8 : 8,
                      },
                      // Right side annotation (high value)
                      {
                        x: highX,
                        y: param,
                        text: `${highIRR.toFixed(2)}%`,
                        xref: "x",
                        yref: "y",
                        xanchor: highX < 0 ? "right" : "left",
                        yanchor: "middle",
                        showarrow: false,
                        font: {
                          size: 11,
                          color:
                            highColors[i] === chartColors.positive
                              ? "#1e7e34"
                              : highColors[i] === chartColors.negative
                                ? "#c82333"
                                : "#495057",
                          family: "Segoe UI",
                          weight: "bold",
                        },
                        bgcolor: "rgba(255,255,255,0.9)",
                        bordercolor:
                          highColors[i] === chartColors.positive
                            ? "#28a745"
                            : highColors[i] === chartColors.negative
                              ? "#dc3545"
                              : "#6c757d",
                        borderwidth: 1.5,
                        borderpad: 4,
                        xshift: highX < 0 ? -8 : 8,
                      },
                    ];
                  })
                  .flat(),
              ],
            };

            Plotly.newPlot("tornadoChartIRR", [traceLow, traceHigh], layout, {
              responsive: true,
              displayModeBar: true,
              modeBarButtonsToRemove: ["lasso2d", "select2d"],
              displaylogo: false,
            }).then(() => {
              // Force the chart container to respect its height
              const chartDiv = document.getElementById("tornadoChartIRR");
              if (chartDiv && chartDiv.layout) {
                chartDiv.style.height = layout.height + "px";
                chartDiv.style.minHeight = layout.height + "px";
                chartDiv.style.overflow = "visible";
              }
            });
          }
        },

        // Helper function to format values based on parameter type
        formatValue(value, parameter) {
          // Handle currency values first (before percentage check)
          if (
            parameter.includes("Price") ||
            parameter.includes("Cost") ||
            parameter.includes("Average Daily Rate") ||
            parameter.includes("Daily Rate")
          ) {
            return (
              "CHF " +
              value.toLocaleString("en-US", { maximumFractionDigits: 0 })
            );
          }
          // Handle percentage-based parameters (Interest Rate, Occupancy Rate, etc.)
          else if (
            parameter.includes("Rate") ||
            parameter.includes("LTV") ||
            parameter.includes("Fee") ||
            parameter.includes("Occupancy")
          ) {
            return (value * 100).toFixed(2) + "%";
          }
          // Handle nights/days
          else if (parameter.includes("Stay")) {
            return value.toFixed(1) + " nights";
          }
          // Default: 2 decimal places
          else {
            return value.toFixed(2);
          }
        },

        renderSensitivityCoC(data) {
          const content = document.getElementById("contentArea");
          const sensitivities = data.sensitivities || [];
          const baseCoC = data.base_coc || 0;
          const chartColors = unifiedChartConfig.colors;

          // Parameter explanations
          const parameterInfo = {
            "Interest Rate": {
              range: "0.3% to 2.3% (¬±1%)",
              rationale:
                "Interest rate has HUGE impact on cash flow. Lower rates = better cash-on-cash. With leverage, even 0.5% difference matters significantly for Year 1 cash yield.",
              icon: "üìä",
            },
            "Amortization Rate": {
              range: "0% (interest-only) to 2%",
              rationale:
                "Amortization directly reduces cash flow. Interest-only (0%) maximizes Year 1 cash but keeps debt higher. 2% amortization improves equity but hurts cash flow by CHF 6,000/year.",
              icon: "üí∞",
            },
            "Average Daily Rate": {
              range: "CHF 160 to 240 (¬±20%)",
              rationale:
                "Pricing strategy directly impacts revenue and thus cash flow. 20% rate increase can turn negative CoC into positive. Dynamic pricing is crucial.",
              icon: "üíµ",
            },
            "Maintenance Reserve Rate": {
              range: "0% to 1% of property value",
              rationale:
                "Maintenance reserve is a large annual expense. Going from 0.3% to 0% saves CHF 3,900/year = CHF 975 per owner. But may defer needed work.",
              icon: "üîß",
            },
            "Loan-to-Value (LTV)": {
              range: "67.5% to 82.5% (¬±10%)",
              rationale:
                "Higher LTV = less equity needed BUT more debt service. This creates a trade-off: higher LTV hurts cash-on-cash but requires less upfront capital.",
              icon: "üè¶",
            },
            "Average Length of Stay": {
              range: "1.19 to 2.21 nights (¬±30%)",
              rationale:
                "Longer stays = fewer turnovers = lower cleaning costs = better cash flow. Encouraging 3+ night stays can meaningfully improve CoC.",
              icon: "üìÖ",
            },
            "Cleaning Cost per Stay": {
              range: "CHF 49 to 91 (¬±30%)",
              rationale:
                "With ~130 turnovers/year, cleaning is a major expense. Negotiating from CHF 80 to CHF 60 saves CHF 2,600/year.",
              icon: "üßπ",
            },
            "Occupancy Rate": {
              range: "56.7% to 69.3% (¬±10%)",
              rationale:
                "Higher occupancy = more revenue = better cash flow. Every 1% occupancy increase adds ~CHF 700 revenue.",
              icon: "üìà",
            },
            "Property Management Fee": {
              range: "15% to 25% (¬±5%)",
              rationale:
                "Management fees are % of revenue. Lower fees = better cash flow.",
              icon: "üè¢",
            },
            "Winter Season Occupancy": {
              range: "63.75% to 86.25% (¬±15%)",
              rationale:
                "Premium ski season. Higher winter occupancy = more high-rate revenue.",
              icon: "‚õ∑Ô∏è",
            },
            "Purchase Price": {
              range: "CHF 1.17M to 1.43M (¬±10%)",
              rationale: "Higher price = more equity needed = worse CoC yield.",
              icon: "üè†",
            },
            "Insurance Rate": {
              range: "0.3% to 0.5% of property value",
              rationale:
                "Annual insurance costs. Lower rates = better cash flow.",
              icon: "üõ°Ô∏è",
            },
            "Property Appreciation Rate": {
              range: "1.5% to 3.5%",
              rationale: "Doesn't affect Year 1 cash flow. Zero impact on CoC.",
              icon: "üìà",
            },
            "Inflation Rate": {
              range: "0.5% to 1.5%",
              rationale: "Doesn't affect Year 1 cash flow. Zero impact on CoC.",
              icon: "üìä",
            },
            "Selling Costs Rate": {
              range: "5.8% to 9.8% (¬±2%)",
              rationale:
                "Transaction costs at property sale (Year 15). Doesn't affect Year 1 cash flow - only matters for long-term returns when property is eventually sold. Includes broker, notary, and transfer tax.",
              icon: "üìù",
            },
          };

          let html = `
            <div class="section">
              <h2 class="section-title">üí∞ Model Sensitivity - Cash-on-Cash Analysis</h2>
              
              <!-- Info Box -->
              <div style="background: linear-gradient(135deg, var(--accent) 0%, var(--secondary) 100%); color: white; padding: var(--space-md) var(--space-lg); border-radius: var(--radius-lg); margin-bottom: var(--space-lg); box-shadow: var(--shadow-md);">
                <p style="margin: 0; font-size: var(--font-size-sm); line-height: 1.6; opacity: 0.98; font-weight: 500;">
                  üí° <strong>Cash-on-Cash = Year 1 Cash / Equity</strong> ‚Äî First year cash yield like a bond. Ignores appreciation. Hover for details.
                </p>
              </div>
              
              <!-- Summary KPIs -->
              <div class="kpi-grid" style="margin-bottom: var(--space-lg);">
                <div class="kpi-card" style="background: linear-gradient(135deg, var(--accent) 0%, var(--secondary) 100%); border: none; color: white; padding: var(--space-lg); box-shadow: var(--shadow-md);">
                  <h3 style="color: rgba(255,255,255,0.95); font-size: var(--font-size-sm); font-weight: 600;">Base CoC</h3>
                  <div class="value" style="color: white; font-size: var(--font-size-2xl); font-weight: 700;">${baseCoC.toFixed(
                    2,
                  )}%</div>
                </div>
                <div class="kpi-card">
                  <h3>Parameters</h3>
                  <div class="value" style="color: var(--color-info);">${
                    sensitivities.length
                  }</div>
                </div>
                <div class="kpi-card">
                  <h3>Top Impact</h3>
                  <div class="value" style="color: var(--color-warning);">¬±${(
                    sensitivities[0]?.impact || 0
                  ).toFixed(2)}%</div>
                  <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">${
                    sensitivities[0]?.parameter || "N/A"
                  }</div>
                </div>
                <div class="kpi-card">
                  <h3>CoC Range</h3>
                  <div class="value" style="color: var(--color-positive); font-size: var(--font-size-xl);">${Math.min(
                    ...sensitivities
                      .filter((s) => s.impact > 0)
                      .map((s) => Math.min(s.low.irr, s.high.irr)),
                  ).toFixed(1)}% - ${Math.max(
                    ...sensitivities
                      .filter((s) => s.impact > 0)
                      .map((s) => Math.max(s.low.irr, s.high.irr)),
                  ).toFixed(1)}%</div>
                </div>
              </div>
              
              <!-- Tornado Chart -->
              <div class="chart-container">
                <h3>üìä Tornado Chart - Impact on Year 1 Cash Yield</h3>
                <p style="color: var(--gray-500); margin-bottom: var(--space-md); font-size: var(--font-size-sm); line-height: 1.6;">
                  <span style="color: var(--color-positive); font-weight: 600;">‚ñ†</span> Green = better CoC | 
                  <span style="color: var(--color-negative); font-weight: 600;">‚ñ†</span> Red = worse CoC | 
                  Hover for details
                </p>
                <div class="chart-wrapper" id="tornadoChartCoC" style="min-height: 500px; height: auto; overflow: visible;"></div>
              </div>
              
              <!-- Spacer -->
              <div style="clear: both; height: 20px;"></div>
              
              <!-- Insights Panel -->
              <div class="chart-container" style="background: linear-gradient(135deg, var(--gray-50), var(--gray-100)); border-left: 4px solid var(--accent);">
                <h3 style="margin-top: 0; color: var(--primary); font-size: var(--font-size-xl); font-weight: 700; margin-bottom: var(--space-md);">üîç Key Cash Flow Insights</h3>
                <div class="kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                  ${sensitivities
                    .filter((s) => s.impact > 0)
                    .slice(0, 3)
                    .map((sens, i) => {
                      const info = parameterInfo[sens.parameter] || {
                        icon: "üìå",
                        range: "N/A",
                      };
                      return `
                      <div class="kpi-card" style="${i < 3 ? "border: 2px solid var(--warning); background: #fffbf0;" : ""}">
                        <div style="font-size: 2em; margin-bottom: var(--space-sm);">${
                          info.icon || "üìå"
                        }</div>
                        <div style="font-weight: 700; color: var(--secondary); margin-bottom: var(--space-sm); font-size: var(--font-size-base);">${
                          i + 1
                        }. ${sens.parameter}</div>
                        <div style="font-size: var(--font-size-sm); color: var(--gray-700); line-height: 1.6;">
                          <strong>Impact:</strong> ¬±${sens.impact.toFixed(
                            2,
                          )}%<br>
                          <strong>Range:</strong> ${info.range}<br>
                          <strong style="color: ${
                            sens.high.irr > sens.low.irr
                              ? "var(--color-positive)"
                              : "var(--color-negative)"
                          }; font-size: var(--font-size-base);">
                            ${
                              sens.high.irr > sens.low.irr
                                ? "‚Üë Higher values improve CoC"
                                : "‚Üì Higher values reduce CoC"
                            }
                          </strong>
                        </div>
                      </div>
                    `;
                    })
                    .join("")}
                </div>
              </div>
              
              <!-- Parameter Details Table -->
              <div class="data-table" style="margin-top: var(--space-xl); clear: both;">
                <h3 style="padding: var(--space-md); margin: 0; border-bottom: 3px solid var(--border); background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%); font-size: var(--font-size-xl); font-weight: 700; color: var(--primary);">
                  üìã Detailed Cash-on-Cash Analysis
                </h3>
                <table style="font-size: var(--font-size-sm);">
                  <thead>
                    <tr style="background: linear-gradient(135deg, var(--accent) 0%, var(--secondary) 100%); color: white;">
                      <th style="text-align: left; padding: var(--space-sm) var(--space-md); font-size: var(--font-size-base); font-weight: 700;">Parameter</th>
                      <th style="text-align: center; padding: var(--space-sm) var(--space-md); font-size: var(--font-size-base); font-weight: 700;">Base Value</th>
                      <th style="text-align: center; padding: var(--space-sm) var(--space-md); font-size: var(--font-size-base); font-weight: 700;">Low Scenario</th>
                      <th style="text-align: center; padding: var(--space-sm) var(--space-md); font-size: var(--font-size-base); font-weight: 700;">High Scenario</th>
                      <th style="text-align: center; padding: var(--space-sm) var(--space-md); font-size: var(--font-size-base); font-weight: 700;">CoC Impact</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${sensitivities
                      .map((sens, index) => {
                        const info = parameterInfo[sens.parameter] || {
                          icon: "üìå",
                        };
                        const hasImpact = sens.impact > 0.01;
                        // DYNAMIC COLOR LOGIC: Green if better, Red if worse
                        const lowBetter = sens.low.irr > baseCoC;
                        const highBetter = sens.high.irr > baseCoC;
                        const lowBgColor = lowBetter ? "#f0fdf4" : "#fff5f5";
                        const lowTextColor = lowBetter ? "#27ae60" : "#c0392b";
                        const highBgColor = highBetter ? "#f0fdf4" : "#fff5f5";
                        const highTextColor = highBetter
                          ? "#27ae60"
                          : "#c0392b";

                        return `
                      <tr style="border-bottom: 2px solid var(--gray-200); transition: background 0.2s; ${
                        index < 3 ? "background: #fffbf0;" : ""
                      } ${!hasImpact ? "opacity: 0.5;" : ""} ${index % 2 === 0 ? "" : "background-color: var(--gray-50);"}" onmouseover="this.style.background='var(--gray-100)'" onmouseout="this.style.background='${index < 3 ? "#fffbf0" : index % 2 === 0 ? "transparent" : "var(--gray-50)"}'">
                        <td style="padding: var(--space-sm) var(--space-md); font-weight: 600; color: var(--primary);">
                          <div style="font-size: var(--font-size-base);">
                            ${info.icon || ""} ${sens.parameter}
                          </div>
                          ${
                            !hasImpact
                              ? '<small style="color: var(--gray-500); font-size: var(--font-size-xs);">(No Year 1 impact)</small>'
                              : ""
                          }
                        </td>
                        <td style="text-align: center; padding: var(--space-sm) var(--space-md);">
                          <strong style="font-size: var(--font-size-base);">${this.formatValue(
                            sens.base_value,
                            sens.parameter,
                          )}</strong>
                        </td>
                        <td style="text-align: center; padding: var(--space-sm) var(--space-md); background: ${lowBgColor}; border-left: 3px solid ${lowTextColor};">
                          <div style="font-size: var(--font-size-sm); margin-bottom: var(--space-xs);">${this.formatValue(
                            sens.low.value,
                            sens.parameter,
                          )}</div>
                          <div style="color: ${lowTextColor}; font-weight: bold; font-size: var(--font-size-lg); margin-bottom: var(--space-xs);">‚Üí ${sens.low.irr.toFixed(
                            2,
                          )}%</div>
                          <small style="color: var(--gray-500); font-size: var(--font-size-xs);">(${
                            sens.low.delta_irr >= 0 ? "+" : ""
                          }${sens.low.delta_irr.toFixed(2)}%)</small>
                        </td>
                        <td style="text-align: center; padding: var(--space-sm) var(--space-md); background: ${highBgColor}; border-left: 3px solid ${highTextColor};">
                          <div style="font-size: var(--font-size-sm); margin-bottom: var(--space-xs);">${this.formatValue(
                            sens.high.value,
                            sens.parameter,
                          )}</div>
                          <div style="color: ${highTextColor}; font-weight: bold; font-size: var(--font-size-lg); margin-bottom: var(--space-xs);">‚Üí ${sens.high.irr.toFixed(
                            2,
                          )}%</div>
                          <small style="color: var(--gray-500); font-size: var(--font-size-xs);">(${
                            sens.high.delta_irr >= 0 ? "+" : ""
                          }${sens.high.delta_irr.toFixed(2)}%)</small>
                        </td>
                        <td style="text-align: center; padding: var(--space-sm) var(--space-md);">
                          <div style="background: ${
                            index < 3 ? "var(--accent)" : "var(--gray-200)"
                          }; color: ${
                            index < 3 ? "white" : "var(--gray-700)"
                          }; padding: var(--space-sm) var(--space-md); border-radius: 25px; display: inline-block; font-weight: 700; font-size: var(--font-size-base); box-shadow: var(--shadow-sm);">
                            ¬±${sens.impact.toFixed(2)}%
                          </div>
                        </td>
                      </tr>
                    `;
                      })
                      .join("")}
                  </tbody>
                </table>
              </div>
          `;

          html += "</div>";
          content.innerHTML = html;

          // Render tornado chart (filter out zero-impact parameters)
          const meaningfulSensitivities = sensitivities.filter(
            (s) => s.impact > 0.01,
          );

          if (meaningfulSensitivities.length > 0) {
            const parameters = [];
            const lowValues = [];
            const highValues = [];
            const customData = [];

            meaningfulSensitivities.forEach((sens) => {
              parameters.push(sens.parameter);
              lowValues.push(sens.low.irr - baseCoC);
              highValues.push(sens.high.irr - baseCoC);

              const info = parameterInfo[sens.parameter] || {
                range: "N/A",
                rationale: "No description available.",
              };
              customData.push({
                param: sens.parameter,
                baseValue: sens.base_value,
                lowValue: sens.low.value,
                lowCoC: sens.low.irr,
                highValue: sens.high.value,
                highCoC: sens.high.irr,
                impact: sens.impact,
                range: info.range,
                rationale: info.rationale,
              });
            });

            // Color bars based on whether result is better or worse
            const lowColors = lowValues.map((delta, i) => {
              const lowCoC = customData[i].lowCoC;
              return lowCoC < baseCoC
                ? chartColors.negative
                : lowCoC > baseCoC
                  ? chartColors.positive
                  : chartColors.neutral;
            });

            const highColors = highValues.map((delta, i) => {
              const highCoC = customData[i].highCoC;
              return highCoC > baseCoC
                ? chartColors.positive
                : highCoC < baseCoC
                  ? chartColors.negative
                  : chartColors.neutral;
            });

            const traceLow = {
              y: parameters,
              x: lowValues,
              name: "Pessimistic Scenario",
              type: "bar",
              orientation: "h",
              marker: {
                color: lowColors,
                line: { color: chartColors.base, width: 1.5 },
              },
              customdata: customData,
              hovertemplate:
                "<b>%{customdata.param}</b><br>" +
                "<br>" +
                "<b style='color:#ff6b6b;'>üìâ Pessimistic Scenario</b><br>" +
                "  Parameter Value: <b>%{customdata.lowValue}</b><br>" +
                "  Resulting Cash-on-Cash: <b>%{customdata.lowCoC:.2f}%</b><br>" +
                "  Change from Base: <b>%{x:+.2f}%</b><br>" +
                "<br>" +
                "<b>üìä Sensitivity Range:</b> %{customdata.range}<br>" +
                "<br>" +
                "<b>üí° Why This Matters:</b><br>" +
                "%{customdata.rationale}<br>" +
                "<extra></extra>",
              hoverlabel: {
                bgcolor: "rgba(102, 126, 234, 0.98)",
                font: { size: 13, color: "white", family: "Segoe UI, Arial" },
                bordercolor: chartColors.base,
                borderwidth: 2,
                namelength: -1,
                align: "left",
                padding: 12,
              },
            };

            const traceHigh = {
              y: parameters,
              x: highValues,
              name: "Optimistic Scenario",
              type: "bar",
              orientation: "h",
              marker: {
                color: highColors,
                line: { color: chartColors.base, width: 1.5 },
              },
              customdata: customData,
              hovertemplate:
                "<b>%{customdata.param}</b><br>" +
                "<br>" +
                "<b style='color:#51cf66;'>üìà Optimistic Scenario</b><br>" +
                "  Parameter Value: <b>%{customdata.highValue}</b><br>" +
                "  Resulting Cash-on-Cash: <b>%{customdata.highCoC:.2f}%</b><br>" +
                "  Change from Base: <b>%{x:+.2f}%</b><br>" +
                "<br>" +
                "<b>üìä Sensitivity Range:</b> %{customdata.range}<br>" +
                "<br>" +
                "<b>üí° Why This Matters:</b><br>" +
                "%{customdata.rationale}<br>" +
                "<extra></extra>",
              hoverlabel: {
                bgcolor: "rgba(102, 126, 234, 0.98)",
                font: { size: 13, color: "white", family: "Segoe UI, Arial" },
                bordercolor: chartColors.base,
                borderwidth: 2,
                namelength: -1,
                align: "left",
                padding: 12,
              },
            };

            const layout = {
              ...unifiedChartConfig,
              barmode: "overlay",
              xaxis: {
                title: {
                  text: "Change in Cash-on-Cash (%)",
                  font: { size: 15, color: "#2c3e50", family: "Segoe UI" },
                  standoff: 12,
                },
                zeroline: true,
                zerolinewidth: 3,
                zerolinecolor: chartColors.base,
                gridcolor: "#e0e4e7",
                gridwidth: 1,
                tickfont: { size: 13, color: "#5a6c7d" },
              },
              yaxis: {
                title: "",
                autorange: "reversed",
                tickfont: { size: 13, color: "#2c3e50", family: "Segoe UI" },
              },
              height: Math.max(500, 350 + meaningfulSensitivities.length * 45),
              annotations: [
                {
                  text: `<b>Base CoC:</b> ${baseCoC.toFixed(2)}%`,
                  xref: "paper",
                  yref: "paper",
                  x: 0.01,
                  y: 0.99,
                  xanchor: "left",
                  yanchor: "top",
                  showarrow: false,
                  font: {
                    size: 13,
                    color: chartColors.base,
                    family: "Segoe UI",
                  },
                  bgcolor: "rgba(255,255,255,0.95)",
                  bordercolor: chartColors.base,
                  borderwidth: 2,
                  borderpad: 6,
                },
              ],
            };

            Plotly.newPlot("tornadoChartCoC", [traceLow, traceHigh], layout, {
              responsive: true,
              displayModeBar: true,
              modeBarButtonsToRemove: ["lasso2d", "select2d"],
              displaylogo: false,
            }).then(() => {
              const chartDiv = document.getElementById("tornadoChartCoC");
              if (chartDiv && chartDiv.layout) {
                chartDiv.style.height = layout.height + "px";
                chartDiv.style.minHeight = layout.height + "px";
                chartDiv.style.overflow = "visible";
              }
            });
          }
        },

        // =============================================================
        // SENSITIVITY ANALYSIS - MONTHLY NET CASH FLOW PER OWNER
        // =============================================================
        renderSensitivityNCF(data) {
          const content = document.getElementById("contentArea");
          const sensitivities = data.sensitivities || [];
          const baseNCF = data.base_ncf || 0;
          const chartColors = unifiedChartConfig.colors;

          // Parameter info for NCF sensitivity
          const parameterInfo = {
            "Purchase Price": {
              range: "CHF 1.275M to 1.725M (¬±15%)",
              rationale:
                "Higher purchase price means more debt and higher mortgage payments, directly reducing monthly cash flow. Negotiating down CHF 50k = CHF 8/month savings per owner.",
              icon: "üè†",
            },
            "Interest Rate": {
              range: "0.3% to 2.3% (¬±1%)",
              rationale:
                "Interest rate directly impacts monthly mortgage cost. Each 0.5% change = ~CHF 150/month per owner difference. Critical for cash flow planning.",
              icon: "üìà",
            },
            "Average Daily Rate": {
              range: "CHF 129.5 to 175.5 (¬±15%)",
              rationale:
                "Higher daily rates increase gross revenue proportionally. A CHF 20/night increase generates ~CHF 2,900 extra annually = ~CHF 60/month per owner.",
              icon: "üí∞",
            },
            "Occupancy Rate": {
              range: "52.7% to 71.3% (Winter avg ¬±15%)",
              rationale:
                "Higher occupancy means more rental nights. 5% higher occupancy = ~CHF 3,650 more revenue = ~CHF 76/month per owner after expenses.",
              icon: "üõèÔ∏è",
            },
            "Maintenance Reserve Rate": {
              range: "0.25% to 0.75% of property value",
              rationale:
                "Maintenance reserve affects monthly cash flow directly. At 0.3%, this is ~CHF 325/month total = CHF 81/month per owner set aside.",
              icon: "üîß",
            },
            "Management Fee Rate": {
              range: "18% to 22% of rental income",
              rationale:
                "Management fees are a percentage of gross rental income. At 20%, this is ~CHF 10k/year = CHF 208/month per owner.",
              icon: "üëî",
            },
            "Loan-to-Value (LTV)": {
              range: "67.5% to 82.5% (¬±10%)",
              rationale:
                "Higher LTV = more debt = higher monthly payments but less equity needed upfront. 75% LTV means ~CHF 937k mortgage = ~CHF 1,171/month per owner.",
              icon: "üè¶",
            },
            "Amortization Rate": {
              range: "0% to 2% annually",
              rationale:
                "Amortization is principal paydown, directly reducing cash flow. 1% = CHF 937/month total = CHF 234/month per owner building equity.",
              icon: "üí≥",
            },
            "Cleaning Cost per Stay": {
              range: "CHF 49 to 91 (¬±30%)",
              rationale:
                "With ~130 turnovers/year, cleaning costs add up. CHF 70/turnover = CHF 9,100/year = CHF 190/month per owner.",
              icon: "üßπ",
            },
            "Average Length of Stay": {
              range: "1.19 to 2.21 nights (¬±30%)",
              rationale:
                "Longer stays = fewer turnovers = less cleaning costs. 2 nights avg instead of 1.7 saves ~CHF 25/month per owner.",
              icon: "üìÖ",
            },
            "Insurance Rate": {
              range: "0.3% to 0.5% of property value",
              rationale:
                "Annual insurance as % of value. 0.4% = CHF 5k/year = CHF 104/month per owner. Shopping around can save CHF 20-40/month.",
              icon: "üõ°Ô∏è",
            },
            "Winter Season Occupancy": {
              range: "63.75% to 86.25% (¬±15%)",
              rationale:
                "Winter is premium season (Dec-Mar) with highest rates. High winter occupancy is crucial for positive monthly cash flow.",
              icon: "‚õ∑Ô∏è",
            },
            "Inflation Rate": {
              range: "0.5% to 1.5% (¬±0.5%)",
              rationale:
                "Inflation affects Year 1 minimally but compounds over time. Higher inflation means higher future rents AND costs.",
              icon: "üìä",
            },
            "Property Appreciation Rate": {
              range: "1.5% to 3.5% (¬±1%)",
              rationale:
                "Property appreciation doesn't affect monthly cash flow directly - only affects equity value at sale.",
              icon: "üìà",
            },
            "Selling Costs Rate": {
              range: "5.8% to 9.8% (¬±2%)",
              rationale:
                "Selling costs don't affect monthly cash flow - only apply when property is sold at Year 15.",
              icon: "üìù",
            },
          };

          // Filter out zero-impact parameters (like appreciation for monthly cash flow)
          const meaningfulSensitivities = sensitivities.filter(
            (s) => s.impact > 0.5,
          );

          let html = `
            <div class="section">
              <h2 class="section-title">
                <i class="fas fa-wallet"></i> Model Sensitivity - Monthly Net Cash Flow
              </h2>
              
              <!-- Info Box -->
              <div style="background: linear-gradient(135deg, var(--accent) 0%, var(--secondary) 100%); color: white; padding: var(--space-md) var(--space-lg); border-radius: var(--radius-lg); margin-bottom: var(--space-lg); box-shadow: var(--shadow-md);">
                <p style="margin: 0; font-size: var(--font-size-sm); line-height: 1.6; opacity: 0.98; font-weight: 500;">
                  üí° <strong>Monthly NCF = Annual Cash / 12 / Owners</strong> ‚Äî Actual CHF hitting your bank each month after all costs.
                </p>
              </div>
              
              <!-- KPI Summary Cards -->
              <div class="kpi-grid" style="margin-bottom: var(--space-lg);">
                <div class="kpi-card" style="background: linear-gradient(135deg, var(--accent) 0%, var(--secondary) 100%); border: none; color: white; padding: var(--space-lg); box-shadow: var(--shadow-md);">
                  <h3 style="color: rgba(255,255,255,0.95); font-size: 0.85em; font-weight: 600;">Base NCF</h3>
                  <div class="value" style="color: white; font-size: 1.6em; font-weight: 700;">CHF ${baseNCF.toFixed(
                    0,
                  )}</div>
                </div>
                <div class="kpi-card">
                  <h3>Parameters</h3>
                  <div class="value" style="color: var(--color-info);">${
                    meaningfulSensitivities.length
                  }/${sensitivities.length}</div>
                </div>
                <div class="kpi-card">
                  <h3>Top Impact</h3>
                  <div class="value" style="color: var(--color-warning);">¬±CHF ${(
                    sensitivities[0]?.impact || 0
                  ).toFixed(0)}</div>
                  <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">${
                    sensitivities[0]?.parameter || "N/A"
                  }</div>
                </div>
                <div class="kpi-card">
                  <h3>NCF Range</h3>
                  <div class="value" style="color: var(--color-positive); font-size: var(--font-size-xl);">CHF ${Math.min(
                    ...sensitivities.map((s) =>
                      Math.min(s.low.irr, s.high.irr),
                    ),
                  ).toFixed(0)} - ${Math.max(
                    ...sensitivities.map((s) =>
                      Math.max(s.low.irr, s.high.irr),
                    ),
                  ).toFixed(0)}</div>
                </div>
              </div>
              
              <!-- Tornado Chart -->
              <div class="chart-container" style="padding: 30px; margin-bottom: 40px;">
                <h3 style="margin-bottom: 16px; font-size: 1.3em; color: #16a085; font-weight: 700;">
                  üìä Tornado Chart - Impact on Monthly Cash Flow
                </h3>
                <p style="color: #7f8c8d; margin-bottom: 18px; font-size: 0.95em; line-height: 1.6;">
                  <span style="color: #2ecc71; font-weight: 600;">‚ñ†</span> Green = higher cash | 
                  <span style="color: #e74c3c; font-weight: 600;">‚ñ†</span> Red = lower cash | 
                  Hover for details
                </p>
                <div class="chart-wrapper" id="tornadoChartNCF" style="min-height: 500px; height: auto; overflow: visible;"></div>
              </div>

              <!-- Data Table -->
              <div class="data-table" style="margin-top: var(--space-xl); clear: both;">
                <h3 style="padding: var(--space-md); margin: 0; border-bottom: 3px solid var(--border); background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%); font-size: var(--font-size-xl); font-weight: 700; color: var(--primary);">
                  üìã Detailed Parameter Analysis
                </h3>
                <table style="font-size: var(--font-size-sm);">
                  <thead>
                    <tr style="background: linear-gradient(135deg, var(--accent) 0%, var(--secondary) 100%); color: white;">
                      <th style="padding: var(--space-sm) var(--space-md); text-align: left; font-size: var(--font-size-base); font-weight: 700;">Parameter</th>
                      <th style="padding: var(--space-sm) var(--space-md); text-align: center; font-size: var(--font-size-base); font-weight: 700;">Base Value</th>
                      <th style="padding: var(--space-sm) var(--space-md); text-align: center; font-size: var(--font-size-base); font-weight: 700;">Low Scenario</th>
                      <th style="padding: var(--space-sm) var(--space-md); text-align: center; font-size: var(--font-size-base); font-weight: 700;">High Scenario</th>
                      <th style="padding: var(--space-sm) var(--space-md); text-align: center; font-size: var(--font-size-base); font-weight: 700;">Impact</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${sensitivities
                      .map((sens, index) => {
                        const info = parameterInfo[sens.parameter] || {
                          icon: "üìå",
                        };
                        const hasImpact = sens.impact > 0.5;
                        // DYNAMIC COLOR LOGIC: Green if higher NCF, Red if lower
                        const lowBetter = sens.low.irr > baseNCF;
                        const highBetter = sens.high.irr > baseNCF;
                        const lowBgColor = lowBetter ? "#f0fdf4" : "#fff5f5";
                        const lowTextColor = lowBetter ? "#27ae60" : "#c0392b";
                        const highBgColor = highBetter ? "#f0fdf4" : "#fff5f5";
                        const highTextColor = highBetter
                          ? "#27ae60"
                          : "#c0392b";

                        return `
                      <tr style="border-bottom: 2px solid var(--gray-200); transition: background 0.2s; ${
                        index < 3 ? "background: #fffbf0;" : ""
                      } ${!hasImpact ? "opacity: 0.5;" : ""} ${index % 2 === 0 ? "" : "background-color: var(--gray-50);"}" onmouseover="this.style.background='var(--gray-100)'" onmouseout="this.style.background='${index < 3 ? "#fffbf0" : index % 2 === 0 ? "transparent" : "var(--gray-50)"}'">
                        <td style="padding: var(--space-sm) var(--space-md); font-weight: 600; color: var(--primary);">
                          <div style="font-size: var(--font-size-base);">
                            ${info.icon || ""} ${sens.parameter}
                          </div>
                          ${
                            !hasImpact
                              ? '<small style="color: var(--gray-500); font-size: var(--font-size-xs);">(No monthly impact)</small>'
                              : ""
                          }
                        </td>
                        <td style="text-align: center; padding: var(--space-sm) var(--space-md);">
                          <strong style="font-size: var(--font-size-base);">${this.formatValue(
                            sens.base_value,
                            sens.parameter,
                          )}</strong>
                        </td>
                        <td style="text-align: center; padding: var(--space-sm) var(--space-md); background: ${lowBgColor}; border-left: 3px solid ${lowTextColor};">
                          <div style="font-size: var(--font-size-sm); margin-bottom: var(--space-xs);">${this.formatValue(
                            sens.low.value,
                            sens.parameter,
                          )}</div>
                          <div style="color: ${lowTextColor}; font-weight: bold; font-size: var(--font-size-lg); margin-bottom: var(--space-xs);">‚Üí CHF ${sens.low.irr.toFixed(
                            0,
                          )}</div>
                          <small style="color: var(--gray-500); font-size: var(--font-size-xs);">(${
                            sens.low.delta_irr >= 0 ? "+" : ""
                          }CHF ${sens.low.delta_irr.toFixed(0)})</small>
                        </td>
                        <td style="text-align: center; padding: var(--space-sm) var(--space-md); background: ${highBgColor}; border-left: 3px solid ${highTextColor};">
                          <div style="font-size: var(--font-size-sm); margin-bottom: var(--space-xs);">${this.formatValue(
                            sens.high.value,
                            sens.parameter,
                          )}</div>
                          <div style="color: ${highTextColor}; font-weight: bold; font-size: var(--font-size-lg); margin-bottom: var(--space-xs);">‚Üí CHF ${sens.high.irr.toFixed(
                            0,
                          )}</div>
                          <small style="color: var(--gray-500); font-size: var(--font-size-xs);">(${
                            sens.high.delta_irr >= 0 ? "+" : ""
                          }CHF ${sens.high.delta_irr.toFixed(0)})</small>
                        </td>
                        <td style="text-align: center; padding: var(--space-sm) var(--space-md);">
                          <div style="background: ${
                            index < 3 ? "var(--accent)" : "var(--gray-200)"
                          }; color: ${
                            index < 3 ? "white" : "var(--gray-700)"
                          }; padding: var(--space-sm) var(--space-md); border-radius: 25px; display: inline-block; font-weight: 700; font-size: var(--font-size-base); box-shadow: var(--shadow-sm);">
                            ¬±CHF ${sens.impact.toFixed(0)}
                          </div>
                        </td>
                      </tr>
                    `;
                      })
                      .join("")}
                  </tbody>
                </table>
              </div>

              <!-- Insights Panel -->
              <div class="chart-container" style="padding: var(--space-lg); background: linear-gradient(135deg, var(--gray-50), var(--gray-100)); border-left: 4px solid var(--accent); margin-bottom: var(--space-xl); box-shadow: var(--shadow-sm);">
                <h3 style="margin-bottom: var(--space-md); color: var(--primary); font-size: var(--font-size-xl); font-weight: 700;">
                  üí° Monthly Cash Flow Insights
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                  <div>
                    <h4 style="color: var(--secondary); margin-bottom: var(--space-sm); font-size: var(--font-size-lg); font-weight: 700;">üìâ Biggest Cash Drains</h4>
                    <ul style="color: var(--gray-700); line-height: 1.8; padding-left: var(--space-lg); font-size: var(--font-size-sm);">
                      <li><strong>Mortgage interest</strong> - largest monthly expense</li>
                      <li><strong>Amortization</strong> - builds equity but reduces cash</li>
                      <li><strong>Management fees</strong> - 20% of rental income</li>
                    </ul>
                  </div>
                  <div>
                    <h4 style="color: var(--secondary); margin-bottom: var(--space-sm); font-size: var(--font-size-lg); font-weight: 700;">üìà How to Improve Cash Flow</h4>
                    <ul style="color: var(--gray-700); line-height: 1.8; padding-left: var(--space-lg); font-size: var(--font-size-sm);">
                      <li><strong>Negotiate lower interest rate</strong> - biggest lever</li>
                      <li><strong>Increase daily rates</strong> - premium pricing in peak</li>
                      <li><strong>Optimize occupancy</strong> - target winter season</li>
                    </ul>
                  </div>
                  <div>
                    <h4 style="color: var(--secondary); margin-bottom: var(--space-sm); font-size: var(--font-size-lg); font-weight: 700;">‚öñÔ∏è No Monthly Impact</h4>
                    <ul style="color: var(--gray-700); line-height: 1.8; padding-left: var(--space-lg); font-size: var(--font-size-sm);">
                      <li><strong>Property appreciation</strong> - affects equity only</li>
                      <li><strong>Selling costs</strong> - only at exit (Year 15)</li>
                      <li><strong>Inflation</strong> - minimal Year 1 effect</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          `;

          content.innerHTML = html;

          // Render tornado chart for NCF
          if (meaningfulSensitivities.length > 0) {
            const parameters = meaningfulSensitivities.map((s) => s.parameter);
            const lowValues = meaningfulSensitivities.map(
              (s) => s.low.delta_irr,
            );
            const highValues = meaningfulSensitivities.map(
              (s) => s.high.delta_irr,
            );

            // Create custom data for hover
            const customData = meaningfulSensitivities.map((sens) => {
              const info = parameterInfo[sens.parameter] || {};
              return {
                param: sens.parameter,
                lowValue: this.formatValue(sens.low.value, sens.parameter),
                highValue: this.formatValue(sens.high.value, sens.parameter),
                lowNCF: sens.low.irr,
                highNCF: sens.high.irr,
                range: info.range || "Variable",
                rationale: info.rationale || "No description available",
              };
            });

            // Dynamic colors for bars
            const lowColors = meaningfulSensitivities.map((sens) =>
              sens.low.irr > baseNCF
                ? chartColors.positive
                : sens.low.irr < baseNCF
                  ? chartColors.negative
                  : chartColors.neutral,
            );
            const highColors = meaningfulSensitivities.map((sens) =>
              sens.high.irr > baseNCF
                ? chartColors.positive
                : sens.high.irr < baseNCF
                  ? chartColors.negative
                  : chartColors.neutral,
            );

            const traceLow = {
              y: parameters,
              x: lowValues,
              name: "Low Case",
              type: "bar",
              orientation: "h",
              marker: {
                color: lowColors,
                line: { color: chartColors.base, width: 1.5 },
              },
              customdata: customData,
              hovertemplate:
                "<b>%{customdata.param}</b><br>" +
                "<br>" +
                "<b style='color:#ff6b6b;'>üìâ Low Value Scenario</b><br>" +
                "  Parameter Value: <b>%{customdata.lowValue}</b><br>" +
                "  Resulting NCF: <b>CHF %{customdata.lowNCF:.0f}/month</b><br>" +
                "  Change from Base: <b>%{x:+.0f} CHF</b><br>" +
                "<br>" +
                "<b>üìä Tested Range:</b> %{customdata.range}<br>" +
                "<br>" +
                "<b>üí° Why this matters:</b><br>" +
                "%{customdata.rationale}<br>" +
                "<extra></extra>",
              hoverlabel: {
                bgcolor: "rgba(102, 126, 234, 0.98)",
                font: { size: 13, color: "white", family: "Segoe UI, Arial" },
                bordercolor: chartColors.base,
                borderwidth: 2,
                namelength: -1,
                align: "left",
                padding: 12,
              },
            };

            const traceHigh = {
              y: parameters,
              x: highValues,
              name: "High Case",
              type: "bar",
              orientation: "h",
              marker: {
                color: highColors,
                line: { color: chartColors.base, width: 1.5 },
              },
              customdata: customData,
              hovertemplate:
                "<b>%{customdata.param}</b><br>" +
                "<br>" +
                "<b style='color:#51cf66;'>üìà High Value Scenario</b><br>" +
                "  Parameter Value: <b>%{customdata.highValue}</b><br>" +
                "  Resulting NCF: <b>CHF %{customdata.highNCF:.0f}/month</b><br>" +
                "  Change from Base: <b>%{x:+.0f} CHF</b><br>" +
                "<br>" +
                "<b>üìä Tested Range:</b> %{customdata.range}<br>" +
                "<br>" +
                "<b>üí° Why this matters:</b><br>" +
                "%{customdata.rationale}<br>" +
                "<extra></extra>",
              hoverlabel: {
                bgcolor: "rgba(102, 126, 234, 0.98)",
                font: { size: 13, color: "white", family: "Segoe UI, Arial" },
                bordercolor: chartColors.base,
                borderwidth: 2,
                namelength: -1,
                align: "left",
                padding: 12,
              },
            };

            const layout = {
              ...unifiedChartConfig,
              barmode: "relative",
              xaxis: {
                title: {
                  text: "Change from Base (CHF/month)",
                  font: { size: 15, color: "#2c3e50", family: "Segoe UI" },
                  standoff: 12,
                },
                zeroline: true,
                zerolinewidth: 3,
                zerolinecolor: chartColors.base,
                gridcolor: "#e0e4e7",
                gridwidth: 1,
                tickformat: "+,.0f",
                tickprefix: "CHF ",
                tickfont: { size: 13, color: "#5a6c7d" },
              },
              yaxis: {
                title: "",
                autorange: "reversed",
                tickfont: { size: 13, color: "#2c3e50", family: "Segoe UI" },
              },
              height: Math.max(500, 350 + meaningfulSensitivities.length * 45),
              annotations: [
                {
                  text: `<b>Base NCF:</b> CHF ${baseNCF.toFixed(0)}/mo`,
                  xref: "paper",
                  yref: "paper",
                  x: 0.01,
                  y: 0.99,
                  xanchor: "left",
                  yanchor: "top",
                  showarrow: false,
                  font: {
                    size: 13,
                    color: chartColors.base,
                    family: "Segoe UI",
                  },
                  bgcolor: "rgba(255,255,255,0.95)",
                  bordercolor: chartColors.base,
                  borderwidth: 2,
                  borderpad: 6,
                },
              ],
            };

            Plotly.newPlot("tornadoChartNCF", [traceLow, traceHigh], layout, {
              responsive: true,
              modeBarButtonsToRemove: ["lasso2d", "select2d"],
              displaylogo: false,
            }).then(() => {
              const chartDiv = document.getElementById("tornadoChartNCF");
              if (chartDiv && chartDiv.layout) {
                chartDiv.style.height = layout.height + "px";
                chartDiv.style.minHeight = layout.height + "px";
                chartDiv.style.overflow = "visible";
              }
            });
          }
        },

        renderMonteCarlo(data) {
          const content = document.getElementById("contentArea");
          const stats = data.statistics || {};

          let html = `
                    <div class="section">
                        <h2 class="section-title">üé≤ Monte Carlo Simulation</h2>
                        
                        <div style="background: linear-gradient(135deg, var(--accent) 0%, var(--secondary) 100%); color: white; padding: var(--space-md) var(--space-lg); border-radius: var(--radius-lg); margin-bottom: var(--space-lg); box-shadow: var(--shadow-md);">
                          <p style="margin: 0; font-size: var(--font-size-sm); line-height: 1.6; opacity: 0.98; font-weight: 500;">
                            üí° <strong>Monte Carlo Simulation</strong> ‚Äî 1,000 probabilistic scenarios testing uncertainty in key parameters. Shows range of possible outcomes.
                          </p>
                        </div>
                        
                        <!-- Key Investment Metrics -->
                        <h3 class="section-subtitle" style="margin-top: 0; margin-bottom: var(--space-md); font-size: var(--font-size-xl); color: var(--primary); font-weight: 700;">
                            üìä Key Investment Metrics
                        </h3>
                        <div class="kpi-grid" style="margin-bottom: var(--space-xl);">
                            <div class="kpi-card" style="border: 2px solid var(--accent); background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%);">
                                <h3>Mean NPV</h3>
                                <div class="value" style="color: var(--accent); font-size: var(--font-size-2xl);">${(
                                  stats.npv?.mean || 0
                                ).toLocaleString("en-US", {
                                  style: "currency",
                                  currency: "CHF",
                                  maximumFractionDigits: 0,
                                })}</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Median NPV</h3>
                                <div class="value" style="font-size: var(--font-size-2xl);">${(
                                  stats.npv?.median || 0
                                ).toLocaleString("en-US", {
                                  style: "currency",
                                  currency: "CHF",
                                  maximumFractionDigits: 0,
                                })}</div>
                            </div>
                            <div class="kpi-card" style="border: 2px solid ${(stats.npv?.positive_prob || 0) > 0.5 ? "var(--color-positive)" : "var(--color-warning)"}; background: linear-gradient(135deg, ${(stats.npv?.positive_prob || 0) > 0.5 ? "#f0fdf4 0%, #dcfce7 100%" : "#fffbf0 0%, #fef3c7 100%"});">
                                <h3>Probability NPV > 0</h3>
                                <div class="value" style="color: ${(stats.npv?.positive_prob || 0) > 0.5 ? "var(--color-positive)" : "var(--color-warning)"}; font-size: var(--font-size-2xl);">
                                  ${((stats.npv?.positive_prob || 0) * 100).toFixed(1)}%
                                </div>
                            </div>
                            <div class="kpi-card">
                                <h3>Mean Equity IRR</h3>
                                <div class="value" style="font-size: var(--font-size-2xl);">${(stats.irr_with_sale?.mean || 0).toFixed(2)}%</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Median Equity IRR</h3>
                                <div class="value" style="font-size: var(--font-size-2xl);">${(stats.irr_with_sale?.median || 0).toFixed(2)}%</div>
                            </div>
                        </div>

                        <!-- Monthly - Per Person -->
                        <h3 class="section-subtitle" style="margin-top: var(--space-lg); margin-bottom: var(--space-md); font-size: var(--font-size-xl); color: var(--primary); font-weight: 700;">
                            üí∞ Monthly Cash Flow - Per Person
                        </h3>
                        <div class="kpi-grid" style="margin-bottom: var(--space-xl);">
                            <div class="kpi-card" style="border: 2px solid var(--accent); background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%);">
                                <h3>Mean Monthly Cash Flow</h3>
                                <div class="value" style="color: var(--accent);">${(
                                  stats.monthly_cash_flow_per_owner?.mean || 0
                                ).toLocaleString("en-US", {
                                  style: "currency",
                                  currency: "CHF",
                                  maximumFractionDigits: 0,
                                })}</div>
                                <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">per person/month</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Median Monthly Cash Flow</h3>
                                <div class="value" style="color: ${(stats.monthly_cash_flow_per_owner?.median || 0) >= 0 ? "var(--color-positive)" : "var(--color-negative)"};">
                                  ${(
                                    stats.monthly_cash_flow_per_owner?.median ||
                                    0
                                  ).toLocaleString("en-US", {
                                    style: "currency",
                                    currency: "CHF",
                                    maximumFractionDigits: 0,
                                  })}
                                </div>
                                <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">per person/month</div>
                            </div>
                            <div class="kpi-card">
                                <h3>5th Percentile (Worst Case)</h3>
                                <div class="value" style="color: var(--color-negative);">${(
                                  stats.monthly_cash_flow_per_owner?.p5 || 0
                                ).toLocaleString("en-US", {
                                  style: "currency",
                                  currency: "CHF",
                                  maximumFractionDigits: 0,
                                })}</div>
                                <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">per person/month</div>
                            </div>
                            <div class="kpi-card">
                                <h3>95th Percentile (Best Case)</h3>
                                <div class="value" style="color: var(--color-positive);">${(
                                  stats.monthly_cash_flow_per_owner?.p95 || 0
                                ).toLocaleString("en-US", {
                                  style: "currency",
                                  currency: "CHF",
                                  maximumFractionDigits: 0,
                                })}</div>
                                <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">per person/month</div>
                            </div>
                            <div class="kpi-card" style="border: 2px solid ${(stats.monthly_cash_flow_per_owner?.positive_prob || 0) > 0.5 ? "var(--color-positive)" : "var(--color-warning)"};">
                                <h3>Probability Positive</h3>
                                <div class="value" style="color: ${(stats.monthly_cash_flow_per_owner?.positive_prob || 0) > 0.5 ? "var(--color-positive)" : "var(--color-warning)"};">
                                  ${((stats.monthly_cash_flow_per_owner?.positive_prob || 0) * 100).toFixed(1)}%
                                </div>
                            </div>
                        </div>

                        <!-- Monthly - Total -->
                        <h3 class="section-subtitle" style="margin-top: var(--space-lg); margin-bottom: var(--space-md); font-size: var(--font-size-xl); color: var(--primary); font-weight: 700;">
                            üíº Monthly Cash Flow - Total
                        </h3>
                        <div class="kpi-grid" style="margin-bottom: var(--space-xl);">
                            <div class="kpi-card" style="border: 2px solid var(--accent); background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%);">
                                <h3>Mean Monthly Cash Flow</h3>
                                <div class="value" style="color: var(--accent);">${(
                                  stats.monthly_cash_flow_total?.mean || 0
                                ).toLocaleString("en-US", {
                                  style: "currency",
                                  currency: "CHF",
                                  maximumFractionDigits: 0,
                                })}</div>
                                <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">total/month</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Median Monthly Cash Flow</h3>
                                <div class="value" style="color: ${(stats.monthly_cash_flow_total?.median || 0) >= 0 ? "var(--color-positive)" : "var(--color-negative)"};">
                                  ${(
                                    stats.monthly_cash_flow_total?.median || 0
                                  ).toLocaleString("en-US", {
                                    style: "currency",
                                    currency: "CHF",
                                    maximumFractionDigits: 0,
                                  })}
                                </div>
                                <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">total/month</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Mean Monthly Gross Revenue</h3>
                                <div class="value" style="color: var(--color-positive);">${(
                                  stats.monthly_gross_rental_income_total
                                    ?.mean || 0
                                ).toLocaleString("en-US", {
                                  style: "currency",
                                  currency: "CHF",
                                  maximumFractionDigits: 0,
                                })}</div>
                                <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">total/month</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Mean Monthly NOI</h3>
                                <div class="value" style="color: ${(stats.monthly_net_operating_income_total?.mean || 0) >= 0 ? "var(--color-positive)" : "var(--color-negative)"};">
                                  ${(
                                    stats.monthly_net_operating_income_total
                                      ?.mean || 0
                                  ).toLocaleString("en-US", {
                                    style: "currency",
                                    currency: "CHF",
                                    maximumFractionDigits: 0,
                                  })}
                                </div>
                                <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">total/month</div>
                            </div>
                        </div>

                        <!-- Yearly - Per Person -->
                        <h3 class="section-subtitle" style="margin-top: var(--space-lg); margin-bottom: var(--space-md); font-size: var(--font-size-xl); color: var(--primary); font-weight: 700;">
                            üìÖ Annual Cash Flow - Per Person
                        </h3>
                        <div class="kpi-grid" style="margin-bottom: var(--space-xl);">
                            <div class="kpi-card" style="border: 2px solid var(--accent); background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%);">
                                <h3>Mean Annual Cash Flow</h3>
                                <div class="value" style="color: var(--accent);">${(
                                  stats.annual_cash_flow_per_owner?.mean || 0
                                ).toLocaleString("en-US", {
                                  style: "currency",
                                  currency: "CHF",
                                  maximumFractionDigits: 0,
                                })}</div>
                                <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">per person/year</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Median Annual Cash Flow</h3>
                                <div class="value" style="color: ${(stats.annual_cash_flow_per_owner?.median || 0) >= 0 ? "var(--color-positive)" : "var(--color-negative)"};">
                                  ${(
                                    stats.annual_cash_flow_per_owner?.median ||
                                    0
                                  ).toLocaleString("en-US", {
                                    style: "currency",
                                    currency: "CHF",
                                    maximumFractionDigits: 0,
                                  })}
                                </div>
                                <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">per person/year</div>
                            </div>
                            <div class="kpi-card">
                                <h3>5th Percentile (Worst Case)</h3>
                                <div class="value" style="color: var(--color-negative);">${(
                                  stats.annual_cash_flow_per_owner?.p5 || 0
                                ).toLocaleString("en-US", {
                                  style: "currency",
                                  currency: "CHF",
                                  maximumFractionDigits: 0,
                                })}</div>
                                <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">per person/year</div>
                            </div>
                            <div class="kpi-card">
                                <h3>95th Percentile (Best Case)</h3>
                                <div class="value" style="color: var(--color-positive);">${(
                                  stats.annual_cash_flow_per_owner?.p95 || 0
                                ).toLocaleString("en-US", {
                                  style: "currency",
                                  currency: "CHF",
                                  maximumFractionDigits: 0,
                                })}</div>
                                <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">per person/year</div>
                            </div>
                            <div class="kpi-card" style="border: 2px solid ${(stats.annual_cash_flow_per_owner?.positive_prob || 0) > 0.5 ? "var(--color-positive)" : "var(--color-warning)"};">
                                <h3>Probability Positive</h3>
                                <div class="value" style="color: ${(stats.annual_cash_flow_per_owner?.positive_prob || 0) > 0.5 ? "var(--color-positive)" : "var(--color-warning)"};">
                                  ${((stats.annual_cash_flow_per_owner?.positive_prob || 0) * 100).toFixed(1)}%
                                </div>
                            </div>
                        </div>

                        <!-- Yearly - Total -->
                        <h3 class="section-subtitle" style="margin-top: var(--space-lg); margin-bottom: var(--space-md); font-size: var(--font-size-xl); color: var(--primary); font-weight: 700;">
                            üè¢ Annual Cash Flow - Total
                        </h3>
                        <div class="kpi-grid" style="margin-bottom: var(--space-xl);">
                            <div class="kpi-card" style="border: 2px solid var(--accent); background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%);">
                                <h3>Mean Annual Cash Flow</h3>
                                <div class="value" style="color: var(--accent);">${(
                                  stats.annual_cash_flow_total?.mean || 0
                                ).toLocaleString("en-US", {
                                  style: "currency",
                                  currency: "CHF",
                                  maximumFractionDigits: 0,
                                })}</div>
                                <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">total/year</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Median Annual Cash Flow</h3>
                                <div class="value" style="color: ${(stats.annual_cash_flow_total?.median || 0) >= 0 ? "var(--color-positive)" : "var(--color-negative)"};">
                                  ${(
                                    stats.annual_cash_flow_total?.median || 0
                                  ).toLocaleString("en-US", {
                                    style: "currency",
                                    currency: "CHF",
                                    maximumFractionDigits: 0,
                                  })}
                                </div>
                                <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">total/year</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Mean Annual Gross Revenue</h3>
                                <div class="value" style="color: var(--color-positive);">${(
                                  stats.annual_gross_rental_income_total
                                    ?.mean || 0
                                ).toLocaleString("en-US", {
                                  style: "currency",
                                  currency: "CHF",
                                  maximumFractionDigits: 0,
                                })}</div>
                                <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">total/year</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Mean Annual NOI</h3>
                                <div class="value" style="color: ${(stats.annual_net_operating_income_total?.mean || 0) >= 0 ? "var(--color-positive)" : "var(--color-negative)"};">
                                  ${(
                                    stats.annual_net_operating_income_total
                                      ?.mean || 0
                                  ).toLocaleString("en-US", {
                                    style: "currency",
                                    currency: "CHF",
                                    maximumFractionDigits: 0,
                                  })}
                                </div>
                                <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">total/year</div>
                            </div>
                            <div class="kpi-card">
                                <h3>5th Percentile (Worst Case)</h3>
                                <div class="value" style="color: var(--color-negative);">${(
                                  stats.annual_cash_flow_total?.p5 || 0
                                ).toLocaleString("en-US", {
                                  style: "currency",
                                  currency: "CHF",
                                  maximumFractionDigits: 0,
                                })}</div>
                                <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">total/year</div>
                            </div>
                            <div class="kpi-card">
                                <h3>95th Percentile (Best Case)</h3>
                                <div class="value" style="color: var(--color-positive);">${(
                                  stats.annual_cash_flow_total?.p95 || 0
                                ).toLocaleString("en-US", {
                                  style: "currency",
                                  currency: "CHF",
                                  maximumFractionDigits: 0,
                                })}</div>
                                <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">total/year</div>
                            </div>
                        </div>

                        <!-- Distribution Charts -->
                        <div class="chart-container" style="padding: var(--space-lg); margin-bottom: var(--space-xl); background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-md);">
                            <h3 style="margin-bottom: var(--space-md); font-size: var(--font-size-xl); color: var(--primary); font-weight: 700;">
                                üìä NPV Distribution
                            </h3>
                            <p style="color: var(--gray-500); margin-bottom: var(--space-md); font-size: var(--font-size-sm); line-height: 1.6;">
                                Distribution of Net Present Value across 1,000 simulations. Shows probability of different outcomes.
                            </p>
                            <div class="chart-wrapper" id="npvChart" style="min-height: 400px;"></div>
                        </div>

                        <div class="chart-container" style="padding: var(--space-lg); margin-bottom: var(--space-xl); background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-md);">
                            <h3 style="margin-bottom: var(--space-md); font-size: var(--font-size-xl); color: var(--primary); font-weight: 700;">
                                üìà Equity IRR Distribution
                            </h3>
                            <p style="color: var(--gray-500); margin-bottom: var(--space-md); font-size: var(--font-size-sm); line-height: 1.6;">
                                Distribution of Equity Internal Rate of Return (15-year) across all simulations.
                            </p>
                            <div class="chart-wrapper" id="irrChart" style="min-height: 400px;"></div>
                        </div>

                        <!-- Cumulative Probability Chart -->
                        <div class="chart-container" style="padding: var(--space-lg); margin-bottom: var(--space-xl); background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-md);">
                            <h3 style="margin-bottom: var(--space-md); font-size: var(--font-size-xl); color: var(--primary); font-weight: 700;">
                                üìâ Cumulative Probability (CDF) - NPV
                            </h3>
                            <p style="color: var(--gray-500); margin-bottom: var(--space-md); font-size: var(--font-size-sm); line-height: 1.6;">
                                Cumulative distribution function showing probability that NPV will be below a given value. Useful for risk assessment.
                            </p>
                            <div class="chart-wrapper" id="cdfChart" style="min-height: 400px;"></div>
                        </div>

                        <!-- Box Plot for Key Metrics -->
                        <div class="chart-container" style="padding: var(--space-lg); margin-bottom: var(--space-xl); background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-md);">
                            <h3 style="margin-bottom: var(--space-md); font-size: var(--font-size-xl); color: var(--primary); font-weight: 700;">
                                üì¶ Box Plot - Key Metrics
                            </h3>
                            <p style="color: var(--gray-500); margin-bottom: var(--space-md); font-size: var(--font-size-sm); line-height: 1.6;">
                                Box plots showing quartiles (25th, 50th, 75th percentiles) and outliers for key financial metrics.
                            </p>
                            <div class="chart-wrapper" id="boxPlotChart" style="min-height: 400px;"></div>
                        </div>

                        <!-- Risk Metrics -->
                        <div class="chart-container" style="padding: var(--space-lg); background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-md);">
                            <h3 style="margin-bottom: var(--space-md); font-size: var(--font-size-xl); color: var(--primary); font-weight: 700;">
                                ‚ö†Ô∏è Risk Metrics & Percentiles
                            </h3>
                            <div class="kpi-grid" style="margin-bottom: var(--space-md);">
                                <div class="kpi-card" style="border: 2px solid var(--color-negative); background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);">
                                    <h3>5th Percentile (Worst Case)</h3>
                                    <div class="value" style="color: var(--color-negative);">
                                      ${(stats.npv?.p5 || 0).toLocaleString(
                                        "en-US",
                                        {
                                          style: "currency",
                                          currency: "CHF",
                                          maximumFractionDigits: 0,
                                        },
                                      )}
                                    </div>
                                    <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">
                                      Only 5% of scenarios worse
                                    </div>
                                </div>
                                <div class="kpi-card">
                                    <h3>25th Percentile</h3>
                                    <div class="value">
                                      ${(stats.npv?.p25 || 0).toLocaleString(
                                        "en-US",
                                        {
                                          style: "currency",
                                          currency: "CHF",
                                          maximumFractionDigits: 0,
                                        },
                                      )}
                                    </div>
                                </div>
                                <div class="kpi-card" style="border: 2px solid var(--accent);">
                                    <h3>Median (50th Percentile)</h3>
                                    <div class="value" style="color: var(--accent);">
                                      ${(stats.npv?.median || 0).toLocaleString(
                                        "en-US",
                                        {
                                          style: "currency",
                                          currency: "CHF",
                                          maximumFractionDigits: 0,
                                        },
                                      )}
                                    </div>
                                </div>
                                <div class="kpi-card">
                                    <h3>75th Percentile</h3>
                                    <div class="value">
                                      ${(stats.npv?.p75 || 0).toLocaleString(
                                        "en-US",
                                        {
                                          style: "currency",
                                          currency: "CHF",
                                          maximumFractionDigits: 0,
                                        },
                                      )}
                                    </div>
                                </div>
                                <div class="kpi-card" style="border: 2px solid var(--color-positive); background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);">
                                    <h3>95th Percentile (Best Case)</h3>
                                    <div class="value" style="color: var(--color-positive);">
                                      ${(stats.npv?.p95 || 0).toLocaleString(
                                        "en-US",
                                        {
                                          style: "currency",
                                          currency: "CHF",
                                          maximumFractionDigits: 0,
                                        },
                                      )}
                                    </div>
                                    <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">
                                      Only 5% of scenarios better
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

          content.innerHTML = html;

          // Render charts if sample data available
          if (data.sample_data && data.sample_data.length > 0) {
            const npvValues = data.sample_data
              .map((d) => d.npv || 0)
              .filter((v) => v !== null && !isNaN(v));

            const irrValues = data.sample_data
              .map((d) => (d.irr_with_sale || 0) * 100) // Convert to percentage
              .filter((v) => v !== null && !isNaN(v) && isFinite(v));

            const annualCashFlowValues = data.sample_data
              .map((d) => d.annual_cash_flow || 0)
              .filter((v) => v !== null && !isNaN(v));

            // 1. NPV Distribution Histogram
            if (npvValues.length > 0) {
              const npvTrace = {
                x: npvValues,
                type: "histogram",
                nbinsx: 50,
                marker: {
                  color: "#667eea",
                  line: { color: "#4c63d2", width: 1 },
                },
                hovertemplate:
                  "NPV: <b>%{x:,.0f} CHF</b><br>Frequency: <b>%{y}</b><extra></extra>",
              };

              const npvLayout = {
                ...unifiedChartConfig,
                title: "",
                xaxis: {
                  title: {
                    text: "NPV (CHF)",
                    font: { size: 14, color: "#2c3e50" },
                  },
                  gridcolor: "#e0e4e7",
                  zeroline: true,
                  zerolinecolor: "#667eea",
                  zerolinewidth: 2,
                },
                yaxis: {
                  title: {
                    text: "Frequency",
                    font: { size: 14, color: "#2c3e50" },
                  },
                  gridcolor: "#e0e4e7",
                },
                hovermode: "closest",
                annotations: [
                  {
                    x: stats.npv?.mean || 0,
                    y: 0,
                    xref: "x",
                    yref: "paper",
                    text: "Mean",
                    showarrow: true,
                    arrowhead: 2,
                    ax: 0,
                    ay: -40,
                    font: { color: "#667eea", size: 12, weight: "bold" },
                    bgcolor: "rgba(255,255,255,0.9)",
                    bordercolor: "#667eea",
                    borderwidth: 1,
                    borderpad: 4,
                  },
                  {
                    x: stats.npv?.median || 0,
                    y: 0,
                    xref: "x",
                    yref: "paper",
                    text: "Median",
                    showarrow: true,
                    arrowhead: 2,
                    ax: 0,
                    ay: -40,
                    font: { color: "#28a745", size: 12, weight: "bold" },
                    bgcolor: "rgba(255,255,255,0.9)",
                    bordercolor: "#28a745",
                    borderwidth: 1,
                    borderpad: 4,
                  },
                  {
                    x: 0,
                    y: 0,
                    xref: "x",
                    yref: "paper",
                    text: "Break-even",
                    showarrow: true,
                    arrowhead: 2,
                    ax: 0,
                    ay: -40,
                    font: { color: "#dc3545", size: 12, weight: "bold" },
                    bgcolor: "rgba(255,255,255,0.9)",
                    bordercolor: "#dc3545",
                    borderwidth: 1,
                    borderpad: 4,
                  },
                ],
              };

              Plotly.newPlot("npvChart", [npvTrace], npvLayout, {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ["lasso2d", "select2d"],
                displaylogo: false,
              });
            }

            // 2. IRR Distribution Histogram
            if (irrValues.length > 0) {
              const irrTrace = {
                x: irrValues,
                type: "histogram",
                nbinsx: 50,
                marker: {
                  color: "#17a2b8",
                  line: { color: "#138496", width: 1 },
                },
                hovertemplate:
                  "IRR: <b>%{x:.2f}%</b><br>Frequency: <b>%{y}</b><extra></extra>",
              };

              const irrLayout = {
                ...unifiedChartConfig,
                title: "",
                xaxis: {
                  title: {
                    text: "Equity IRR (%)",
                    font: { size: 14, color: "#2c3e50" },
                  },
                  gridcolor: "#e0e4e7",
                  zeroline: true,
                  zerolinecolor: "#17a2b8",
                  zerolinewidth: 2,
                },
                yaxis: {
                  title: {
                    text: "Frequency",
                    font: { size: 14, color: "#2c3e50" },
                  },
                  gridcolor: "#e0e4e7",
                },
                hovermode: "closest",
                annotations: [
                  {
                    x: (stats.irr_with_sale?.mean || 0) * 100,
                    y: 0,
                    xref: "x",
                    yref: "paper",
                    text: "Mean",
                    showarrow: true,
                    arrowhead: 2,
                    ax: 0,
                    ay: -40,
                    font: { color: "#17a2b8", size: 12, weight: "bold" },
                    bgcolor: "rgba(255,255,255,0.9)",
                    bordercolor: "#17a2b8",
                    borderwidth: 1,
                    borderpad: 4,
                  },
                  {
                    x: (stats.irr_with_sale?.median || 0) * 100,
                    y: 0,
                    xref: "x",
                    yref: "paper",
                    text: "Median",
                    showarrow: true,
                    arrowhead: 2,
                    ax: 0,
                    ay: -40,
                    font: { color: "#28a745", size: 12, weight: "bold" },
                    bgcolor: "rgba(255,255,255,0.9)",
                    bordercolor: "#28a745",
                    borderwidth: 1,
                    borderpad: 4,
                  },
                ],
              };

              Plotly.newPlot("irrChart", [irrTrace], irrLayout, {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ["lasso2d", "select2d"],
                displaylogo: false,
              });
            }

            // 3. Cumulative Probability (CDF) Chart
            if (npvValues.length > 0) {
              const sortedNPV = [...npvValues].sort((a, b) => a - b);
              const cumulativeProb = sortedNPV.map(
                (val, idx) => ((idx + 1) / sortedNPV.length) * 100,
              );

              const cdfTrace = {
                x: sortedNPV,
                y: cumulativeProb,
                type: "scatter",
                mode: "lines",
                line: {
                  color: "#667eea",
                  width: 3,
                  shape: "hv", // Step function
                },
                fill: "tozeroy",
                fillcolor: "rgba(102, 126, 234, 0.1)",
                hovertemplate:
                  "NPV: <b>%{x:,.0f} CHF</b><br>Probability: <b>%{y:.1f}%</b><extra></extra>",
              };

              const cdfLayout = {
                ...unifiedChartConfig,
                title: "",
                xaxis: {
                  title: {
                    text: "NPV (CHF)",
                    font: { size: 14, color: "#2c3e50" },
                  },
                  gridcolor: "#e0e4e7",
                  zeroline: true,
                  zerolinecolor: "#667eea",
                  zerolinewidth: 2,
                },
                yaxis: {
                  title: {
                    text: "Cumulative Probability (%)",
                    font: { size: 14, color: "#2c3e50" },
                  },
                  gridcolor: "#e0e4e7",
                  range: [0, 100],
                },
                hovermode: "closest",
                annotations: [
                  {
                    x: 0,
                    y: 50,
                    xref: "x",
                    yref: "y",
                    text: "50% probability",
                    showarrow: true,
                    arrowhead: 2,
                    ax: 20,
                    ay: -30,
                    font: { color: "#667eea", size: 11 },
                    bgcolor: "rgba(255,255,255,0.9)",
                    bordercolor: "#667eea",
                    borderwidth: 1,
                    borderpad: 4,
                  },
                ],
              };

              Plotly.newPlot("cdfChart", [cdfTrace], cdfLayout, {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ["lasso2d", "select2d"],
                displaylogo: false,
              });
            }

            // 4. Box Plot for Key Metrics (separate subplots since different scales)
            if (
              npvValues.length > 0 &&
              irrValues.length > 0 &&
              annualCashFlowValues.length > 0
            ) {
              // Create subplots for each metric since they have different units
              const npvBox = {
                y: npvValues,
                type: "box",
                name: "NPV",
                boxpoints: "outliers",
                marker: { color: "#667eea", size: 3, opacity: 0.6 },
                line: { color: "#4c63d2", width: 2 },
                hovertemplate: "NPV: <b>%{y:,.0f} CHF</b><extra></extra>",
              };

              const irrBox = {
                y: irrValues,
                type: "box",
                name: "IRR",
                boxpoints: "outliers",
                marker: { color: "#17a2b8", size: 3, opacity: 0.6 },
                line: { color: "#138496", width: 2 },
                hovertemplate: "IRR: <b>%{y:.2f}%</b><extra></extra>",
                xaxis: "x2",
                yaxis: "y2",
              };

              const cashFlowBox = {
                y: annualCashFlowValues,
                type: "box",
                name: "Annual Cash Flow",
                boxpoints: "outliers",
                marker: { color: "#28a745", size: 3, opacity: 0.6 },
                line: { color: "#1e7e34", width: 2 },
                hovertemplate: "Cash Flow: <b>%{y:,.0f} CHF</b><extra></extra>",
                xaxis: "x3",
                yaxis: "y3",
              };

              const boxLayout = {
                ...unifiedChartConfig,
                title: "",
                grid: {
                  rows: 1,
                  columns: 3,
                  pattern: "independent",
                  roworder: "bottom to top",
                },
                xaxis: {
                  title: {
                    text: "NPV (CHF)",
                    font: { size: 12, color: "#2c3e50" },
                  },
                  domain: [0, 0.33],
                  showticklabels: false,
                },
                yaxis: {
                  title: {
                    text: "NPV (CHF)",
                    font: { size: 12, color: "#2c3e50" },
                  },
                  gridcolor: "#e0e4e7",
                  zeroline: true,
                  zerolinecolor: "#667eea",
                  zerolinewidth: 1,
                },
                xaxis2: {
                  title: {
                    text: "IRR (%)",
                    font: { size: 12, color: "#2c3e50" },
                  },
                  domain: [0.33, 0.66],
                  showticklabels: false,
                },
                yaxis2: {
                  title: {
                    text: "IRR (%)",
                    font: { size: 12, color: "#2c3e50" },
                  },
                  gridcolor: "#e0e4e7",
                  zeroline: true,
                  zerolinecolor: "#17a2b8",
                  zerolinewidth: 1,
                },
                xaxis3: {
                  title: {
                    text: "Cash Flow (CHF)",
                    font: { size: 12, color: "#2c3e50" },
                  },
                  domain: [0.66, 1.0],
                  showticklabels: false,
                },
                yaxis3: {
                  title: {
                    text: "Annual Cash Flow (CHF)",
                    font: { size: 12, color: "#2c3e50" },
                  },
                  gridcolor: "#e0e4e7",
                  zeroline: true,
                  zerolinecolor: "#28a745",
                  zerolinewidth: 1,
                },
                hovermode: "closest",
                showlegend: false,
              };

              Plotly.newPlot(
                "boxPlotChart",
                [npvBox, irrBox, cashFlowBox],
                boxLayout,
                {
                  responsive: true,
                  displayModeBar: true,
                  modeBarButtonsToRemove: ["lasso2d", "select2d"],
                  displaylogo: false,
                },
              );
            }
          }
        },

        renderMonteCarloSensitivity(data) {
          const content = document.getElementById("contentArea");
          const baseProb = (data.base_npv_probability || 0) * 100;
          const sensitivities = data.sensitivities || [];

          let html = `
                    <div class="section">
                        <h2 class="section-title">üìä MC Sensitivity Analysis</h2>
                        
                        <div style="background: linear-gradient(135deg, var(--accent) 0%, var(--secondary) 100%); color: white; padding: var(--space-md) var(--space-lg); border-radius: var(--radius-lg); margin-bottom: var(--space-lg); box-shadow: var(--shadow-md);">
                          <p style="margin: 0; font-size: var(--font-size-sm); line-height: 1.6; opacity: 0.98; font-weight: 500;">
                            üí° <strong>MC Sensitivity Analysis</strong> ‚Äî Shows how NPV > 0 probability changes when key parameters vary. Each parameter is tested with 10 values, running 1,000 Monte Carlo simulations per value (with LHS) to assess risk-adjusted impacts.
                          </p>
                        </div>

                        <!-- Base Probability KPI -->
                        <div class="kpi-grid" style="margin-bottom: var(--space-xl);">
                            <div class="kpi-card" style="border: 2px solid var(--accent); background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%); grid-column: span 2;">
                                <h3>Base Case NPV > 0 Probability</h3>
                                <div class="value" style="color: var(--accent); font-size: var(--font-size-3xl);">${baseProb.toFixed(1)}%</div>
                                <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">Probability of positive NPV</div>
                            </div>
                        </div>

                        <!-- Sensitivity Charts -->
                        <div class="chart-container" style="padding: var(--space-lg); margin-bottom: var(--space-xl); background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-md);">
                            <h3 class="section-subtitle" style="margin-top: 0; margin-bottom: var(--space-md); font-size: var(--font-size-xl); color: var(--primary); font-weight: 700;">
                                Parameter Impact on NPV > 0 Probability
                            </h3>
                            
                            <!-- Parameter Toggle Controls -->
                            <div style="margin-bottom: var(--space-md); padding: var(--space-md); background: var(--gray-50); border-radius: var(--radius-md); display: flex; flex-wrap: wrap; gap: var(--space-sm); align-items: center;">
                                <span style="font-weight: 600; color: var(--primary); margin-right: var(--space-sm);">Show/Hide Parameters:</span>
                                ${sensitivities
                                  .map((sens, idx) => {
                                    const colors = [
                                      "#667eea",
                                      "#f093fb",
                                      "#4facfe",
                                      "#00f2fe",
                                      "#43e97b",
                                    ];
                                    return `
                                    <label style="display: flex; align-items: center; gap: var(--space-xs); cursor: pointer; padding: var(--space-xs) var(--space-sm); background: white; border-radius: var(--radius-sm); border: 2px solid ${colors[idx % colors.length]}; transition: all 0.2s;" 
                                           onmouseover="this.style.transform='scale(1.05)'" 
                                           onmouseout="this.style.transform='scale(1)'">
                                      <input type="checkbox" class="param-toggle" data-param-index="${idx}" checked style="cursor: pointer;">
                                      <span style="color: ${colors[idx % colors.length]}; font-weight: 600; font-size: 0.9em;">${sens.parameter}</span>
                                    </label>
                                  `;
                                  })
                                  .join("")}
                                <button onclick="resetChartZoom('monteCarloSensitivityChart')" style="margin-left: auto; padding: var(--space-xs) var(--space-md); background: var(--primary); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; font-size: 0.9em;" 
                                        onmouseover="this.style.background='var(--accent)'" 
                                        onmouseout="this.style.background='var(--primary)'">
                                  Reset Zoom
                                </button>
                            </div>
                            
                            <div id="monteCarloSensitivityChart" class="chart-wrapper" style="height: 600px;"></div>
                        </div>

                        <!-- Parameter Comparison View -->
                        <div class="section" style="margin-top: var(--space-xl);">
                            <h3 class="section-subtitle" style="margin-bottom: var(--space-md); font-size: var(--font-size-xl); color: var(--primary); font-weight: 700;">
                                Parameter Impact Comparison
                            </h3>
                            
                            <!-- Impact Bar Chart -->
                            <div class="chart-container" style="padding: var(--space-lg); margin-bottom: var(--space-xl); background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-md);">
                                <h4 style="margin-bottom: var(--space-md); color: var(--primary); font-weight: 600;">
                                    Impact Ranking (Max - Min Probability)
                                </h4>
                                <div id="mcSensitivityImpactChart" class="chart-wrapper" style="height: 400px;"></div>
                            </div>
                            
                            <!-- Individual Parameter Subplots -->
                            <div class="chart-container" style="padding: var(--space-lg); margin-bottom: var(--space-xl); background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-md);">
                                <h4 style="margin-bottom: var(--space-md); color: var(--primary); font-weight: 600;">
                                    Individual Parameter Curves
                                </h4>
                                <div id="mcSensitivitySubplots" class="chart-wrapper" style="height: 800px;"></div>
                            </div>
                        </div>

                        <!-- Parameter Summary Table -->
                        <div class="section" style="margin-top: var(--space-xl);">
                            <h3 class="section-subtitle" style="margin-bottom: var(--space-md); font-size: var(--font-size-xl); color: var(--primary); font-weight: 700;">
                                Parameter Impact Summary
                            </h3>
                            <div class="data-table">
                                <table id="mcSensitivityTable" style="cursor: pointer;">
                                    <thead>
                                        <tr>
                                            <th onclick="sortTable('mcSensitivityTable', 0)">Parameter ‚Üï</th>
                                            <th onclick="sortTable('mcSensitivityTable', 1)">Base Value ‚Üï</th>
                                            <th onclick="sortTable('mcSensitivityTable', 2)">Min Probability ‚Üï</th>
                                            <th onclick="sortTable('mcSensitivityTable', 3)">Max Probability ‚Üï</th>
                                            <th onclick="sortTable('mcSensitivityTable', 4)">Impact Range ‚Üï</th>
                                            <th onclick="sortTable('mcSensitivityTable', 5)">Sensitivity Score ‚Üï</th>
                                            <th>Trend</th>
                                            <th>Base Position</th>
                                            <th>Critical Range</th>
                                        </tr>
                                    </thead>
                                    <tbody>
          `;

          // Calculate max impact for normalization
          const maxImpact = Math.max(...sensitivities.map((s) => s.impact));

          sensitivities.forEach((sens, index) => {
            const formatValue = (val, param) => {
              if (param.includes("Price")) {
                return `CHF ${val.toLocaleString("en-US", { maximumFractionDigits: 0 })}`;
              } else if (
                param.includes("Rate") &&
                !param.includes("Occupancy")
              ) {
                return `${(val * 100).toFixed(2)}%`;
              } else if (param.includes("Occupancy")) {
                return `${(val * 100).toFixed(1)}%`;
              } else {
                return val.toFixed(4);
              }
            };

            // Calculate additional metrics
            const sensitivityScore = Math.round(
              (sens.impact / maxImpact) * 100,
            );

            // Calculate trend (positive = higher values increase probability)
            const firstProb = sens.values[0].npv_probability;
            const lastProb =
              sens.values[sens.values.length - 1].npv_probability;
            const trend =
              lastProb > firstProb ? "‚Üë" : lastProb < firstProb ? "‚Üì" : "‚Üí";
            const trendColor =
              lastProb > firstProb
                ? "#28a745"
                : lastProb < firstProb
                  ? "#dc3545"
                  : "#6c757d";

            // Determine base position in range
            const minVal = Math.min(...sens.values.map((v) => v.value));
            const maxVal = Math.max(...sens.values.map((v) => v.value));
            const basePos = (sens.base_value - minVal) / (maxVal - minVal);
            let basePosition = "Mid";
            if (basePos < 0.33) basePosition = "Low";
            else if (basePos > 0.67) basePosition = "High";

            // Find critical range (where probability > base probability or > 50%)
            const criticalThreshold = Math.max(baseProb / 100, 0.5);
            const criticalValues = sens.values.filter(
              (v) => v.npv_probability >= criticalThreshold,
            );
            let criticalRange = "N/A";
            if (criticalValues.length > 0) {
              const critMin = Math.min(...criticalValues.map((v) => v.value));
              const critMax = Math.max(...criticalValues.map((v) => v.value));
              criticalRange = `${formatValue(critMin, sens.parameter)} - ${formatValue(critMax, sens.parameter)}`;
            }

            // Color coding for impact (green = high, yellow = medium, gray = low)
            let impactColor = "#6c757d"; // gray
            if (sensitivityScore >= 70)
              impactColor = "#28a745"; // green
            else if (sensitivityScore >= 40) impactColor = "#ffc107"; // yellow

            html += `
                                        <tr class="mc-sens-row" data-index="${index}" style="transition: background 0.2s;" 
                                            onmouseover="this.style.background='var(--gray-100)'" 
                                            onmouseout="this.style.background='transparent'"
                                            onclick="toggleRowDetails('mcSensitivityTable', ${index})">
                                            <td><strong>${sens.parameter}</strong></td>
                                            <td>${formatValue(sens.base_value, sens.parameter)}</td>
                                            <td style="color: var(--color-negative);">${(sens.min_probability * 100).toFixed(1)}%</td>
                                            <td style="color: var(--color-positive);">${(sens.max_probability * 100).toFixed(1)}%</td>
                                            <td style="color: ${impactColor}; font-weight: 600;"><strong>${(sens.impact * 100).toFixed(1)}%</strong></td>
                                            <td><span style="background: ${impactColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">${sensitivityScore}</span></td>
                                            <td style="color: ${trendColor}; font-size: 1.2em; font-weight: bold;">${trend}</td>
                                            <td><span style="background: var(--gray-200); padding: 2px 8px; border-radius: 12px; font-size: 0.85em;">${basePosition}</span></td>
                                            <td style="font-size: 0.9em; color: var(--gray-600);">${criticalRange}</td>
                                        </tr>
                                        <tr class="mc-sens-details" data-index="${index}" style="display: none; background: var(--gray-50);">
                                            <td colspan="9" style="padding: var(--space-md);">
                                                <div style="margin-left: var(--space-lg);">
                                                    <h4 style="margin-bottom: var(--space-sm); color: var(--primary);">Detailed Value Breakdown:</h4>
                                                    <table style="width: 100%; font-size: 0.9em;">
                                                        <thead>
                                                            <tr style="background: var(--gray-200);">
                                                                <th style="padding: var(--space-xs) var(--space-sm);">Value</th>
                                                                <th style="padding: var(--space-xs) var(--space-sm);">NPV > 0 Probability</th>
                                                                <th style="padding: var(--space-xs) var(--space-sm);">Change from Base</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
            `;

            sens.values.forEach((v) => {
              const changeFromBase = (
                v.npv_probability * 100 -
                baseProb
              ).toFixed(1);
              const changeColor =
                changeFromBase > 0
                  ? "var(--color-positive)"
                  : changeFromBase < 0
                    ? "var(--color-negative)"
                    : "var(--gray-600)";
              html += `
                                                            <tr>
                                                                <td style="padding: var(--space-xs) var(--space-sm);">${formatValue(v.value, sens.parameter)}</td>
                                                                <td style="padding: var(--space-xs) var(--space-sm); font-weight: 600;">${(v.npv_probability * 100).toFixed(1)}%</td>
                                                                <td style="padding: var(--space-xs) var(--space-sm); color: ${changeColor};">
                                                                    ${changeFromBase > 0 ? "+" : ""}${changeFromBase}%
                                                                </td>
                                                            </tr>
              `;
            });

            html += `
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </td>
                                        </tr>
            `;
          });

          html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
          `;

          content.innerHTML = html;

          // Render sensitivity chart
          if (sensitivities.length > 0) {
            const traces = [];
            const colors = [
              "#667eea",
              "#f093fb",
              "#4facfe",
              "#00f2fe",
              "#43e97b",
            ];

            sensitivities.forEach((sens, idx) => {
              const xValues = sens.values.map((v) => v.value);
              const yValues = sens.values.map((v) => v.npv_probability * 100); // Convert to percentage

              // Format parameter value for display
              const formatXValue = (val, param) => {
                if (param.includes("Price")) {
                  return val / 1000; // Show in thousands
                } else if (
                  param.includes("Rate") &&
                  !param.includes("Occupancy")
                ) {
                  return val * 100; // Show as percentage
                } else if (param.includes("Occupancy")) {
                  return val * 100; // Show as percentage
                } else {
                  return val;
                }
              };

              const xFormatted = xValues.map((v) =>
                formatXValue(v, sens.parameter),
              );

              // Calculate relative change from base for tooltip
              const baseProbForParam = baseProb;

              traces.push({
                x: xFormatted,
                y: yValues,
                type: "scatter",
                mode: "lines+markers",
                name: sens.parameter,
                visible: true,
                line: {
                  color: colors[idx % colors.length],
                  width: 3,
                },
                marker: {
                  size: 8,
                  color: colors[idx % colors.length],
                },
                hovertemplate:
                  `<b>${sens.parameter}</b><br>` +
                  `Parameter Value: <b>%{x:.2f}${sens.parameter.includes("Price") ? "k CHF" : sens.parameter.includes("Rate") || sens.parameter.includes("Occupancy") ? "%" : ""}</b><br>` +
                  `NPV > 0 Probability: <b>%{y:.1f}%</b><br>` +
                  `Base Probability: <b>${baseProbForParam.toFixed(1)}%</b><br>` +
                  `Change from Base: <b>${yValues[yValues.length - 1] - baseProbForParam >= 0 ? "+" : ""}${(yValues[yValues.length - 1] - baseProbForParam).toFixed(1)}%</b><br>` +
                  `Range: ${(sens.min_probability * 100).toFixed(1)}% - ${(sens.max_probability * 100).toFixed(1)}%<extra></extra>`,
              });

              // Add vertical line for base value with annotation
              const baseFormatted = formatXValue(
                sens.base_value,
                sens.parameter,
              );
              traces.push({
                x: [baseFormatted, baseFormatted],
                y: [0, 100],
                type: "scatter",
                mode: "lines",
                name: `${sens.parameter} (Base)`,
                line: {
                  color: colors[idx % colors.length],
                  width: 2,
                  dash: "dash",
                },
                showlegend: false,
                hoverinfo: "skip",
              });

              // Add annotation for base value
              traces.push({
                x: [baseFormatted],
                y: [baseProb],
                type: "scatter",
                mode: "markers+text",
                name: `${sens.parameter} Base`,
                marker: {
                  size: 12,
                  color: colors[idx % colors.length],
                  symbol: "diamond",
                },
                text: [`Base: ${baseProb.toFixed(1)}%`],
                textposition: "top center",
                showlegend: false,
                hovertemplate: `<b>Base Value</b><br>${sens.parameter}: <b>%{x:.2f}${sens.parameter.includes("Price") ? "k CHF" : sens.parameter.includes("Rate") || sens.parameter.includes("Occupancy") ? "%" : ""}</b><br>Probability: <b>${baseProb.toFixed(1)}%</b><extra></extra>`,
              });
            });

            const layout = {
              ...unifiedChartConfig,
              title: {
                text: "NPV > 0 Probability vs Parameter Values",
                font: { size: 18, color: "#2c3e50", weight: "bold" },
                x: 0.5,
                xanchor: "center",
              },
              xaxis: {
                title: {
                  text: "Parameter Value",
                  font: { size: 14, color: "#2c3e50" },
                },
                gridcolor: "#e0e4e7",
              },
              yaxis: {
                title: {
                  text: "NPV > 0 Probability (%)",
                  font: { size: 14, color: "#2c3e50" },
                },
                gridcolor: "#e0e4e7",
                range: [0, 100],
              },
              hovermode: "closest",
              dragmode: "zoom", // Enable zoom by default
              legend: {
                orientation: "h",
                x: 0.5,
                xanchor: "center",
                y: -0.15,
              },
              annotations: [
                {
                  text: "üí° Use zoom/pan tools or click parameter labels to toggle visibility",
                  showarrow: false,
                  xref: "paper",
                  yref: "paper",
                  x: 0.5,
                  y: -0.25,
                  xanchor: "center",
                  font: { size: 11, color: "#6c757d" },
                },
              ],
            };

            const config = {
              responsive: true,
              displayModeBar: true,
              modeBarButtonsToRemove: ["lasso2d", "select2d"],
              displaylogo: false,
              toImageButtonOptions: {
                format: "png",
                filename: "mc_sensitivity_chart",
                height: 600,
                width: 1200,
                scale: 2,
              },
            };

            Plotly.newPlot(
              "monteCarloSensitivityChart",
              traces,
              layout,
              config,
            ).then(() => {
              // Set up parameter toggle functionality
              document.querySelectorAll(".param-toggle").forEach((checkbox) => {
                checkbox.addEventListener("change", function () {
                  const paramIndex = parseInt(
                    this.getAttribute("data-param-index"),
                  );
                  const chartDiv = document.getElementById(
                    "monteCarloSensitivityChart",
                  );

                  if (!chartDiv || !chartDiv.data) return;

                  // Toggle visibility of main trace and base line (every 3rd trace starting from paramIndex)
                  // Each parameter has: main line, base line, base marker = 3 traces
                  const traceIndices = [
                    paramIndex * 3,
                    paramIndex * 3 + 1,
                    paramIndex * 3 + 2,
                  ];

                  const update = {
                    visible: traceIndices.map((idx) =>
                      this.checked ? true : "legendonly",
                    ),
                  };

                  Plotly.restyle(chartDiv, update, traceIndices);
                });
              });
            });

            // Add reset zoom function
            if (typeof window.resetChartZoom === "undefined") {
              window.resetChartZoom = function (chartId) {
                const chartDiv = document.getElementById(chartId);
                if (chartDiv && chartDiv.layout) {
                  Plotly.relayout(chartDiv, {
                    "xaxis.autorange": true,
                    "yaxis.autorange": true,
                  });
                }
              };
            }

            // Render impact bar chart
            const impactData = sensitivities
              .map((sens, idx) => ({
                parameter: sens.parameter,
                impact: sens.impact * 100,
                color: colors[idx % colors.length],
              }))
              .sort((a, b) => b.impact - a.impact); // Sort by impact descending

            const impactTrace = {
              x: impactData.map((d) => d.impact),
              y: impactData.map((d) => d.parameter),
              type: "bar",
              orientation: "h",
              marker: {
                color: impactData.map((d) => d.color),
                line: {
                  color: impactData.map((d) => d.color),
                  width: 1.5,
                },
              },
              text: impactData.map((d) => `${d.impact.toFixed(1)}%`),
              textposition: "outside",
              hovertemplate:
                "<b>%{y}</b><br>Impact: <b>%{x:.1f}%</b><br>Range: <b>%{customdata[0]:.1f}%</b> - <b>%{customdata[1]:.1f}%</b><extra></extra>",
              customdata: impactData
                .map((d) => {
                  const sens = sensitivities.find(
                    (s) => s.parameter === d.parameter,
                  );
                  return [
                    [sens.min_probability * 100, sens.max_probability * 100],
                  ];
                })
                .flat(),
            };

            const impactLayout = {
              ...unifiedChartConfig,
              title: {
                text: "Parameter Impact Ranking",
                font: { size: 16, color: "#2c3e50", weight: "bold" },
                x: 0.5,
                xanchor: "center",
              },
              xaxis: {
                title: {
                  text: "Impact Range (%)",
                  font: { size: 13, color: "#2c3e50" },
                },
                gridcolor: "#e0e4e7",
                range: [0, Math.max(...impactData.map((d) => d.impact)) * 1.15],
              },
              yaxis: {
                title: "",
                gridcolor: "#e0e4e7",
                tickfont: { size: 12, color: "#2c3e50" },
              },
              margin: { l: 150, r: 50, t: 50, b: 50 },
              hovermode: "closest",
              shapes: [
                {
                  type: "line",
                  x0: baseProb,
                  x1: baseProb,
                  y0: -0.5,
                  y1: impactData.length - 0.5,
                  line: {
                    color: "#dc3545",
                    width: 2,
                    dash: "dot",
                  },
                  layer: "below",
                },
              ],
              annotations: [
                {
                  text: `Base: ${baseProb.toFixed(1)}%`,
                  x: baseProb,
                  y: impactData.length - 0.5,
                  xanchor: "left",
                  yanchor: "top",
                  showarrow: true,
                  arrowhead: 2,
                  arrowcolor: "#dc3545",
                  font: { color: "#dc3545", size: 11 },
                },
              ],
            };

            Plotly.newPlot(
              "mcSensitivityImpactChart",
              [impactTrace],
              impactLayout,
              {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ["lasso2d", "select2d"],
                displaylogo: false,
              },
            );

            // Render subplot grid for individual parameters
            const subplotRows = Math.ceil(sensitivities.length / 2);
            const subplotCols = 2;

            const subplotTraces = [];
            sensitivities.forEach((sens, idx) => {
              const row = Math.floor(idx / 2) + 1;
              const col = (idx % 2) + 1;

              const xValues = sens.values.map((v) => v.value);
              const yValues = sens.values.map((v) => v.npv_probability * 100);

              const formatXValue = (val, param) => {
                if (param.includes("Price")) {
                  return val / 1000;
                } else if (
                  param.includes("Rate") &&
                  !param.includes("Occupancy")
                ) {
                  return val * 100;
                } else if (param.includes("Occupancy")) {
                  return val * 100;
                } else {
                  return val;
                }
              };

              const xFormatted = xValues.map((v) =>
                formatXValue(v, sens.parameter),
              );
              const baseFormatted = formatXValue(
                sens.base_value,
                sens.parameter,
              );

              subplotTraces.push({
                x: xFormatted,
                y: yValues,
                type: "scatter",
                mode: "lines+markers",
                name: sens.parameter,
                line: {
                  color: colors[idx % colors.length],
                  width: 2,
                },
                marker: {
                  size: 6,
                  color: colors[idx % colors.length],
                },
                hovertemplate: `<b>${sens.parameter}</b><br>Value: <b>%{x:.2f}${sens.parameter.includes("Price") ? "k CHF" : sens.parameter.includes("Rate") || sens.parameter.includes("Occupancy") ? "%" : ""}</b><br>Probability: <b>%{y:.1f}%</b><extra></extra>`,
                xaxis: `x${idx + 1}`,
                yaxis: `y${idx + 1}`,
                showlegend: false,
              });

              // Add base value line
              subplotTraces.push({
                x: [baseFormatted, baseFormatted],
                y: [0, 100],
                type: "scatter",
                mode: "lines",
                line: {
                  color: colors[idx % colors.length],
                  width: 1.5,
                  dash: "dash",
                },
                xaxis: `x${idx + 1}`,
                yaxis: `y${idx + 1}`,
                showlegend: false,
                hoverinfo: "skip",
              });
            });

            // Create subplot layout
            const subplotLayout = {
              ...unifiedChartConfig,
              grid: {
                rows: subplotRows,
                columns: subplotCols,
                pattern: "independent",
                roworder: "top to bottom",
              },
              title: {
                text: "Individual Parameter Sensitivity Curves",
                font: { size: 16, color: "#2c3e50", weight: "bold" },
                x: 0.5,
                xanchor: "center",
              },
              height: 200 * subplotRows,
              margin: { l: 60, r: 30, t: 60, b: 50 },
            };

            // Configure individual subplot axes
            sensitivities.forEach((sens, idx) => {
              const formatXValue = (val, param) => {
                if (param.includes("Price")) {
                  return val / 1000;
                } else if (
                  param.includes("Rate") &&
                  !param.includes("Occupancy")
                ) {
                  return val * 100;
                } else if (param.includes("Occupancy")) {
                  return val * 100;
                } else {
                  return val;
                }
              };

              subplotLayout[`xaxis${idx + 1 === 1 ? "" : idx + 1}`] = {
                title: {
                  text: idx % 2 === 0 ? sens.parameter : "",
                  font: { size: 11, color: "#2c3e50" },
                },
                gridcolor: "#e0e4e7",
              };

              subplotLayout[`yaxis${idx + 1 === 1 ? "" : idx + 1}`] = {
                title: {
                  text: idx < 2 ? "NPV > 0 Probability (%)" : "",
                  font: { size: 11, color: "#2c3e50" },
                },
                gridcolor: "#e0e4e7",
                range: [0, 100],
              };
            });

            Plotly.newPlot(
              "mcSensitivitySubplots",
              subplotTraces,
              subplotLayout,
              {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ["lasso2d", "select2d"],
                displaylogo: false,
              },
            );
          }
        },

        async renderScenarioComparison() {
          const content = document.getElementById("contentArea");
          content.innerHTML = `
            <div class="loading">
              <i class="fas fa-spinner"></i>
              <p>Loading scenario comparison...</p>
            </div>
          `;

          try {
            // Load all case data
            const comparisonData = [];
            const cases = State.cases || [];

            for (const caseInfo of cases) {
              try {
                const data = await DataManager.loadCaseData(
                  caseInfo.case_name,
                  "base_case",
                );

                const results = data.annual_results || {};
                const irrResults = data.irr_results || {};
                const config = data.config || {};
                const financing = config.financing || {};
                const rental = config.rental || {};

                comparisonData.push({
                  caseName: caseInfo.case_name,
                  displayName: caseInfo.display_name || caseInfo.case_name,
                  // Key metrics
                  afterTaxCashFlowPerOwner:
                    results.after_tax_cash_flow_per_owner || 0,
                  afterTaxCashFlowTotal: results.after_tax_cash_flow_total || 0,
                  equityIRR: irrResults.equity_irr_with_sale_pct || 0,
                  projectIRR: irrResults.project_irr_with_sale_pct || 0,
                  cashOnCash: data.kpis?.cash_on_cash_return_pct || 0,
                  moic: irrResults.moic || 0,
                  // Investment details
                  purchasePrice: financing.purchase_price || 0,
                  numOwners: financing.num_owners || 0,
                  equityPerOwner: financing.equity_per_owner || 0,
                  totalInitialInvestmentPerOwner:
                    financing.total_initial_investment_per_owner || 0,
                  // Revenue & expenses
                  grossRentalIncome: results.gross_rental_income || 0,
                  netOperatingIncome: results.net_operating_income || 0,
                  // Financing
                  interestRate: (financing.interest_rate || 0) * 100,
                  ltv: (financing.ltv || 0) * 100,
                  // Rental
                  occupancyRate: (rental.occupancy_rate || 0) * 100,
                  averageDailyRate: rental.average_daily_rate || 0,
                });
              } catch (error) {
                console.warn(
                  `Failed to load data for ${caseInfo.case_name}:`,
                  error,
                );
              }
            }

            // Sort by after-tax cash flow per owner (descending)
            comparisonData.sort(
              (a, b) => b.afterTaxCashFlowPerOwner - a.afterTaxCashFlowPerOwner,
            );

            // Helper function for formatting
            const formatCHF = (value) => {
              return value.toLocaleString("en-US", {
                style: "currency",
                currency: "CHF",
                maximumFractionDigits: 0,
              });
            };

            const formatPercent = (value) => {
              return value.toFixed(2) + "%";
            };

            // Build comparison table HTML
            let tableRows = "";
            comparisonData.forEach((scenario, index) => {
              const isPositive = scenario.afterTaxCashFlowPerOwner >= 0;
              const rowColor = isPositive
                ? "var(--color-positive)"
                : "var(--color-negative)";
              const bgColor = isPositive
                ? "rgba(40, 167, 69, 0.05)"
                : "rgba(220, 53, 69, 0.05)";
              const isEven = index % 2 === 0;
              const finalBgColor = isEven
                ? bgColor
                : isPositive
                  ? "rgba(40, 167, 69, 0.08)"
                  : "rgba(220, 53, 69, 0.08)";

              tableRows += `
                <tr style="background: ${finalBgColor}; transition: all 0.2s ease; cursor: pointer;" 
                    onmouseover="this.style.background='${isPositive ? "rgba(40, 167, 69, 0.15)" : "rgba(220, 53, 69, 0.15)"}'; this.style.transform='scale(1.01)';" 
                    onmouseout="this.style.background='${finalBgColor}'; this.style.transform='scale(1)';">
                  <td style="font-weight: 600; color: var(--primary); padding: var(--space-md); border-bottom: 1px solid var(--gray-200);">${scenario.displayName}</td>
                  <td style="text-align: right; font-weight: 700; color: ${rowColor}; padding: var(--space-md); border-bottom: 1px solid var(--gray-200);">
                    ${formatCHF(scenario.afterTaxCashFlowPerOwner)}
                  </td>
                  <td style="text-align: right; padding: var(--space-md); border-bottom: 1px solid var(--gray-200);">${formatPercent(scenario.equityIRR)}</td>
                  <td style="text-align: right; padding: var(--space-md); border-bottom: 1px solid var(--gray-200);">${formatPercent(scenario.cashOnCash)}</td>
                  <td style="text-align: right; padding: var(--space-md); border-bottom: 1px solid var(--gray-200);">${scenario.moic.toFixed(2)}x</td>
                  <td style="text-align: right; padding: var(--space-md); border-bottom: 1px solid var(--gray-200);">${formatCHF(scenario.totalInitialInvestmentPerOwner)}</td>
                  <td style="text-align: right; padding: var(--space-md); border-bottom: 1px solid var(--gray-200);">${formatPercent(scenario.interestRate)}</td>
                  <td style="text-align: right; padding: var(--space-md); border-bottom: 1px solid var(--gray-200);">${scenario.numOwners}</td>
                </tr>
              `;
            });

            // Prepare chart data
            const scenarioNames = comparisonData.map((s) => s.displayName);
            const atcfValues = comparisonData.map(
              (s) => s.afterTaxCashFlowPerOwner,
            );
            const colors = atcfValues.map((v) =>
              v >= 0 ? "#28a745" : "#dc3545",
            );

            let html = `
              <div class="section">
                <h2 class="section-title">üìä Scenario Comparison</h2>
                
                <div style="background: linear-gradient(135deg, var(--accent) 0%, var(--secondary) 100%); color: white; padding: var(--space-md) var(--space-lg); border-radius: var(--radius-lg); margin-bottom: var(--space-lg); box-shadow: var(--shadow-md);">
                  <p style="margin: 0; font-size: var(--font-size-sm); line-height: 1.6; opacity: 0.98; font-weight: 500;">
                    üí° <strong>Compare All Scenarios</strong> ‚Äî Side-by-side comparison of key financial metrics across all investment scenarios. Focus on <strong>After-Tax Cash Flow per Person</strong> as the primary decision metric.
                  </p>
                </div>

                <!-- Key Metrics Chart -->
                <div class="chart-container" style="padding: var(--space-lg); margin-bottom: var(--space-xl); background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-md);">
                  <h3 style="margin-bottom: var(--space-md); font-size: var(--font-size-xl); color: var(--primary); font-weight: 700;">
                    üí∞ After-Tax Cash Flow per Person (Year 1)
                  </h3>
                  <p style="color: var(--gray-500); margin-bottom: var(--space-md); font-size: var(--font-size-sm); line-height: 1.6;">
                    <span style="color: var(--color-positive); font-weight: 600;">‚ñ†</span> Positive cash flow | 
                    <span style="color: var(--color-negative); font-weight: 600;">‚ñ†</span> Negative cash flow | 
                    Hover for details
                  </p>
                  <div class="chart-wrapper" id="comparisonChart" style="min-height: 500px; height: auto; overflow: visible;"></div>
                </div>

                <!-- Comprehensive Comparison Table -->
                <div class="chart-container" style="padding: var(--space-lg); background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-md); overflow-x: auto;">
                  <h3 style="margin-bottom: var(--space-md); font-size: var(--font-size-xl); color: var(--primary); font-weight: 700;">
                    üìã Detailed Comparison Table
                  </h3>
                  <table style="width: 100%; border-collapse: collapse; font-size: var(--font-size-sm); box-shadow: var(--shadow-sm);">
                    <thead>
                      <tr style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white;">
                        <th style="padding: var(--space-md); text-align: left; font-weight: 700; border-bottom: 3px solid var(--accent);">Scenario</th>
                        <th style="padding: var(--space-md); text-align: right; font-weight: 700; border-bottom: 3px solid var(--accent);">
                          After-Tax Cash Flow<br><span style="font-size: 0.85em; opacity: 0.9;">(per person/year)</span>
                        </th>
                        <th style="padding: var(--space-md); text-align: right; font-weight: 700; border-bottom: 3px solid var(--accent);">Equity IRR</th>
                        <th style="padding: var(--space-md); text-align: right; font-weight: 700; border-bottom: 3px solid var(--accent);">Cash-on-Cash</th>
                        <th style="padding: var(--space-md); text-align: right; font-weight: 700; border-bottom: 3px solid var(--accent);">MOIC</th>
                        <th style="padding: var(--space-md); text-align: right; font-weight: 700; border-bottom: 3px solid var(--accent);">Initial Investment<br><span style="font-size: 0.85em; opacity: 0.9;">(per person)</span></th>
                        <th style="padding: var(--space-md); text-align: right; font-weight: 700; border-bottom: 3px solid var(--accent);">Interest Rate</th>
                        <th style="padding: var(--space-md); text-align: right; font-weight: 700; border-bottom: 3px solid var(--accent);"># Owners</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${tableRows}
                    </tbody>
                  </table>
                </div>

                <!-- Additional Metrics Summary -->
                <div class="kpi-grid" style="margin-top: var(--space-xl);">
                  <div class="kpi-card" style="border: 2px solid var(--color-positive); background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);">
                    <h3>Best Cash Flow</h3>
                    <div class="value" style="color: var(--color-positive); font-size: var(--font-size-2xl);">
                      ${formatCHF(comparisonData[0]?.afterTaxCashFlowPerOwner || 0)}
                    </div>
                    <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">
                      ${comparisonData[0]?.displayName || "N/A"}
                    </div>
                  </div>
                  <div class="kpi-card" style="border: 2px solid var(--accent); background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%);">
                    <h3>Best Equity IRR</h3>
                    <div class="value" style="color: var(--accent); font-size: var(--font-size-2xl);">
                      ${formatPercent(Math.max(...comparisonData.map((s) => s.equityIRR)))}
                    </div>
                    <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">
                      ${comparisonData.find((s) => s.equityIRR === Math.max(...comparisonData.map((s) => s.equityIRR)))?.displayName || "N/A"}
                    </div>
                  </div>
                  <div class="kpi-card" style="border: 2px solid var(--color-info); background: linear-gradient(135deg, #e6f7ff 0%, #bae7ff 100%);">
                    <h3>Best MOIC</h3>
                    <div class="value" style="color: var(--color-info); font-size: var(--font-size-2xl);">
                      ${Math.max(...comparisonData.map((s) => s.moic)).toFixed(2)}x
                    </div>
                    <div class="unit" style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-xs);">
                      ${comparisonData.find((s) => s.moic === Math.max(...comparisonData.map((s) => s.moic)))?.displayName || "N/A"}
                    </div>
                  </div>
                  <div class="kpi-card">
                    <h3>Total Scenarios</h3>
                    <div class="value" style="color: var(--primary); font-size: var(--font-size-2xl);">
                      ${comparisonData.length}
                    </div>
                  </div>
                </div>
              </div>
            `;

            content.innerHTML = html;

            // Render comparison chart
            const trace = {
              x: atcfValues,
              y: scenarioNames,
              type: "bar",
              orientation: "h",
              marker: {
                color: colors,
                line: {
                  color: colors.map((c) =>
                    c === "#28a745" ? "#1e7e34" : "#c82333",
                  ),
                  width: 1.5,
                },
              },
              text: atcfValues.map((v) => formatCHF(v)),
              textposition: "outside",
              hovertemplate:
                "<b>%{y}</b><br>" +
                "After-Tax Cash Flow: <b>%{text}</b><br>" +
                "<extra></extra>",
            };

            const layout = {
              ...unifiedChartConfig,
              title: "",
              xaxis: {
                title: {
                  text: "After-Tax Cash Flow per Person (CHF)",
                  font: { size: 15, color: "#2c3e50", family: "Segoe UI" },
                  standoff: 12,
                },
                zeroline: true,
                zerolinewidth: 3,
                zerolinecolor: "#667eea",
                gridcolor: "#e0e4e7",
                gridwidth: 1,
                tickformat: "$,.0f",
                tickprefix: "CHF ",
                tickfont: { size: 13, color: "#5a6c7d" },
              },
              yaxis: {
                title: "",
                autorange: "reversed",
                tickfont: { size: 13, color: "#2c3e50", family: "Segoe UI" },
              },
              height: Math.max(500, 300 + scenarioNames.length * 50),
              margin: { l: 200, r: 50, t: 20, b: 60 },
              hovermode: "closest",
            };

            Plotly.newPlot("comparisonChart", [trace], layout, {
              responsive: true,
              displayModeBar: true,
              modeBarButtonsToRemove: ["lasso2d", "select2d"],
              displaylogo: false,
            }).then(() => {
              const chartDiv = document.getElementById("comparisonChart");
              if (chartDiv && chartDiv.layout) {
                chartDiv.style.height = layout.height + "px";
                chartDiv.style.minHeight = layout.height + "px";
                chartDiv.style.overflow = "visible";
              }
            });
          } catch (error) {
            console.error("Error loading scenario comparison:", error);
            UIManager.showError(`
              <h3>Failed to load scenario comparison</h3>
              <p>${error.message || "Unknown error"}</p>
              <p style="margin-top: 15px; font-size: 0.9em; color: #666;">
                <strong>To fix this:</strong><br>
                Make sure all scenario data files are generated by running:<br>
                <code>python scripts/generate_all_data.py</code>
              </p>
            `);
          }
        },
      };

      // Main Controller
      const Controller = {
        async init() {
          // Load cases index
          await DataManager.loadCasesIndex();
          UIManager.populateCaseSelector();

          // Set up event listeners
          document
            .getElementById("caseSelect")
            .addEventListener("change", (e) => {
              State.currentCase = e.target.value;
              Controller.loadAnalysis();
            });

          document.querySelectorAll(".sidebar-menu-item").forEach((item) => {
            item.addEventListener("click", () => {
              State.currentAnalysis = item.dataset.analysis;
              UIManager.updateAnalysisMenu(State.currentAnalysis);
              Controller.loadAnalysis();
            });
          });

          // Load initial analysis
          if (State.currentCase) {
            await Controller.loadAnalysis();
          }
        },

        async loadAnalysis() {
          // Scenario comparison doesn't need a current case
          if (
            !State.currentCase &&
            State.currentAnalysis !== "scenario_comparison"
          ) {
            UIManager.showError("Please select a case");
            return;
          }

          UIManager.showLoading();

          try {
            // Scenario comparison loads all cases, so skip single case loading
            if (State.currentAnalysis === "scenario_comparison") {
              ChartRenderer.renderScenarioComparison();
              return;
            }

            const data = await DataManager.loadCaseData(
              State.currentCase,
              State.currentAnalysis,
            );

            if (State.currentAnalysis === "base_case") {
              ChartRenderer.renderBaseCase(data);
            } else if (State.currentAnalysis === "sensitivity") {
              ChartRenderer.renderSensitivity(data);
            } else if (State.currentAnalysis === "sensitivity_coc") {
              ChartRenderer.renderSensitivityCoC(data);
            } else if (State.currentAnalysis === "sensitivity_ncf") {
              ChartRenderer.renderSensitivityNCF(data);
            } else if (State.currentAnalysis === "monte_carlo") {
              ChartRenderer.renderMonteCarlo(data);
            } else if (State.currentAnalysis === "monte_carlo_sensitivity") {
              ChartRenderer.renderMonteCarloSensitivity(data);
            }
          } catch (error) {
            const errorMsg = error.message || "Unknown error";
            UIManager.showError(`
                        <h3>Failed to load ${State.currentAnalysis} data</h3>
                        <p>${errorMsg}</p>
                        <p style="margin-top: 15px; font-size: 0.9em; color: #666;">
                            <strong>To fix this:</strong><br>
                            1. Run <code>python analysis_base_case.py</code> to generate base case data<br>
                            2. Run <code>python analysis_sensitivity.py</code> to generate sensitivity data<br>
                            3. Run <code>python analysis_monte_carlo.py</code> to generate Monte Carlo data<br>
                            4. Or run <code>python generate_all_data.py</code> to generate all data at once
                        </p>
                    `);
          }
        },
      };

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", () => {
        Controller.init();
      });
    </script>
  </body>
</html>
