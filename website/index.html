<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.plot.ly; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; img-src 'self' data:; font-src 'self' https://cdnjs.cloudflare.com; connect-src 'self'; object-src 'none'; base-uri 'self'; frame-ancestors 'self'; form-action 'self'"
    />
    <title>Engelberg Property Investment - Dynamic Dashboard</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary: #1a1a2e;
        --secondary: #0f3460;
        --accent: #667eea;
        --success: #28a745;
        --danger: #dc3545;
        --warning: #ffc107;
        --info: #17a2b8;
        --light: #f8f9fa;
        --dark: #2c3e50;
        --border: #dee2e6;
        --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        --sidebar-width: 250px;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto",
          "Helvetica Neue", Arial, sans-serif;
        background: #f5f6fa;
        color: var(--dark);
        line-height: 1.5;
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
      }

      /* Top Navigation Bar */
      .top-bar {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        color: white;
        padding: 15px 30px;
        box-shadow: var(--shadow);
        display: flex;
        align-items: center;
        justify-content: space-between;
        z-index: 1000;
      }

      .top-bar h1 {
        font-size: 1.5em;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .case-selector {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .case-selector label {
        font-weight: 600;
        margin-right: 10px;
      }

      .case-selector select {
        padding: 8px 15px;
        border-radius: 6px;
        border: none;
        background: white;
        color: var(--primary);
        font-size: 0.95em;
        cursor: pointer;
        min-width: 200px;
      }

      .case-selector select:focus {
        outline: 2px solid var(--accent);
      }

      /* Main Layout */
      .main-layout {
        display: flex;
        flex: 1;
        overflow: hidden;
      }

      /* Sidebar */
      .sidebar {
        width: var(--sidebar-width);
        background: white;
        border-right: 1px solid var(--border);
        overflow-y: auto;
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.05);
      }

      .sidebar-header {
        padding: 20px;
        background: var(--light);
        border-bottom: 1px solid var(--border);
        font-weight: 600;
        color: var(--primary);
      }

      .sidebar-menu {
        list-style: none;
        padding: 10px 0;
      }

      .sidebar-menu-item {
        padding: 12px 20px;
        cursor: pointer;
        transition: all 0.2s;
        border-left: 3px solid transparent;
      }

      .sidebar-menu-item:hover {
        background: var(--light);
        border-left-color: var(--accent);
      }

      .sidebar-menu-item.active {
        background: rgba(102, 126, 234, 0.1);
        border-left-color: var(--accent);
        font-weight: 600;
        color: var(--accent);
      }

      .sidebar-menu-item i {
        width: 20px;
        margin-right: 10px;
      }

      /* Main Content Area */
      .content-area {
        flex: 1;
        overflow-y: auto;
        padding: 30px;
        background: #f5f6fa;
      }

      .loading {
        text-align: center;
        padding: 60px 20px;
        color: #666;
      }

      .loading i {
        font-size: 3em;
        margin-bottom: 20px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .error {
        background: #fee;
        border: 1px solid var(--danger);
        color: var(--danger);
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
      }

      /* KPI Cards */
      .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .kpi-card {
        background: white;
        padding: 12px 16px;
        border-radius: 8px;
        box-shadow: var(--shadow);
        border-left: 4px solid var(--accent);
        min-width: 140px;
      }

      .kpi-card h3 {
        font-size: 0.7em;
        color: #666;
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        line-height: 1.2;
      }

      .kpi-card .value {
        font-size: 1.4em;
        font-weight: 700;
        color: var(--primary);
      }

      .kpi-card .value.positive {
        color: var(--success);
      }

      .kpi-card .value.negative {
        color: var(--danger);
      }

      /* Chart Container */
      .chart-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: var(--shadow);
        margin-bottom: 30px;
      }

      .chart-container h3 {
        margin-bottom: 20px;
        color: var(--primary);
        font-size: 1.2em;
      }

      .chart-wrapper {
        width: 100%;
        height: 400px;
      }

      /* Table */
      .data-table {
        background: white;
        border-radius: 8px;
        box-shadow: var(--shadow);
        overflow: hidden;
        margin-bottom: 30px;
      }

      .data-table table {
        width: 100%;
        border-collapse: collapse;
      }

      .data-table th {
        background: var(--light);
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: var(--primary);
        border-bottom: 2px solid var(--border);
      }

      .data-table td {
        padding: 12px;
        border-bottom: 1px solid var(--border);
      }

      .data-table tr:hover {
        background: var(--light);
      }

      /* Section */
      .section {
        margin-bottom: 40px;
      }

      .section-title {
        font-size: 1.5em;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--border);
      }

      /* Mobile Responsive */
      @media (max-width: 768px) {
        .main-layout {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
          max-height: 200px;
          border-right: none;
          border-bottom: 1px solid var(--border);
        }

        .top-bar {
          flex-direction: column;
          gap: 15px;
          padding: 15px;
        }

        .case-selector {
          width: 100%;
        }

        .case-selector select {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <!-- Top Navigation Bar -->
    <div class="top-bar">
      <h1><i class="fas fa-chart-line"></i> Engelberg Property Investment</h1>
      <div class="case-selector">
        <label for="caseSelect">Case:</label>
        <select id="caseSelect">
          <option value="">Loading cases...</option>
        </select>
      </div>
    </div>

    <!-- Main Layout -->
    <div class="main-layout">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-header">
          <i class="fas fa-list"></i> Analysis Types
        </div>
        <ul class="sidebar-menu" id="analysisMenu">
          <li class="sidebar-menu-item active" data-analysis="base_case">
            <i class="fas fa-home"></i> Simulation KPIs
          </li>
          <li class="sidebar-menu-item" data-analysis="sensitivity">
            <i class="fas fa-sliders-h"></i> Sensitivity - Equity IRR
          </li>
          <li class="sidebar-menu-item" data-analysis="sensitivity_coc">
            <i class="fas fa-dollar-sign"></i> Sensitivity - Cash-on-Cash
          </li>
          <li class="sidebar-menu-item" data-analysis="sensitivity_ncf">
            <i class="fas fa-wallet"></i> Sensitivity - Monthly NCF
          </li>
          <li class="sidebar-menu-item" data-analysis="monte_carlo">
            <i class="fas fa-dice"></i> Monte Carlo
          </li>
        </ul>
      </div>

      <!-- Main Content Area -->
      <div class="content-area" id="contentArea">
        <div class="loading">
          <i class="fas fa-spinner"></i>
          <p>Loading data...</p>
        </div>
      </div>
    </div>

    <script>
      // State Management
      const State = {
        currentCase: null,
        currentAnalysis: "base_case",
        cases: [],
        data: {},
      };

      // Data Manager
      const DataManager = {
        async loadCasesIndex() {
          try {
            const response = await fetch("data/cases_index.json");
            if (!response.ok) {
              // If cases_index.json doesn't exist, create a default one with base_case
              console.warn("cases_index.json not found, using default");
              return {
                cases: [
                  {
                    case_name: "base_case",
                    display_name: "Base Case",
                    data_files: {
                      base_case_analysis: "base_case_base_case_analysis.json",
                    },
                  },
                ],
              };
            }
            const index = await response.json();
            State.cases = index.cases || [];
            return index;
          } catch (error) {
            console.error("Error loading cases index:", error);
            // Return default case if index doesn't exist
            return {
              cases: [
                {
                  case_name: "base_case",
                  display_name: "Base Case",
                  data_files: {
                    base_case_analysis: "base_case_base_case_analysis.json",
                  },
                },
              ],
            };
          }
        },

        async loadCaseData(caseName, analysisType) {
          const key = `${caseName}_${analysisType}`;
          if (State.data[key]) {
            return State.data[key];
          }

          try {
            let path;
            if (analysisType === "base_case") {
              // Handle both naming conventions
              path = `data/${caseName}_base_case_analysis.json`;
              // For base_case, also try the alternative naming
              if (caseName === "base_case") {
                // Try alternative path first
                const altPath = "data/base_case_base_case_analysis.json";
                try {
                  const altResponse = await fetch(altPath);
                  if (altResponse.ok) {
                    const data = await altResponse.json();
                    State.data[key] = data;
                    return data;
                  }
                } catch (e) {
                  // Fall through to try main path
                }
              }
            } else if (analysisType === "sensitivity") {
              path = `data/${caseName}_sensitivity.json`;
            } else if (analysisType === "sensitivity_coc") {
              path = `data/${caseName}_sensitivity_coc.json`;
            } else if (analysisType === "sensitivity_ncf") {
              path = `data/${caseName}_sensitivity_ncf.json`;
            } else if (analysisType === "monte_carlo") {
              path = `data/${caseName}_monte_carlo.json`;
            }

            const response = await fetch(path);
            if (!response.ok) {
              throw new Error(
                `Failed to load ${path}. Make sure you have run the analysis scripts to generate the data files.`
              );
            }
            const data = await response.json();
            State.data[key] = data;
            return data;
          } catch (error) {
            console.error(`Error loading ${analysisType} data:`, error);
            throw error;
          }
        },
      };

      // UI Manager
      const createStatusElement = (iconClass, text, type) => {
        const container = document.createElement("div");
        container.className = type === "error" ? "error" : "loading";

        const icon = document.createElement("i");
        icon.className = iconClass;

        const message = document.createElement("p");
        message.textContent = text;

        container.appendChild(icon);
        container.appendChild(message);

        return container;
      };

      const UIManager = {
        populateCaseSelector() {
          const select = document.getElementById("caseSelect");
          select.innerHTML = "";

          if (State.cases.length === 0) {
            select.innerHTML = '<option value="">No cases available</option>';
            return;
          }

          State.cases.forEach((caseInfo) => {
            const option = document.createElement("option");
            option.value = caseInfo.case_name;
            option.textContent = caseInfo.display_name || caseInfo.case_name;
            if (caseInfo.case_name === "base_case") {
              option.selected = true;
              State.currentCase = "base_case";
            }
            select.appendChild(option);
          });
        },

        updateAnalysisMenu(activeAnalysis) {
          document.querySelectorAll(".sidebar-menu-item").forEach((item) => {
            item.classList.remove("active");
            if (item.dataset.analysis === activeAnalysis) {
              item.classList.add("active");
            }
          });
        },

        showLoading() {
          const content = document.getElementById("contentArea");
          content.replaceChildren(
            createStatusElement("fas fa-spinner", "Loading data...", "loading")
          );
        },

        showError(message) {
          const content = document.getElementById("contentArea");
          content.replaceChildren(
            createStatusElement(
              "fas fa-exclamation-triangle",
              String(message),
              "error"
            )
          );
        },
      };

      // Chart Renderer
      const ChartRenderer = {
        renderBaseCase(data) {
          const content = document.getElementById("contentArea");
          const results = data.annual_results || {};
          const kpis = data.kpis || {};
          const irr = data.irr_results || {};
          const projection = data.projection_15yr || [];

          let html = `
                    <div class="section">
                        <h2 class="section-title">Model</h2>
                        
                        <div class="kpi-grid">
                            <div class="kpi-card">
                                <h3>Equity IRR (15Y)</h3>
                                <div class="value positive">${(
                                  irr.equity_irr_with_sale_pct || 0
                                ).toFixed(2)}%</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Project IRR</h3>
                                <div class="value positive">${(
                                  irr.project_irr_with_sale_pct || 0
                                ).toFixed(2)}%</div>
                            </div>
                            <div class="kpi-card">
                                <h3>NPV @ 5%</h3>
                                <div class="value ${
                                  (irr.npv_at_5pct || 0) >= 0
                                    ? "positive"
                                    : "negative"
                                }">${(irr.npv_at_5pct || 0).toLocaleString(
            "en-US",
            {
              style: "currency",
              currency: "CHF",
              maximumFractionDigits: 0,
            }
          )}</div>
                            </div>
                            <div class="kpi-card">
                                <h3>MOIC</h3>
                                <div class="value ${
                                  (irr.moic || 0) >= 1 ? "positive" : "negative"
                                }">${(irr.moic || 0).toFixed(2)}x</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Payback Period</h3>
                                <div class="value">${
                                  irr.payback_period_years
                                    ? irr.payback_period_years + "Y"
                                    : "N/A"
                                }</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Net Operating Income</h3>
                                <div class="value">${(
                                  results.net_operating_income || 0
                                ).toLocaleString("en-US", {
                                  style: "currency",
                                  currency: "CHF",
                                  maximumFractionDigits: 0,
                                })}</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Cash Flow After DS</h3>
                                <div class="value ${
                                  results.cash_flow_after_debt_service >= 0
                                    ? "positive"
                                    : "negative"
                                }">
                                    ${(
                                      results.cash_flow_after_debt_service || 0
                                    ).toLocaleString("en-US", {
                                      style: "currency",
                                      currency: "CHF",
                                      maximumFractionDigits: 0,
                                    })}
                                </div>
                            </div>
                            <div class="kpi-card">
                                <h3>Cash Flow per Owner</h3>
                                <div class="value ${
                                  results.cash_flow_per_owner >= 0
                                    ? "positive"
                                    : "negative"
                                }">
                                    ${(
                                      results.cash_flow_per_owner || 0
                                    ).toLocaleString("en-US", {
                                      style: "currency",
                                      currency: "CHF",
                                      maximumFractionDigits: 0,
                                    })}
                                </div>
                            </div>
                            <div class="kpi-card">
                                <h3>Debt Service Coverage</h3>
                                <div class="value">${(
                                  results.debt_coverage_ratio || 0
                                ).toFixed(2)}x</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Interest / Month</h3>
                                <div class="value">${(
                                  (results.interest_payment || 0) / 12
                                ).toLocaleString("en-US", {
                                  style: "currency",
                                  currency: "CHF",
                                  maximumFractionDigits: 0,
                                })}</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Principal / Month</h3>
                                <div class="value">${(
                                  (results.amortization_payment || 0) / 12
                                ).toLocaleString("en-US", {
                                  style: "currency",
                                  currency: "CHF",
                                  maximumFractionDigits: 0,
                                })}</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Cap Rate</h3>
                                <div class="value">${(
                                  kpis.cap_rate_pct || 0
                                ).toFixed(2)}%</div>
                            </div>
                        </div>
                        
                        <!-- Assumptions Summary -->
                        <div class="chart-container" style="background: #f8f9fa; border-left: 4px solid var(--accent);">
                            <h3 style="color: var(--primary); margin-bottom: 15px;">üìã Main Assumptions</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; font-size: 0.9em;">
                                <div>
                                    <strong style="color: var(--secondary);">Financing</strong>
                                    <div style="margin-top: 8px; line-height: 1.8;">
                                        ‚Ä¢ Purchase Price: <strong>CHF ${(
                                          data.config?.financing
                                            ?.purchase_price || 0
                                        ).toLocaleString()}</strong><br>
                                        ‚Ä¢ LTV: <strong>${(
                                          (data.config?.financing?.ltv || 0) *
                                          100
                                        ).toFixed(0)}%</strong> (Loan: CHF ${(
            data.config?.financing?.loan_amount || 0
          ).toLocaleString()})<br>
                                        ‚Ä¢ Interest Rate: <strong>${(
                                          (data.config?.financing
                                            ?.interest_rate || 0) * 100
                                        ).toFixed(2)}%</strong><br>
                                        ‚Ä¢ Amortization: <strong>${(
                                          (data.config?.financing
                                            ?.amortization_rate || 0) * 100
                                        ).toFixed(1)}%</strong> per year<br>
                                        ‚Ä¢ Owners: <strong>${
                                          data.config?.financing?.num_owners ||
                                          0
                                        }</strong> (Equity: CHF ${(
            (data.config?.financing?.equity_total || 0) /
            (data.config?.financing?.num_owners || 1)
          ).toLocaleString()}/owner)
                                    </div>
                                </div>
                                <div>
                                    <strong style="color: var(--secondary);">Rental Income</strong>
                                    <div style="margin-top: 8px; line-height: 1.8;">
                                        ‚Ä¢ Occupancy Rate: <strong>${(
                                          (data.config?.rental
                                            ?.occupancy_rate || 0) * 100
                                        ).toFixed(0)}%</strong><br>
                                        ‚Ä¢ Average Daily Rate: <strong>CHF ${(
                                          data.config?.rental
                                            ?.average_daily_rate || 0
                                        ).toFixed(0)}</strong><br>
                                        ‚Ä¢ Rentable Nights: <strong>${
                                          results.rentable_nights || 0
                                        }</strong> nights/year<br>
                                        ‚Ä¢ Rented Nights: <strong>${
                                          results.rented_nights || 0
                                        }</strong> nights/year<br>
                                        ‚Ä¢ Owner Nights: <strong>${
                                          data.config?.rental
                                            ?.owner_nights_per_person || 0
                                        } per owner</strong>
                                    </div>
                                </div>
                                <div>
                                    <strong style="color: var(--secondary);">Projections & Exit</strong>
                                    <div style="margin-top: 8px; line-height: 1.8;">
                                        ‚Ä¢ Inflation: <strong>1.0%</strong> per year<br>
                                        ‚Ä¢ Property Appreciation: <strong>1.5%</strong> per year<br>
                                        ‚Ä¢ Projection Period: <strong>15 years</strong> (2026-2040)<br>
                                        ‚Ä¢ Selling Costs (Year 15): <strong>7.8%</strong><br>
                                        ‚Ä¢ Discount Rate (NPV): <strong>5.0%</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Enhanced 15-Year Projection Table -->
                        <div class="data-table">
                            <h3 style="padding: 20px; margin: 0; border-bottom: 1px solid var(--border);">15-Year Financial Projection</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Year</th>
                                        <th>Revenue</th>
                                        <th>Expenses</th>
                                        <th>NOI</th>
                                        <th>Debt Service</th>
                                        <th>Cash Flow</th>
                                        <th>CF/Owner</th>
                                        <th>Property Value</th>
                                        <th>Loan Balance</th>
                                        <th>Equity</th>
                                        <th>Cap Rate</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${projection
                                      .slice(0, 15)
                                      .map((year) => {
                                        const equity =
                                          year.property_value -
                                          year.remaining_loan_balance;
                                        return `
                                        <tr>
                                            <td><strong>${
                                              year.year
                                            }</strong></td>
                                            <td>${(
                                              year.gross_rental_income || 0
                                            ).toLocaleString("en-US", {
                                              style: "currency",
                                              currency: "CHF",
                                              maximumFractionDigits: 0,
                                            })}</td>
                                            <td>${(
                                              year.total_operating_expenses || 0
                                            ).toLocaleString("en-US", {
                                              style: "currency",
                                              currency: "CHF",
                                              maximumFractionDigits: 0,
                                            })}</td>
                                            <td>${(
                                              year.net_operating_income || 0
                                            ).toLocaleString("en-US", {
                                              style: "currency",
                                              currency: "CHF",
                                              maximumFractionDigits: 0,
                                            })}</td>
                                            <td>${(
                                              year.debt_service || 0
                                            ).toLocaleString("en-US", {
                                              style: "currency",
                                              currency: "CHF",
                                              maximumFractionDigits: 0,
                                            })}</td>
                                            <td style="color: ${
                                              year.cash_flow_after_debt_service >=
                                              0
                                                ? "var(--success)"
                                                : "var(--danger)"
                                            }">${(
                                          year.cash_flow_after_debt_service || 0
                                        ).toLocaleString("en-US", {
                                          style: "currency",
                                          currency: "CHF",
                                          maximumFractionDigits: 0,
                                        })}</td>
                                            <td style="color: ${
                                              year.cash_flow_per_owner >= 0
                                                ? "var(--success)"
                                                : "var(--danger)"
                                            }">${(
                                          year.cash_flow_per_owner || 0
                                        ).toLocaleString("en-US", {
                                          style: "currency",
                                          currency: "CHF",
                                          maximumFractionDigits: 0,
                                        })}</td>
                                            <td>${(
                                              year.property_value || 0
                                            ).toLocaleString("en-US", {
                                              style: "currency",
                                              currency: "CHF",
                                              maximumFractionDigits: 0,
                                            })}</td>
                                            <td>${(
                                              year.remaining_loan_balance || 0
                                            ).toLocaleString("en-US", {
                                              style: "currency",
                                              currency: "CHF",
                                              maximumFractionDigits: 0,
                                            })}</td>
                                            <td>${equity.toLocaleString(
                                              "en-US",
                                              {
                                                style: "currency",
                                                currency: "CHF",
                                                maximumFractionDigits: 0,
                                              }
                                            )}</td>
                                            <td>${year.cap_rate_pct.toFixed(
                                              2
                                            )}%</td>
                                        </tr>
                                    `;
                                      })
                                      .join("")}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

          content.innerHTML = html;
        },

        renderSensitivity(data) {
          const content = document.getElementById("contentArea");
          const sensitivities = data.sensitivities || [];
          const baseIRR = data.base_irr || 0;

          // Parameter explanations and rationales
          const parameterInfo = {
            "Property Appreciation Rate": {
              range: "1.5% to 3.5% (¬±1%)",
              rationale:
                "Property appreciation is the dominant driver of long-term returns. Swiss real estate historically appreciates 2-3% annually. This tests downside (1.5%) and upside (3.5%) scenarios.",
              icon: "üìà",
            },
            "Maintenance Reserve Rate": {
              range: "0.2% to 1.2% (¬±0.5%)",
              rationale:
                "Maintenance reserve accounts for property upkeep and repairs. 0.7% of property value is balanced, but actual costs can vary. Lower rates assume newer property; higher rates account for aging or unexpected repairs.",
              icon: "üîß",
            },
            "Property Management Fee": {
              range: "15% to 25% (¬±5%)",
              rationale:
                "Management companies charge 15-25% of gross revenue. Lower fees possible with local operators or self-management; higher fees include premium services or peak season surcharges.",
              icon: "üè¢",
            },
            "Purchase Price": {
              range: "CHF 1.17M to 1.43M (¬±10%)",
              rationale:
                "Property prices can vary based on negotiation, market conditions, and property condition. Testing ¬±10% shows sensitivity to purchase timing and negotiation success.",
              icon: "üí∞",
            },
            "Occupancy Rate": {
              range: "56.7% to 69.3% (¬±10%)",
              rationale:
                "Occupancy varies with marketing effectiveness, property quality, and market demand. Engelberg averages 63% but can swing based on snow conditions and tourism trends.",
              icon: "üìÖ",
            },
            "Average Daily Rate": {
              range: "CHF 160 to 240 (¬±20%)",
              rationale:
                "Nightly rates fluctuate with seasonality and competition. CHF 200 is the average but can range from CHF 150 (off-peak) to CHF 250+ (peak ski season). Tests pricing strategy impact.",
              icon: "üíµ",
            },
            "Interest Rate": {
              range: "0.3% to 2.3% (¬±1%)",
              rationale:
                "Swiss mortgage rates are currently low (~1.3%) but can change with refinancing or market conditions. Testing ¬±1% covers scenarios from ultra-low to moderate rates.",
              icon: "üìä",
            },
            "Loan-to-Value (LTV)": {
              range: "67.5% to 82.5% (¬±10%)",
              rationale:
                "LTV affects leverage and equity requirement. Swiss banks typically offer 60-80% LTV for investment properties. Higher LTV means less equity needed but more debt risk.",
              icon: "üè¶",
            },
            "Inflation Rate": {
              range: "0.5% to 1.5% (¬±0.5%)",
              rationale:
                "Inflation affects both revenue and expense growth over the 15-year projection. Higher inflation increases future rents but also future costs. Net effect is relatively neutral but compounds over time.",
              icon: "üìä",
            },
            "Amortization Rate": {
              range: "0% (interest-only) to 2%",
              rationale:
                "Amortization rate determines annual principal paydown. 0% (interest-only) maximizes cash flow but keeps debt high. 2% builds equity faster but reduces annual cash flow. Most Swiss mortgages use 1% amortization.",
              icon: "üí≥",
            },
            "Cleaning Cost per Stay": {
              range: "CHF 49 to 91 (¬±30%)",
              rationale:
                "Professional cleaning cost per turnover. With ~130 turnovers annually, this is a significant expense. Negotiating from CHF 80 to CHF 60 saves CHF 2,600/year = CHF 650 per owner.",
              icon: "üßπ",
            },
            "Average Length of Stay": {
              range: "1.19 to 2.21 nights (¬±30%)",
              rationale:
                "Average booking length affects cleaning frequency. Longer stays = fewer turnovers = lower cleaning costs = better cash flow. Offering multi-night discounts can encourage longer stays.",
              icon: "üìÖ",
            },
            "Insurance Rate": {
              range: "0.3% to 0.5% of property value",
              rationale:
                "Annual property insurance as % of value. Covers building, liability, and rental interruption. Shopping around can save CHF 1,300-2,600 annually. Rates vary by coverage level and provider.",
              icon: "üõ°Ô∏è",
            },
            "Winter Season Occupancy": {
              range: "63.75% to 86.25% (¬±15%)",
              rationale:
                "Occupancy specifically during winter ski season (Dec-Mar). This is the premium season with highest rates (CHF 250/night). Targeted winter marketing can significantly boost returns.",
              icon: "‚õ∑Ô∏è",
            },
            "Selling Costs Rate": {
              range: "5.8% to 9.8% (¬±2%)",
              rationale:
                "Total transaction costs when selling at Year 15. Includes broker fees (3%, negotiable 2-4%), notary (1.5%), and transfer tax (3.3% in Obwalden, varies by canton 1-3.3%). Lower costs = more net proceeds.",
              icon: "üìù",
            },
          };

          let html = `
                    <div class="section">
                        <h2 class="section-title">üéØ Sensitivity Analysis</h2>
                        
                        <!-- Info Box -->
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 14px 18px; border-radius: 8px; margin-bottom: 20px;">
                            <p style="margin: 0; font-size: 0.85em; line-height: 1.5; opacity: 0.95;">
                                üí° <strong>Equity IRR Sensitivity</strong> ‚Äî How your 15-year return changes with parameter variations. Ranked by impact. Hover for details.
                            </p>
                        </div>
                        
                        <!-- Summary KPIs -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">
                            <div class="kpi-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; padding: 12px;">
                                <h3 style="color: rgba(255,255,255,0.9); font-size: 0.75em;">Base Equity IRR</h3>
                                <div class="value" style="color: white; font-size: 1.4em;">${baseIRR.toFixed(
                                  2
                                )}%</div>
                            </div>
                            <div class="kpi-card" style="padding: 12px;">
                                <h3 style="font-size: 0.75em;">Parameters</h3>
                                <div class="value" style="color: var(--info); font-size: 1.4em;">${
                                  sensitivities.length
                                }</div>
                            </div>
                            <div class="kpi-card" style="padding: 12px;">
                                <h3 style="font-size: 0.75em;">Top Impact</h3>
                                <div class="value" style="color: var(--warning); font-size: 1.4em;">¬±${(
                                  sensitivities[0]?.impact || 0
                                ).toFixed(2)}%</div>
                                <div class="unit" style="font-size: 0.7em;">${
                                  sensitivities[0]?.parameter || "N/A"
                                }</div>
                            </div>
                            <div class="kpi-card" style="padding: 12px;">
                                <h3 style="font-size: 0.75em;">IRR Range</h3>
                                <div class="value" style="color: var(--success); font-size: 1.2em;">${Math.min(
                                  ...sensitivities.map((s) =>
                                    Math.min(s.low.irr, s.high.irr)
                                  )
                                ).toFixed(1)}% - ${Math.max(
            ...sensitivities.map((s) => Math.max(s.low.irr, s.high.irr))
          ).toFixed(1)}%</div>
                            </div>
                        </div>
                        
                        <!-- Tornado Chart -->
                        <div class="chart-container" style="padding: 20px; margin-bottom: 25px;">
                            <h3 style="margin-bottom: 12px; font-size: 1.1em; color: var(--primary); font-weight: 600;">
                                üìä Tornado Chart - Parameter Impact on Equity IRR
                            </h3>
                            <p style="color: #7f8c8d; margin-bottom: 15px; font-size: 0.85em; line-height: 1.5;">
                                <span style="color: #2ecc71;">‚ñ†</span> Green = better IRR | 
                                <span style="color: #e74c3c;">‚ñ†</span> Red = worse IRR | 
                                Hover for details
                            </p>
                            <div class="chart-wrapper" id="tornadoChart" style="min-height: 400px; height: auto; overflow: visible;"></div>
                        </div>
                        
                        <!-- Spacer to prevent overlap -->
                        <div style="clear: both; height: 50px;"></div>
                        
                        <!-- Insights Panel -->
                        <div style="background: #f8f9fa; border-left: 5px solid #667eea; padding: 25px; border-radius: 8px; margin-bottom: 35px;">
                            <h3 style="margin-top: 0; color: var(--primary); font-size: 1.2em;">üîç Key Insights</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 15px;">
                                ${sensitivities
                                  .slice(0, 3)
                                  .map((sens, i) => {
                                    const info = parameterInfo[
                                      sens.parameter
                                    ] || { icon: "üìå", range: "N/A" };
                                    const isPositiveImpact =
                                      sens.high.irr > sens.low.irr;
                                    return `
                                        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
                                            <div style="font-size: 1.8em; margin-bottom: 8px;">${
                                              info.icon || "üìå"
                                            }</div>
                                            <div style="font-weight: 600; color: var(--secondary); margin-bottom: 8px;">${
                                              i + 1
                                            }. ${sens.parameter}</div>
                                            <div style="font-size: 0.9em; color: #666; line-height: 1.5;">
                                                <strong>Impact:</strong> ¬±${sens.impact.toFixed(
                                                  2
                                                )}%<br>
                                                <strong>Range:</strong> ${
                                                  info.range
                                                }<br>
                                                ${
                                                  isPositiveImpact
                                                    ? '<strong style="color: #2ecc71;">‚Üë Higher values improve IRR</strong>'
                                                    : '<strong style="color: #e74c3c;">‚Üì Higher values reduce IRR</strong>'
                                                }
                                            </div>
                                        </div>
                                    `;
                                  })
                                  .join("")}
                            </div>
                        </div>
                        
                        <!-- Parameter Details Table -->
                        <div class="data-table" style="margin-top: 40px; clear: both;">
                            <h3 style="padding: 20px; margin: 0; border-bottom: 2px solid var(--border); background: #f8f9fa;">
                                üìã Detailed Parameter Analysis
                            </h3>
                            <table>
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="text-align: left; padding: 15px;">Parameter</th>
                                        <th style="text-align: center;">Base Value</th>
                                        <th style="text-align: center;">Low Scenario</th>
                                        <th style="text-align: center;">High Scenario</th>
                                        <th style="text-align: center;">IRR Impact</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${sensitivities
                                      .map((sens, index) => {
                                        const info = parameterInfo[
                                          sens.parameter
                                        ] || { icon: "üìå" };
                                        // DYNAMIC COLOR LOGIC: Green if better, Red if worse
                                        const lowBetter =
                                          sens.low.irr > baseIRR;
                                        const highBetter =
                                          sens.high.irr > baseIRR;
                                        const lowBgColor = lowBetter
                                          ? "#f0fdf4"
                                          : "#fff5f5";
                                        const lowTextColor = lowBetter
                                          ? "#2ecc71"
                                          : "#e74c3c";
                                        const highBgColor = highBetter
                                          ? "#f0fdf4"
                                          : "#fff5f5";
                                        const highTextColor = highBetter
                                          ? "#2ecc71"
                                          : "#e74c3c";

                                        return `
                                        <tr style="border-bottom: 1px solid #f0f0f0; ${
                                          index < 3
                                            ? "background: #fffbf0;"
                                            : ""
                                        }">
                                            <td style="padding: 15px;">
                                                <div style="font-weight: 600; color: var(--primary);">
                                                    ${info.icon || ""} ${
                                          sens.parameter
                                        }
                                                </div>
                                            </td>
                                            <td style="text-align: center; padding: 15px;">
                                                <strong>${this.formatValue(
                                                  sens.base_value,
                                                  sens.parameter
                                                )}</strong>
                                            </td>
                                            <td style="text-align: center; padding: 15px; background: ${lowBgColor};">
                                                ${this.formatValue(
                                                  sens.low.value,
                                                  sens.parameter
                                                )}<br>
                                                <span style="color: ${lowTextColor}; font-weight: bold; font-size: 1.1em;">‚Üí ${sens.low.irr.toFixed(
                                          2
                                        )}%</span><br>
                                                <small style="color: #999;">(${
                                                  sens.low.delta_irr >= 0
                                                    ? "+"
                                                    : ""
                                                }${sens.low.delta_irr.toFixed(
                                          2
                                        )}%)</small>
                                            </td>
                                            <td style="text-align: center; padding: 15px; background: ${highBgColor};">
                                                ${this.formatValue(
                                                  sens.high.value,
                                                  sens.parameter
                                                )}<br>
                                                <span style="color: ${highTextColor}; font-weight: bold; font-size: 1.1em;">‚Üí ${sens.high.irr.toFixed(
                                          2
                                        )}%</span><br>
                                                <small style="color: #999;">(${
                                                  sens.high.delta_irr >= 0
                                                    ? "+"
                                                    : ""
                                                }${sens.high.delta_irr.toFixed(
                                          2
                                        )}%)</small>
                                            </td>
                                            <td style="text-align: center; padding: 15px;">
                                                <div style="background: ${
                                                  index < 3
                                                    ? "#ffc107"
                                                    : "#e9ecef"
                                                }; color: ${
                                          index < 3 ? "white" : "#666"
                                        }; padding: 6px 12px; border-radius: 20px; display: inline-block; font-weight: bold;">
                                                    ¬±${sens.impact.toFixed(2)}%
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                      })
                                      .join("")}
                                </tbody>
                            </table>
                        </div>
                `;

          html += "</div>";
          content.innerHTML = html;

          // Create enhanced tornado chart
          if (sensitivities.length > 0) {
            // Prepare data
            const parameters = [];
            const lowValues = [];
            const highValues = [];
            const customData = [];

            sensitivities.forEach((sens) => {
              parameters.push(sens.parameter);
              lowValues.push(sens.low.irr - baseIRR);
              highValues.push(sens.high.irr - baseIRR);

              const info = parameterInfo[sens.parameter] || {
                range: "N/A",
                rationale: "No description available.",
              };
              customData.push({
                param: sens.parameter,
                baseValue: sens.base_value,
                lowValue: sens.low.value,
                lowIRR: sens.low.irr,
                highValue: sens.high.value,
                highIRR: sens.high.irr,
                impact: sens.impact,
                range: info.range,
                rationale: info.rationale,
              });
            });

            // Determine colors based on whether result is better or worse than base
            // Red = worse IRR, Green = better IRR (regardless of which side of zero)
            const lowColors = lowValues.map((delta, i) => {
              const lowIRR = customData[i].lowIRR;
              const highIRR = customData[i].highIRR;
              // Low value produces lower IRR ‚Üí red (worse)
              // Low value produces higher IRR ‚Üí green (better, counterintuitive)
              return lowIRR < baseIRR
                ? "#e74c3c"
                : lowIRR > baseIRR
                ? "#2ecc71"
                : "#95a5a6";
            });

            const highColors = highValues.map((delta, i) => {
              const lowIRR = customData[i].lowIRR;
              const highIRR = customData[i].highIRR;
              // High value produces higher IRR ‚Üí green (better)
              // High value produces lower IRR ‚Üí red (worse, counterintuitive)
              return highIRR > baseIRR
                ? "#2ecc71"
                : highIRR < baseIRR
                ? "#e74c3c"
                : "#95a5a6";
            });

            // Low case bars
            const traceLow = {
              y: parameters,
              x: lowValues,
              name: "Low Value Scenario",
              type: "bar",
              orientation: "h",
              marker: {
                color: lowColors,
                line: {
                  color: lowColors.map((c) =>
                    c === "#e74c3c"
                      ? "#c0392b"
                      : c === "#2ecc71"
                      ? "#27ae60"
                      : "#7f8c8d"
                  ),
                  width: 1,
                },
              },
              customdata: customData,
              hovertemplate:
                "<b>%{customdata.param}</b><br>" +
                "<br><b>üìâ Low Value Scenario:</b><br>" +
                "Parameter: %{customdata.lowValue}<br>" +
                "Resulting IRR: %{customdata.lowIRR:.2f}%<br>" +
                "Change from Base: %{x:.2f}%<br>" +
                "<br><b>üìä Tested Range:</b> %{customdata.range}<br>" +
                "<br><b>üí° Why this sensitivity matters:</b><br>%{customdata.rationale}" +
                "<extra></extra>",
              hoverlabel: {
                bgcolor: "rgba(44, 62, 80, 0.95)",
                font: { size: 13, color: "white" },
                bordercolor: "#2c3e50",
                namelength: -1,
              },
            };

            // High case bars
            const traceHigh = {
              y: parameters,
              x: highValues,
              name: "High Value Scenario",
              type: "bar",
              orientation: "h",
              marker: {
                color: highColors,
                line: {
                  color: highColors.map((c) =>
                    c === "#e74c3c"
                      ? "#c0392b"
                      : c === "#2ecc71"
                      ? "#27ae60"
                      : "#7f8c8d"
                  ),
                  width: 1,
                },
              },
              customdata: customData,
              hovertemplate:
                "<b>%{customdata.param}</b><br>" +
                "<br><b>üìà High Value Scenario:</b><br>" +
                "Parameter: %{customdata.highValue}<br>" +
                "Resulting IRR: %{customdata.highIRR:.2f}%<br>" +
                "Change from Base: %{x:.2f}%<br>" +
                "<br><b>üìä Tested Range:</b> %{customdata.range}<br>" +
                "<br><b>üí° Why this sensitivity matters:</b><br>%{customdata.rationale}" +
                "<extra></extra>",
              hoverlabel: {
                bgcolor: "rgba(44, 62, 80, 0.95)",
                font: { size: 13, color: "white" },
                bordercolor: "#2c3e50",
                namelength: -1,
              },
            };

            const layout = {
              barmode: "overlay",
              hovermode: "closest",
              xaxis: {
                title: {
                  text: "Change in Equity IRR (%)",
                  font: { size: 13, color: "#2c3e50", family: "Segoe UI" },
                  standoff: 10,
                },
                zeroline: true,
                zerolinewidth: 2,
                zerolinecolor: "#667eea",
                gridcolor: "#e8ecef",
                tickfont: { size: 11, color: "#5a6c7d" },
              },
              yaxis: {
                title: "",
                autorange: "reversed",
                tickfont: { size: 11, color: "#2c3e50", family: "Segoe UI" },
              },
              margin: { l: 200, r: 30, t: 50, b: 60 },
              showlegend: true,
              legend: {
                orientation: "h",
                x: 0.5,
                xanchor: "center",
                y: 1.08,
                bgcolor: "rgba(255,255,255,0.9)",
                bordercolor: "#ddd",
                borderwidth: 1,
                font: { size: 11, color: "#2c3e50" },
              },
              height: Math.max(420, 300 + sensitivities.length * 40),
              paper_bgcolor: "#ffffff",
              plot_bgcolor: "#fafbfc",
              font: { family: "Segoe UI, Arial", size: 11, color: "#2c3e50" },
              annotations: [
                {
                  text: `<b>Base IRR:</b> ${baseIRR.toFixed(2)}%`,
                  xref: "paper",
                  yref: "paper",
                  x: 0.01,
                  y: 0.99,
                  xanchor: "left",
                  yanchor: "top",
                  showarrow: false,
                  font: { size: 11, color: "#667eea" },
                  bgcolor: "rgba(255,255,255,0.9)",
                  bordercolor: "#667eea",
                  borderwidth: 1,
                  borderpad: 4,
                },
              ],
            };

            Plotly.newPlot("tornadoChart", [traceLow, traceHigh], layout, {
              responsive: true,
              displayModeBar: true,
              modeBarButtonsToRemove: ["lasso2d", "select2d"],
              displaylogo: false,
            }).then(() => {
              // Force the chart container to respect its height
              const chartDiv = document.getElementById("tornadoChart");
              if (chartDiv && chartDiv.layout) {
                chartDiv.style.height = layout.height + "px";
                chartDiv.style.minHeight = layout.height + "px";
                chartDiv.style.overflow = "visible";
              }
            });
          }
        },

        // Helper function to format values based on parameter type
        formatValue(value, parameter) {
          // Handle percentage-based parameters
          if (
            parameter.includes("Rate") ||
            parameter.includes("LTV") ||
            parameter.includes("Fee") ||
            parameter.includes("Occupancy")
          ) {
            return (value * 100).toFixed(2) + "%";
          }
          // Handle currency values
          else if (parameter.includes("Price") || parameter.includes("Cost")) {
            return (
              "CHF " +
              value.toLocaleString("en-US", { maximumFractionDigits: 0 })
            );
          }
          // Handle nights/days
          else if (parameter.includes("Stay")) {
            return value.toFixed(1) + " nights";
          }
          // Default: 2 decimal places
          else {
            return value.toFixed(2);
          }
        },

        renderSensitivityCoC(data) {
          const content = document.getElementById("contentArea");
          const sensitivities = data.sensitivities || [];
          const baseCoC = data.base_coc || 0;

          // Parameter explanations
          const parameterInfo = {
            "Interest Rate": {
              range: "0.3% to 2.3% (¬±1%)",
              rationale:
                "Interest rate has HUGE impact on cash flow. Lower rates = better cash-on-cash. With leverage, even 0.5% difference matters significantly for Year 1 cash yield.",
              icon: "üìä",
            },
            "Amortization Rate": {
              range: "0% (interest-only) to 2%",
              rationale:
                "Amortization directly reduces cash flow. Interest-only (0%) maximizes Year 1 cash but keeps debt higher. 2% amortization improves equity but hurts cash flow by CHF 6,000/year.",
              icon: "üí∞",
            },
            "Average Daily Rate": {
              range: "CHF 160 to 240 (¬±20%)",
              rationale:
                "Pricing strategy directly impacts revenue and thus cash flow. 20% rate increase can turn negative CoC into positive. Dynamic pricing is crucial.",
              icon: "üíµ",
            },
            "Maintenance Reserve Rate": {
              range: "0% to 1% of property value",
              rationale:
                "Maintenance reserve is a large annual expense. Going from 1% to 0% saves CHF 13,000/year = CHF 3,250 per owner. But may defer needed work.",
              icon: "üîß",
            },
            "Loan-to-Value (LTV)": {
              range: "67.5% to 82.5% (¬±10%)",
              rationale:
                "Higher LTV = less equity needed BUT more debt service. This creates a trade-off: higher LTV hurts cash-on-cash but requires less upfront capital.",
              icon: "üè¶",
            },
            "Average Length of Stay": {
              range: "1.19 to 2.21 nights (¬±30%)",
              rationale:
                "Longer stays = fewer turnovers = lower cleaning costs = better cash flow. Encouraging 3+ night stays can meaningfully improve CoC.",
              icon: "üìÖ",
            },
            "Cleaning Cost per Stay": {
              range: "CHF 49 to 91 (¬±30%)",
              rationale:
                "With ~130 turnovers/year, cleaning is a major expense. Negotiating from CHF 80 to CHF 60 saves CHF 2,600/year.",
              icon: "üßπ",
            },
            "Occupancy Rate": {
              range: "56.7% to 69.3% (¬±10%)",
              rationale:
                "Higher occupancy = more revenue = better cash flow. Every 1% occupancy increase adds ~CHF 700 revenue.",
              icon: "üìà",
            },
            "Property Management Fee": {
              range: "15% to 25% (¬±5%)",
              rationale:
                "Management fees are % of revenue. Lower fees = better cash flow.",
              icon: "üè¢",
            },
            "Winter Season Occupancy": {
              range: "63.75% to 86.25% (¬±15%)",
              rationale:
                "Premium ski season. Higher winter occupancy = more high-rate revenue.",
              icon: "‚õ∑Ô∏è",
            },
            "Purchase Price": {
              range: "CHF 1.17M to 1.43M (¬±10%)",
              rationale: "Higher price = more equity needed = worse CoC yield.",
              icon: "üè†",
            },
            "Insurance Rate": {
              range: "0.3% to 0.5% of property value",
              rationale:
                "Annual insurance costs. Lower rates = better cash flow.",
              icon: "üõ°Ô∏è",
            },
            "Property Appreciation Rate": {
              range: "1.5% to 3.5%",
              rationale: "Doesn't affect Year 1 cash flow. Zero impact on CoC.",
              icon: "üìà",
            },
            "Inflation Rate": {
              range: "0.5% to 1.5%",
              rationale: "Doesn't affect Year 1 cash flow. Zero impact on CoC.",
              icon: "üìä",
            },
            "Selling Costs Rate": {
              range: "5.8% to 9.8% (¬±2%)",
              rationale:
                "Transaction costs at property sale (Year 15). Doesn't affect Year 1 cash flow - only matters for long-term returns when property is eventually sold. Includes broker, notary, and transfer tax.",
              icon: "üìù",
            },
          };

          let html = `
            <div class="section">
              <h2 class="section-title">üí∞ Cash-on-Cash Sensitivity Analysis</h2>
              
              <!-- Info Box -->
              <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 14px 18px; border-radius: 8px; margin-bottom: 20px;">
                <p style="margin: 0; font-size: 0.85em; line-height: 1.5; opacity: 0.95;">
                  üí° <strong>Cash-on-Cash = Year 1 Cash / Equity</strong> ‚Äî First year cash yield like a bond. Ignores appreciation. Hover for details.
                </p>
              </div>
              
              <!-- Summary KPIs -->
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">
                <div class="kpi-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border: none; color: white; padding: 12px;">
                  <h3 style="color: rgba(255,255,255,0.9); font-size: 0.75em;">Base CoC</h3>
                  <div class="value" style="color: white; font-size: 1.4em;">${baseCoC.toFixed(
                    2
                  )}%</div>
                </div>
                <div class="kpi-card" style="padding: 12px;">
                  <h3 style="font-size: 0.75em;">Parameters</h3>
                  <div class="value" style="color: var(--info); font-size: 1.4em;">${
                    sensitivities.length
                  }</div>
                </div>
                <div class="kpi-card" style="padding: 12px;">
                  <h3 style="font-size: 0.75em;">Top Impact</h3>
                  <div class="value" style="color: var(--warning); font-size: 1.4em;">¬±${(
                    sensitivities[0]?.impact || 0
                  ).toFixed(2)}%</div>
                  <div class="unit" style="font-size: 0.7em;">${
                    sensitivities[0]?.parameter || "N/A"
                  }</div>
                </div>
                <div class="kpi-card" style="padding: 12px;">
                  <h3 style="font-size: 0.75em;">CoC Range</h3>
                  <div class="value" style="color: var(--success); font-size: 1.2em;">${Math.min(
                    ...sensitivities
                      .filter((s) => s.impact > 0)
                      .map((s) => Math.min(s.low.irr, s.high.irr))
                  ).toFixed(1)}% - ${Math.max(
            ...sensitivities
              .filter((s) => s.impact > 0)
              .map((s) => Math.max(s.low.irr, s.high.irr))
          ).toFixed(1)}%</div>
                </div>
              </div>
              
              <!-- Tornado Chart -->
              <div class="chart-container" style="padding: 20px; margin-bottom: 25px;">
                <h3 style="margin-bottom: 12px; font-size: 1.1em; color: #f5576c; font-weight: 600;">
                  üìä Tornado Chart - Impact on Year 1 Cash Yield
                </h3>
                <p style="color: #7f8c8d; margin-bottom: 15px; font-size: 0.85em; line-height: 1.5;">
                  <span style="color: #2ecc71;">‚ñ†</span> Green = better CoC | 
                  <span style="color: #e74c3c;">‚ñ†</span> Red = worse CoC | 
                  Hover for details
                </p>
                <div class="chart-wrapper" id="tornadoChartCoC" style="min-height: 400px; height: auto; overflow: visible;"></div>
              </div>
              
              <!-- Spacer -->
              <div style="clear: both; height: 20px;"></div>
              
              <!-- Insights Panel -->
              <div style="background: #fff5f5; border-left: 5px solid #f5576c; padding: 25px; border-radius: 8px; margin-bottom: 35px;">
                <h3 style="margin-top: 0; color: #f5576c; font-size: 1.2em;">üîç Key Cash Flow Insights</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 15px;">
                  ${sensitivities
                    .filter((s) => s.impact > 0)
                    .slice(0, 3)
                    .map((sens, i) => {
                      const info = parameterInfo[sens.parameter] || {
                        icon: "üìå",
                        range: "N/A",
                      };
                      return `
                      <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #fee;">
                        <div style="font-size: 1.8em; margin-bottom: 8px;">${
                          info.icon || "üìå"
                        }</div>
                        <div style="font-weight: 600; color: #f5576c; margin-bottom: 8px;">${
                          i + 1
                        }. ${sens.parameter}</div>
                        <div style="font-size: 0.9em; color: #666; line-height: 1.5;">
                          <strong>Impact:</strong> ¬±${sens.impact.toFixed(
                            2
                          )}%<br>
                          <strong>Range:</strong> ${info.range}<br>
                          <strong style="color: ${
                            sens.high.irr > sens.low.irr ? "#2ecc71" : "#e74c3c"
                          };">
                            ${
                              sens.high.irr > sens.low.irr
                                ? "‚Üë Higher values improve CoC"
                                : "‚Üì Higher values reduce CoC"
                            }
                          </strong>
                        </div>
                      </div>
                    `;
                    })
                    .join("")}
                </div>
              </div>
              
              <!-- Parameter Details Table -->
              <div class="data-table" style="margin-top: 40px; clear: both;">
                <h3 style="padding: 20px; margin: 0; border-bottom: 2px solid var(--border); background: #fff5f5;">
                  üìã Detailed Cash-on-Cash Analysis
                </h3>
                <table>
                  <thead>
                    <tr style="background: #fff5f5;">
                      <th style="text-align: left; padding: 15px;">Parameter</th>
                      <th style="text-align: center;">Base Value</th>
                      <th style="text-align: center;">Low Scenario</th>
                      <th style="text-align: center;">High Scenario</th>
                      <th style="text-align: center;">CoC Impact</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${sensitivities
                      .map((sens, index) => {
                        const info = parameterInfo[sens.parameter] || {
                          icon: "üìå",
                        };
                        const hasImpact = sens.impact > 0.01;
                        // DYNAMIC COLOR LOGIC: Green if better, Red if worse
                        const lowBetter = sens.low.irr > baseCoC;
                        const highBetter = sens.high.irr > baseCoC;
                        const lowBgColor = lowBetter ? "#f0fdf4" : "#fff5f5";
                        const lowTextColor = lowBetter ? "#2ecc71" : "#e74c3c";
                        const highBgColor = highBetter ? "#f0fdf4" : "#fff5f5";
                        const highTextColor = highBetter
                          ? "#2ecc71"
                          : "#e74c3c";

                        return `
                      <tr style="border-bottom: 1px solid #f0f0f0; ${
                        index < 3 ? "background: #fffbf0;" : ""
                      } ${!hasImpact ? "opacity: 0.5;" : ""}">
                        <td style="padding: 15px;">
                          <div style="font-weight: 600; color: var(--primary);">
                            ${info.icon || ""} ${sens.parameter}
                          </div>
                          ${
                            !hasImpact
                              ? '<small style="color: #999;">(No Year 1 impact)</small>'
                              : ""
                          }
                        </td>
                        <td style="text-align: center; padding: 15px;">
                          <strong>${this.formatValue(
                            sens.base_value,
                            sens.parameter
                          )}</strong>
                        </td>
                        <td style="text-align: center; padding: 15px; background: ${lowBgColor};">
                          ${this.formatValue(
                            sens.low.value,
                            sens.parameter
                          )}<br>
                          <span style="color: ${lowTextColor}; font-weight: bold; font-size: 1.1em;">‚Üí ${sens.low.irr.toFixed(
                          2
                        )}%</span><br>
                          <small style="color: #999;">(${
                            sens.low.delta_irr >= 0 ? "+" : ""
                          }${sens.low.delta_irr.toFixed(2)}%)</small>
                        </td>
                        <td style="text-align: center; padding: 15px; background: ${highBgColor};">
                          ${this.formatValue(
                            sens.high.value,
                            sens.parameter
                          )}<br>
                          <span style="color: ${highTextColor}; font-weight: bold; font-size: 1.1em;">‚Üí ${sens.high.irr.toFixed(
                          2
                        )}%</span><br>
                          <small style="color: #999;">(${
                            sens.high.delta_irr >= 0 ? "+" : ""
                          }${sens.high.delta_irr.toFixed(2)}%)</small>
                        </td>
                        <td style="text-align: center; padding: 15px;">
                          <div style="background: ${
                            index < 3 ? "#f5576c" : "#e9ecef"
                          }; color: ${
                          index < 3 ? "white" : "#666"
                        }; padding: 6px 12px; border-radius: 20px; display: inline-block; font-weight: bold;">
                            ¬±${sens.impact.toFixed(2)}%
                          </div>
                        </td>
                      </tr>
                    `;
                      })
                      .join("")}
                  </tbody>
                </table>
              </div>
          `;

          html += "</div>";
          content.innerHTML = html;

          // Render tornado chart (filter out zero-impact parameters)
          const meaningfulSensitivities = sensitivities.filter(
            (s) => s.impact > 0.01
          );

          if (meaningfulSensitivities.length > 0) {
            const parameters = [];
            const lowValues = [];
            const highValues = [];
            const customData = [];

            meaningfulSensitivities.forEach((sens) => {
              parameters.push(sens.parameter);
              lowValues.push(sens.low.irr - baseCoC);
              highValues.push(sens.high.irr - baseCoC);

              const info = parameterInfo[sens.parameter] || {
                range: "N/A",
                rationale: "No description available.",
              };
              customData.push({
                param: sens.parameter,
                baseValue: sens.base_value,
                lowValue: sens.low.value,
                lowCoC: sens.low.irr,
                highValue: sens.high.value,
                highCoC: sens.high.irr,
                impact: sens.impact,
                range: info.range,
                rationale: info.rationale,
              });
            });

            // Color bars based on whether result is better or worse
            const lowColors = lowValues.map((delta, i) => {
              const lowCoC = customData[i].lowCoC;
              return lowCoC < baseCoC
                ? "#e74c3c"
                : lowCoC > baseCoC
                ? "#2ecc71"
                : "#95a5a6";
            });

            const highColors = highValues.map((delta, i) => {
              const highCoC = customData[i].highCoC;
              return highCoC > baseCoC
                ? "#2ecc71"
                : highCoC < baseCoC
                ? "#e74c3c"
                : "#95a5a6";
            });

            const traceLow = {
              y: parameters,
              x: lowValues,
              name: "Pessimistic Scenario",
              type: "bar",
              orientation: "h",
              marker: {
                color: lowColors,
                line: { color: "#c0392b", width: 1.5 },
              },
              customdata: customData,
              hovertemplate:
                "<b style='font-size:14px'>üìâ %{customdata.param}</b><br><br>" +
                "<b>Pessimistic Scenario:</b><br>" +
                "‚îú‚îÄ Parameter Value: <b>%{customdata.lowValue}</b><br>" +
                "‚îú‚îÄ Resulting Cash-on-Cash: <b>%{customdata.lowCoC:.2f}%</b><br>" +
                "‚îî‚îÄ Change from Base: <b>%{x:+.2f}%</b><br>" +
                "<br><b>üìä Sensitivity Range:</b> %{customdata.range}<br>" +
                "<br><b>üí° Why This Matters:</b><br>" +
                "%{customdata.rationale}<br>" +
                "<extra></extra>",
              hoverlabel: {
                bgcolor: "rgba(44, 62, 80, 0.97)",
                font: { size: 12, color: "white", family: "Segoe UI, Arial" },
                bordercolor: "#2c3e50",
                namelength: -1,
                align: "left",
              },
            };

            const traceHigh = {
              y: parameters,
              x: highValues,
              name: "Optimistic Scenario",
              type: "bar",
              orientation: "h",
              marker: {
                color: highColors,
                line: { color: "#27ae60", width: 1.5 },
              },
              customdata: customData,
              hovertemplate:
                "<b style='font-size:14px'>üìà %{customdata.param}</b><br><br>" +
                "<b>Optimistic Scenario:</b><br>" +
                "‚îú‚îÄ Parameter Value: <b>%{customdata.highValue}</b><br>" +
                "‚îú‚îÄ Resulting Cash-on-Cash: <b>%{customdata.highCoC:.2f}%</b><br>" +
                "‚îî‚îÄ Change from Base: <b>%{x:+.2f}%</b><br>" +
                "<br><b>üìä Sensitivity Range:</b> %{customdata.range}<br>" +
                "<br><b>üí° Why This Matters:</b><br>" +
                "%{customdata.rationale}<br>" +
                "<extra></extra>",
              hoverlabel: {
                bgcolor: "rgba(44, 62, 80, 0.97)",
                font: { size: 12, color: "white", family: "Segoe UI, Arial" },
                bordercolor: "#2c3e50",
                namelength: -1,
                align: "left",
              },
            };

            const layout = {
              barmode: "overlay",
              hovermode: "closest",
              xaxis: {
                title: {
                  text: "Change in Cash-on-Cash (%)",
                  font: { size: 13, color: "#2c3e50", family: "Segoe UI" },
                  standoff: 10,
                },
                zeroline: true,
                zerolinewidth: 2,
                zerolinecolor: "#f5576c",
                gridcolor: "#e8ecef",
                tickfont: { size: 11, color: "#5a6c7d" },
              },
              yaxis: {
                title: "",
                autorange: "reversed",
                tickfont: { size: 11, color: "#2c3e50", family: "Segoe UI" },
              },
              showlegend: true,
              legend: {
                orientation: "h",
                x: 0.5,
                xanchor: "center",
                y: 1.08,
                bgcolor: "rgba(255,255,255,0.9)",
                bordercolor: "#ddd",
                borderwidth: 1,
                font: { size: 11, color: "#2c3e50" },
              },
              annotations: [
                {
                  text: `<b>Base CoC:</b> ${baseCoC.toFixed(2)}%`,
                  xref: "paper",
                  yref: "paper",
                  x: 0.01,
                  y: 0.99,
                  xanchor: "left",
                  yanchor: "top",
                  showarrow: false,
                  font: { size: 11, color: "#f5576c" },
                  bgcolor: "rgba(255,255,255,0.9)",
                  bordercolor: "#f5576c",
                  borderwidth: 1,
                  borderpad: 4,
                },
              ],
              margin: { l: 200, r: 30, t: 50, b: 60 },
              height: Math.max(420, 300 + meaningfulSensitivities.length * 40),
              paper_bgcolor: "#ffffff",
              plot_bgcolor: "#fafbfc",
              font: { family: "Segoe UI, Arial", size: 11, color: "#2c3e50" },
            };

            Plotly.newPlot("tornadoChartCoC", [traceLow, traceHigh], layout, {
              responsive: true,
              displayModeBar: true,
              modeBarButtonsToRemove: ["lasso2d", "select2d"],
              displaylogo: false,
            }).then(() => {
              const chartDiv = document.getElementById("tornadoChartCoC");
              if (chartDiv && chartDiv.layout) {
                chartDiv.style.height = layout.height + "px";
                chartDiv.style.minHeight = layout.height + "px";
                chartDiv.style.overflow = "visible";
              }
            });
          }
        },

        // =============================================================
        // SENSITIVITY ANALYSIS - MONTHLY NET CASH FLOW PER OWNER
        // =============================================================
        renderSensitivityNCF(data) {
          const content = document.getElementById("contentArea");
          const sensitivities = data.sensitivities || [];
          const baseNCF = data.base_ncf || 0;

          // Parameter info for NCF sensitivity
          const parameterInfo = {
            "Purchase Price": {
              range: "CHF 1.275M to 1.725M (¬±15%)",
              rationale:
                "Higher purchase price means more debt and higher mortgage payments, directly reducing monthly cash flow. Negotiating down CHF 50k = CHF 8/month savings per owner.",
              icon: "üè†",
            },
            "Interest Rate": {
              range: "0.3% to 2.3% (¬±1%)",
              rationale:
                "Interest rate directly impacts monthly mortgage cost. Each 0.5% change = ~CHF 150/month per owner difference. Critical for cash flow planning.",
              icon: "üìà",
            },
            "Average Daily Rate": {
              range: "CHF 129.5 to 175.5 (¬±15%)",
              rationale:
                "Higher daily rates increase gross revenue proportionally. A CHF 20/night increase generates ~CHF 2,900 extra annually = ~CHF 60/month per owner.",
              icon: "üí∞",
            },
            "Occupancy Rate": {
              range: "52.7% to 71.3% (Winter avg ¬±15%)",
              rationale:
                "Higher occupancy means more rental nights. 5% higher occupancy = ~CHF 3,650 more revenue = ~CHF 76/month per owner after expenses.",
              icon: "üõèÔ∏è",
            },
            "Maintenance Reserve Rate": {
              range: "0.25% to 0.75% of property value",
              rationale:
                "Maintenance reserve affects monthly cash flow directly. At 0.5%, this is ~CHF 625/month total = CHF 156/month per owner set aside.",
              icon: "üîß",
            },
            "Management Fee Rate": {
              range: "18% to 22% of rental income",
              rationale:
                "Management fees are a percentage of gross rental income. At 20%, this is ~CHF 10k/year = CHF 208/month per owner.",
              icon: "üëî",
            },
            "Loan-to-Value (LTV)": {
              range: "67.5% to 82.5% (¬±10%)",
              rationale:
                "Higher LTV = more debt = higher monthly payments but less equity needed upfront. 75% LTV means ~CHF 937k mortgage = ~CHF 1,171/month per owner.",
              icon: "üè¶",
            },
            "Amortization Rate": {
              range: "0% to 2% annually",
              rationale:
                "Amortization is principal paydown, directly reducing cash flow. 1% = CHF 937/month total = CHF 234/month per owner building equity.",
              icon: "üí≥",
            },
            "Cleaning Cost per Stay": {
              range: "CHF 49 to 91 (¬±30%)",
              rationale:
                "With ~130 turnovers/year, cleaning costs add up. CHF 70/turnover = CHF 9,100/year = CHF 190/month per owner.",
              icon: "üßπ",
            },
            "Average Length of Stay": {
              range: "1.19 to 2.21 nights (¬±30%)",
              rationale:
                "Longer stays = fewer turnovers = less cleaning costs. 2 nights avg instead of 1.7 saves ~CHF 25/month per owner.",
              icon: "üìÖ",
            },
            "Insurance Rate": {
              range: "0.3% to 0.5% of property value",
              rationale:
                "Annual insurance as % of value. 0.4% = CHF 5k/year = CHF 104/month per owner. Shopping around can save CHF 20-40/month.",
              icon: "üõ°Ô∏è",
            },
            "Winter Season Occupancy": {
              range: "63.75% to 86.25% (¬±15%)",
              rationale:
                "Winter is premium season (Dec-Mar) with highest rates. High winter occupancy is crucial for positive monthly cash flow.",
              icon: "‚õ∑Ô∏è",
            },
            "Inflation Rate": {
              range: "0.5% to 1.5% (¬±0.5%)",
              rationale:
                "Inflation affects Year 1 minimally but compounds over time. Higher inflation means higher future rents AND costs.",
              icon: "üìä",
            },
            "Property Appreciation Rate": {
              range: "1.5% to 3.5% (¬±1%)",
              rationale:
                "Property appreciation doesn't affect monthly cash flow directly - only affects equity value at sale.",
              icon: "üìà",
            },
            "Selling Costs Rate": {
              range: "5.8% to 9.8% (¬±2%)",
              rationale:
                "Selling costs don't affect monthly cash flow - only apply when property is sold at Year 15.",
              icon: "üìù",
            },
          };

          // Filter out zero-impact parameters (like appreciation for monthly cash flow)
          const meaningfulSensitivities = sensitivities.filter(
            (s) => s.impact > 0.5
          );

          let html = `
            <div class="section">
              <h2 class="section-title" style="color: #16a085;">
                <i class="fas fa-wallet"></i> Sensitivity Analysis - Monthly Net Cash Flow
              </h2>
              
              <!-- Info Box -->
              <div style="background: linear-gradient(135deg, #16a085 0%, #1abc9c 100%); color: white; padding: 14px 18px; border-radius: 8px; margin-bottom: 20px;">
                <p style="margin: 0; font-size: 0.85em; line-height: 1.5; opacity: 0.95;">
                  üí° <strong>Monthly NCF = Annual Cash / 12 / Owners</strong> ‚Äî Actual CHF hitting your bank each month after all costs.
                </p>
              </div>
              
              <!-- KPI Summary Cards - Teal Theme -->
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">
                <div class="kpi-card" style="background: linear-gradient(135deg, #16a085 0%, #1abc9c 100%); border: none; color: white; padding: 12px;">
                  <h3 style="color: rgba(255,255,255,0.9); font-size: 0.75em;">Base NCF</h3>
                  <div class="value" style="color: white; font-size: 1.4em;">CHF ${baseNCF.toFixed(
                    0
                  )}</div>
                </div>
                <div class="kpi-card" style="padding: 12px;">
                  <h3 style="font-size: 0.75em;">Parameters</h3>
                  <div class="value" style="color: #16a085; font-size: 1.4em;">${
                    meaningfulSensitivities.length
                  }/${sensitivities.length}</div>
                </div>
                <div class="kpi-card" style="padding: 12px;">
                  <h3 style="font-size: 0.75em;">Top Impact</h3>
                  <div class="value" style="color: var(--warning); font-size: 1.4em;">¬±CHF ${(
                    sensitivities[0]?.impact || 0
                  ).toFixed(0)}</div>
                  <div class="unit" style="font-size: 0.7em;">${
                    sensitivities[0]?.parameter || "N/A"
                  }</div>
                </div>
                <div class="kpi-card" style="padding: 12px;">
                  <h3 style="font-size: 0.75em;">NCF Range</h3>
                  <div class="value" style="color: var(--success); font-size: 1.1em;">CHF ${Math.min(
                    ...sensitivities.map((s) => Math.min(s.low.irr, s.high.irr))
                  ).toFixed(0)} - ${Math.max(
            ...sensitivities.map((s) => Math.max(s.low.irr, s.high.irr))
          ).toFixed(0)}</div>
                </div>
              </div>
              
              <!-- Tornado Chart -->
              <div class="chart-container" style="padding: 20px; margin-bottom: 25px;">
                <h3 style="margin-bottom: 12px; font-size: 1.1em; color: #16a085; font-weight: 600;">
                  üìä Tornado Chart - Impact on Monthly Cash Flow
                </h3>
                <p style="color: #7f8c8d; margin-bottom: 15px; font-size: 0.85em; line-height: 1.5;">
                  <span style="color: #2ecc71;">‚ñ†</span> Green = higher cash | 
                  <span style="color: #e74c3c;">‚ñ†</span> Red = lower cash | 
                  Hover for details
                </p>
                <div class="chart-wrapper" id="tornadoChartNCF" style="min-height: 400px; height: auto; overflow: visible;"></div>
              </div>

              <!-- Data Table -->
              <div class="chart-container" style="padding: 30px; margin-bottom: 40px; overflow-x: auto;">
                <h3 style="margin-bottom: 20px; font-size: 1.3em; color: #16a085; font-weight: 600;">
                  üìã Detailed Parameter Analysis
                </h3>
                <table style="width: 100%; border-collapse: collapse; font-size: 0.95em;">
                  <thead>
                    <tr style="background: linear-gradient(135deg, #16a085, #1abc9c); color: white;">
                      <th style="padding: 15px; text-align: left; border-radius: 8px 0 0 0;">Parameter</th>
                      <th style="padding: 15px; text-align: center;">Base Value</th>
                      <th style="padding: 15px; text-align: center;">Low Scenario</th>
                      <th style="padding: 15px; text-align: center;">High Scenario</th>
                      <th style="padding: 15px; text-align: center; border-radius: 0 8px 0 0;">Impact</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${sensitivities
                      .map((sens, index) => {
                        const info = parameterInfo[sens.parameter] || {
                          icon: "üìå",
                        };
                        const hasImpact = sens.impact > 0.5;
                        // DYNAMIC COLOR LOGIC: Green if higher NCF, Red if lower
                        const lowBetter = sens.low.irr > baseNCF;
                        const highBetter = sens.high.irr > baseNCF;
                        const lowBgColor = lowBetter ? "#f0fdf4" : "#fff5f5";
                        const lowTextColor = lowBetter ? "#2ecc71" : "#e74c3c";
                        const highBgColor = highBetter ? "#f0fdf4" : "#fff5f5";
                        const highTextColor = highBetter
                          ? "#2ecc71"
                          : "#e74c3c";

                        return `
                      <tr style="border-bottom: 1px solid #f0f0f0; ${
                        index < 3 ? "background: #e8f8f5;" : ""
                      } ${!hasImpact ? "opacity: 0.5;" : ""}">
                        <td style="padding: 15px;">
                          <div style="font-weight: 600; color: #16a085;">
                            ${info.icon || ""} ${sens.parameter}
                          </div>
                          ${
                            !hasImpact
                              ? '<small style="color: #999;">(No monthly impact)</small>'
                              : ""
                          }
                        </td>
                        <td style="text-align: center; padding: 15px;">
                          <strong>${this.formatValue(
                            sens.base_value,
                            sens.parameter
                          )}</strong>
                        </td>
                        <td style="text-align: center; padding: 15px; background: ${lowBgColor};">
                          ${this.formatValue(
                            sens.low.value,
                            sens.parameter
                          )}<br>
                          <span style="color: ${lowTextColor}; font-weight: bold; font-size: 1.1em;">‚Üí CHF ${sens.low.irr.toFixed(
                          0
                        )}</span><br>
                          <small style="color: #999;">(${
                            sens.low.delta_irr >= 0 ? "+" : ""
                          }CHF ${sens.low.delta_irr.toFixed(0)})</small>
                        </td>
                        <td style="text-align: center; padding: 15px; background: ${highBgColor};">
                          ${this.formatValue(
                            sens.high.value,
                            sens.parameter
                          )}<br>
                          <span style="color: ${highTextColor}; font-weight: bold; font-size: 1.1em;">‚Üí CHF ${sens.high.irr.toFixed(
                          0
                        )}</span><br>
                          <small style="color: #999;">(${
                            sens.high.delta_irr >= 0 ? "+" : ""
                          }CHF ${sens.high.delta_irr.toFixed(0)})</small>
                        </td>
                        <td style="text-align: center; padding: 15px;">
                          <div style="background: ${
                            index < 3 ? "#16a085" : "#e9ecef"
                          }; color: ${
                          index < 3 ? "white" : "#666"
                        }; padding: 6px 12px; border-radius: 20px; display: inline-block; font-weight: bold;">
                            ¬±CHF ${sens.impact.toFixed(0)}
                          </div>
                        </td>
                      </tr>
                    `;
                      })
                      .join("")}
                  </tbody>
                </table>
              </div>

              <!-- Insights Panel -->
              <div class="chart-container" style="padding: 25px; background: linear-gradient(135deg, #e8f8f5, #d5f4e6); border-left: 4px solid #16a085;">
                <h3 style="margin-bottom: 15px; color: #16a085; font-size: 1.2em;">
                  üí° Monthly Cash Flow Insights
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                  <div>
                    <h4 style="color: #0e6655; margin-bottom: 10px;">üìâ Biggest Cash Drains</h4>
                    <ul style="color: #555; line-height: 1.8; padding-left: 20px;">
                      <li><strong>Mortgage interest</strong> - largest monthly expense</li>
                      <li><strong>Amortization</strong> - builds equity but reduces cash</li>
                      <li><strong>Management fees</strong> - 20% of rental income</li>
                    </ul>
                  </div>
                  <div>
                    <h4 style="color: #0e6655; margin-bottom: 10px;">üìà How to Improve Cash Flow</h4>
                    <ul style="color: #555; line-height: 1.8; padding-left: 20px;">
                      <li><strong>Negotiate lower interest rate</strong> - biggest lever</li>
                      <li><strong>Increase daily rates</strong> - premium pricing in peak</li>
                      <li><strong>Optimize occupancy</strong> - target winter season</li>
                    </ul>
                  </div>
                  <div>
                    <h4 style="color: #0e6655; margin-bottom: 10px;">‚öñÔ∏è No Monthly Impact</h4>
                    <ul style="color: #555; line-height: 1.8; padding-left: 20px;">
                      <li><strong>Property appreciation</strong> - affects equity only</li>
                      <li><strong>Selling costs</strong> - only at exit (Year 15)</li>
                      <li><strong>Inflation</strong> - minimal Year 1 effect</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          `;

          content.innerHTML = html;

          // Render tornado chart for NCF
          if (meaningfulSensitivities.length > 0) {
            const parameters = meaningfulSensitivities.map((s) => s.parameter);
            const lowValues = meaningfulSensitivities.map(
              (s) => s.low.delta_irr
            );
            const highValues = meaningfulSensitivities.map(
              (s) => s.high.delta_irr
            );

            // Create custom data for hover
            const customData = meaningfulSensitivities.map((sens) => {
              const info = parameterInfo[sens.parameter] || {};
              return {
                param: sens.parameter,
                lowValue: this.formatValue(sens.low.value, sens.parameter),
                highValue: this.formatValue(sens.high.value, sens.parameter),
                lowNCF: sens.low.irr,
                highNCF: sens.high.irr,
                range: info.range || "Variable",
                rationale: info.rationale || "No description available",
              };
            });

            // Dynamic colors for bars
            const lowColors = meaningfulSensitivities.map((sens) =>
              sens.low.irr > baseNCF
                ? "#2ecc71"
                : sens.low.irr < baseNCF
                ? "#e74c3c"
                : "#95a5a6"
            );
            const highColors = meaningfulSensitivities.map((sens) =>
              sens.high.irr > baseNCF
                ? "#2ecc71"
                : sens.high.irr < baseNCF
                ? "#e74c3c"
                : "#95a5a6"
            );

            const traceLow = {
              y: parameters,
              x: lowValues,
              name: "Low Case",
              type: "bar",
              orientation: "h",
              marker: {
                color: lowColors,
                line: { color: "#0e6655", width: 1.5 },
              },
              customdata: customData,
              hovertemplate:
                "<b style='font-size:14px'>%{customdata.param}</b><br>" +
                "<br><b>üìâ Low Value Scenario:</b><br>" +
                "‚îú‚îÄ Parameter Value: %{customdata.lowValue}<br>" +
                "‚îú‚îÄ Resulting NCF: CHF %{customdata.lowNCF:.0f}<br>" +
                "‚îî‚îÄ Change from Base: %{x:+.0f} CHF<br>" +
                "<br><b>üìä Tested Range:</b> %{customdata.range}<br>" +
                "<br><b>üí° Why this matters:</b><br>%{customdata.rationale}" +
                "<extra></extra>",
              hoverlabel: {
                bgcolor: "rgba(22, 160, 133, 0.97)",
                font: { size: 12, color: "white", family: "Segoe UI, Arial" },
                bordercolor: "#0e6655",
                namelength: -1,
                align: "left",
              },
            };

            const traceHigh = {
              y: parameters,
              x: highValues,
              name: "High Case",
              type: "bar",
              orientation: "h",
              marker: {
                color: highColors,
                line: { color: "#0e6655", width: 1.5 },
              },
              customdata: customData,
              hovertemplate:
                "<b style='font-size:14px'>%{customdata.param}</b><br>" +
                "<br><b>üìà High Value Scenario:</b><br>" +
                "‚îú‚îÄ Parameter Value: %{customdata.highValue}<br>" +
                "‚îú‚îÄ Resulting NCF: CHF %{customdata.highNCF:.0f}<br>" +
                "‚îî‚îÄ Change from Base: %{x:+.0f} CHF<br>" +
                "<br><b>üìä Tested Range:</b> %{customdata.range}<br>" +
                "<br><b>üí° Why this matters:</b><br>%{customdata.rationale}" +
                "<extra></extra>",
              hoverlabel: {
                bgcolor: "rgba(22, 160, 133, 0.97)",
                font: { size: 12, color: "white", family: "Segoe UI, Arial" },
                bordercolor: "#0e6655",
                namelength: -1,
                align: "left",
              },
            };

            const layout = {
              barmode: "relative",
              hovermode: "closest",
              xaxis: {
                title: {
                  text: "Change from Base (CHF/month)",
                  font: { size: 13, color: "#2c3e50", family: "Segoe UI" },
                  standoff: 10,
                },
                zeroline: true,
                zerolinewidth: 2,
                zerolinecolor: "#16a085",
                gridcolor: "#e8ecef",
                tickformat: "+,.0f",
                tickprefix: "CHF ",
                tickfont: { size: 11, color: "#5a6c7d" },
              },
              yaxis: {
                title: "",
                autorange: "reversed",
                tickfont: { size: 11, color: "#2c3e50", family: "Segoe UI" },
              },
              showlegend: true,
              legend: {
                orientation: "h",
                x: 0.5,
                xanchor: "center",
                y: 1.08,
                bgcolor: "rgba(255,255,255,0.9)",
                bordercolor: "#ddd",
                borderwidth: 1,
                font: { size: 11, color: "#2c3e50" },
              },
              annotations: [
                {
                  text: `<b>Base NCF:</b> CHF ${baseNCF.toFixed(0)}/mo`,
                  xref: "paper",
                  yref: "paper",
                  x: 0.01,
                  y: 0.99,
                  xanchor: "left",
                  yanchor: "top",
                  showarrow: false,
                  font: { size: 11, color: "#16a085" },
                  bgcolor: "rgba(255,255,255,0.9)",
                  bordercolor: "#16a085",
                  borderwidth: 1,
                  borderpad: 4,
                },
              ],
              margin: { l: 200, r: 30, t: 50, b: 60 },
              height: Math.max(420, 300 + meaningfulSensitivities.length * 40),
              paper_bgcolor: "#ffffff",
              plot_bgcolor: "#fafbfc",
              font: { family: "Segoe UI, Arial", size: 11, color: "#2c3e50" },
            };

            Plotly.newPlot("tornadoChartNCF", [traceLow, traceHigh], layout, {
              responsive: true,
              modeBarButtonsToRemove: ["lasso2d", "select2d"],
              displaylogo: false,
            }).then(() => {
              const chartDiv = document.getElementById("tornadoChartNCF");
              if (chartDiv && chartDiv.layout) {
                chartDiv.style.height = layout.height + "px";
                chartDiv.style.minHeight = layout.height + "px";
                chartDiv.style.overflow = "visible";
              }
            });
          }
        },

        renderMonteCarlo(data) {
          const content = document.getElementById("contentArea");
          const stats = data.statistics || {};

          let html = `
                    <div class="section">
                        <h2 class="section-title">Monte Carlo Simulation</h2>
                        
                        <div class="kpi-grid">
                            <div class="kpi-card">
                                <h3>Mean NPV</h3>
                                <div class="value">${(
                                  stats.npv?.mean || 0
                                ).toLocaleString("en-US", {
                                  style: "currency",
                                  currency: "CHF",
                                  maximumFractionDigits: 0,
                                })}</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Median NPV</h3>
                                <div class="value">${(
                                  stats.npv?.median || 0
                                ).toLocaleString("en-US", {
                                  style: "currency",
                                  currency: "CHF",
                                  maximumFractionDigits: 0,
                                })}</div>
                            </div>
                            <div class="kpi-card">
                                <h3>Probability NPV > 0</h3>
                                <div class="value">${(
                                  (stats.npv?.positive_prob || 0) * 100
                                ).toFixed(1)}%</div>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <h3>NPV Distribution</h3>
                            <div class="chart-wrapper" id="npvChart"></div>
                        </div>
                    </div>
                `;

          content.innerHTML = html;

          // Render distribution chart if sample data available
          if (data.sample_data && data.sample_data.length > 0) {
            const npvValues = data.sample_data
              .map((d) => d.npv || 0)
              .filter((v) => v !== null);

            if (npvValues.length > 0) {
              const trace = {
                x: npvValues,
                type: "histogram",
                nbinsx: 50,
                marker: { color: "#667eea" },
              };

              const layout = {
                title: "",
                xaxis: { title: "NPV (CHF)" },
                yaxis: { title: "Frequency" },
                hovermode: "closest",
              };

              Plotly.newPlot("npvChart", [trace], layout, { responsive: true });
            }
          }
        },
      };

      // Main Controller
      const Controller = {
        async init() {
          // Load cases index
          await DataManager.loadCasesIndex();
          UIManager.populateCaseSelector();

          // Set up event listeners
          document
            .getElementById("caseSelect")
            .addEventListener("change", (e) => {
              State.currentCase = e.target.value;
              Controller.loadAnalysis();
            });

          document.querySelectorAll(".sidebar-menu-item").forEach((item) => {
            item.addEventListener("click", () => {
              State.currentAnalysis = item.dataset.analysis;
              UIManager.updateAnalysisMenu(State.currentAnalysis);
              Controller.loadAnalysis();
            });
          });

          // Load initial analysis
          if (State.currentCase) {
            await Controller.loadAnalysis();
          }
        },

        async loadAnalysis() {
          if (!State.currentCase) {
            UIManager.showError("Please select a case");
            return;
          }

          UIManager.showLoading();

          try {
            const data = await DataManager.loadCaseData(
              State.currentCase,
              State.currentAnalysis
            );

            if (State.currentAnalysis === "base_case") {
              ChartRenderer.renderBaseCase(data);
            } else if (State.currentAnalysis === "sensitivity") {
              ChartRenderer.renderSensitivity(data);
            } else if (State.currentAnalysis === "sensitivity_coc") {
              ChartRenderer.renderSensitivityCoC(data);
            } else if (State.currentAnalysis === "sensitivity_ncf") {
              ChartRenderer.renderSensitivityNCF(data);
            } else if (State.currentAnalysis === "monte_carlo") {
              ChartRenderer.renderMonteCarlo(data);
            }
          } catch (error) {
            const errorMsg = error.message || "Unknown error";
            UIManager.showError(`
                        <h3>Failed to load ${State.currentAnalysis} data</h3>
                        <p>${errorMsg}</p>
                        <p style="margin-top: 15px; font-size: 0.9em; color: #666;">
                            <strong>To fix this:</strong><br>
                            1. Run <code>python analysis_base_case.py</code> to generate base case data<br>
                            2. Run <code>python analysis_sensitivity.py</code> to generate sensitivity data<br>
                            3. Run <code>python analysis_monte_carlo.py</code> to generate Monte Carlo data<br>
                            4. Or run <code>python generate_all_data.py</code> to generate all data at once
                        </p>
                    `);
          }
        },
      };

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", () => {
        Controller.init();
      });
    </script>
  </body>
</html>
