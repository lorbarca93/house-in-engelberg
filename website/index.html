<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Engelberg Property Investment - Main Dashboard</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary: #1a1a2e;
        --secondary: #0f3460;
        --accent: #667eea;
        --success: #28a745;
        --danger: #dc3545;
        --warning: #ffc107;
        --info: #17a2b8;
        --light: #f8f9fa;
        --dark: #2c3e50;
        --border: #dee2e6;
        --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        --sidebar-width: 250px;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto",
          "Helvetica Neue", Arial, sans-serif;
        background: #f5f6fa;
        color: var(--dark);
        line-height: 1.5;
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
      }

      /* Top Navigation Bar */
      .top-bar {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        color: white;
        padding: 12px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: var(--shadow);
        z-index: 1000;
      }

      .top-bar h1 {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
      }

      .case-selector {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .case-selector label {
        font-weight: 500;
        font-size: 0.9rem;
      }

      .case-selector select {
        padding: 6px 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        font-size: 0.9rem;
        min-width: 200px;
      }

      .case-selector select option {
        background: var(--primary);
        color: white;
      }

      /* Main Layout */
      .main-layout {
        display: flex;
        flex: 1;
        overflow: hidden;
      }

      /* Sidebar */
      .sidebar {
        width: var(--sidebar-width);
        background: white;
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        box-shadow: var(--shadow);
      }

      .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid var(--border);
        background: var(--light);
        font-weight: 600;
        color: var(--primary);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .sidebar-menu {
        list-style: none;
        padding: 10px 0;
      }

      .sidebar-menu-item {
        padding: 12px 20px;
        cursor: pointer;
        transition: all 0.2s ease;
        border-left: 4px solid transparent;
        display: flex;
        align-items: center;
        gap: 10px;
        text-decoration: none;
        color: var(--dark);
      }

      .sidebar-menu-item:hover {
        background: var(--light);
        border-left-color: var(--accent);
      }

      .sidebar-menu-item.active {
        background: rgba(102, 126, 234, 0.1);
        border-left-color: var(--accent);
      }

      .sidebar-menu-item i {
        width: 20px;
        text-align: center;
      }

      /* Main Content Area */
      .content-area {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f5f6fa;
      }

      /* Loading State */
      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 60vh;
        flex-direction: column;
        gap: 20px;
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--border);
        border-top: 4px solid var(--accent);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* KPI Cards */
      .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 20px;
      }

      .kpi-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: var(--shadow);
        border-left: 4px solid var(--accent);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      }

      .kpi-card h3 {
        font-size: 0.85rem;
        color: #7f8c8d;
        margin-bottom: 8px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .kpi-card .value {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 4px;
      }

      .kpi-card .value.positive {
        color: var(--success);
      }

      .kpi-card .value.negative {
        color: var(--danger);
      }

      .kpi-card .unit {
        font-size: 0.8rem;
        color: #95a5a6;
        font-weight: 500;
      }

      /* Section Styling */
      .section {
        margin-bottom: 30px;
      }

      .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      /* Tooltip Styling */
      .kpi-card[data-tooltip]:hover::before,
      .sidebar-menu-item[data-tooltip]:hover::before {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: var(--dark);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.8rem;
        white-space: nowrap;
        z-index: 1000;
        opacity: 0.95;
        box-shadow: var(--shadow);
        max-width: 300px;
        white-space: normal;
        word-wrap: break-word;
      }

      .kpi-card[data-tooltip]:hover::after,
      .sidebar-menu-item[data-tooltip]:hover::after {
        content: "";
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 5px solid transparent;
        border-top-color: var(--dark);
        margin-bottom: -5px;
        z-index: 1000;
      }

      /* Sidebar specific tooltip positioning */
      .sidebar-menu-item[data-tooltip]:hover::before {
        left: 100%;
        top: 50%;
        bottom: auto;
        transform: translateY(-50%);
        margin-left: 10px;
        max-width: 250px;
      }

      .sidebar-menu-item[data-tooltip]:hover::after {
        left: 100%;
        top: 50%;
        bottom: auto;
        transform: translateY(-50%);
        border: 5px solid transparent;
        border-left-color: var(--dark);
        margin-left: 5px;
        border-top: none;
        border-bottom: none;
        margin-bottom: 0;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .sidebar {
          width: 200px;
        }

        .kpi-grid {
          grid-template-columns: 1fr;
        }

        .top-bar h1 {
          font-size: 1.2rem;
        }

        .case-selector select {
          min-width: 150px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Top Navigation Bar -->
    <div class="top-bar">
      <h1><i class="fas fa-chart-line"></i> Engelberg Property Investment</h1>
      <div class="case-selector">
        <label for="caseSelect">Case:</label>
        <select id="caseSelect">
          <option value="base_case">Base Case</option>
          <option value="3_owners">3 Owners</option>
          <option value="4_owners">4 Owners</option>
          <option value="5_owners">5 Owners</option>
          <option value="900k_house">900K House Price</option>
          <option value="90day_restriction">90-Day Airbnb Restriction</option>
          <option value="climate_risk">Climate Risk Scenario</option>
          <option value="early_exit">Early Exit (Poor Performance)</option>
          <option value="interest_rate_spike">Interest Rate Spike</option>
          <option value="migros">Migros Scenario</option>
          <option value="saron_mortgage">SARON Mortgage</option>
        </select>
      </div>
    </div>

    <!-- Main Layout -->
    <div class="main-layout">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-header">
          <i class="fas fa-list"></i> Analysis Types
        </div>
        <ul class="sidebar-menu" id="analysisMenu">
          <li
            class="sidebar-menu-item active"
            data-tooltip="Homepage - Overview of key financial metrics, purchase price, revenue, expenses, cash flow analysis, return metrics, and main cash requirements per owner. Start here to understand the basic investment performance."
          >
            <i class="fas fa-home"></i> Homepage
          </li>
          <li class="sidebar-menu-item">
            <a
              href="sensitivity.html"
              style="
                display: flex;
                align-items: center;
                gap: 10px;
                text-decoration: none;
                color: inherit;
                width: 100%;
              "
              data-tooltip="Sensitivity - Analyze how changes in key parameters (like occupancy rate, pricing, costs, etc.) impact monthly cash flow per owner. Use tornado charts to identify which variables have the biggest effect on your investment returns."
            >
              <i class="fas fa-sliders-h"></i> Sensitivity
            </a>
          </li>
          <li class="sidebar-menu-item">
            <a
              href="monte_carlo.html"
              style="
                display: flex;
                align-items: center;
                gap: 10px;
                text-decoration: none;
                color: inherit;
                width: 100%;
              "
              data-tooltip="Monte Carlo - Probabilistic risk analysis showing NPV distribution and probability of success across 10,000 simulations. Understand the range of possible outcomes and quantify investment uncertainty."
            >
              <i class="fas fa-dice"></i> Monte Carlo
            </a>
          </li>
        </ul>
      </div>

      <!-- Main Content Area -->
      <div class="content-area" id="contentArea">
        <div class="loading">
          <div class="loading-spinner"></div>
          <p>Loading dashboard...</p>
        </div>
      </div>
    </div>

    <script>
      // State management for the main dashboard
      const State = {
        currentCase: "base_case",
        data: {},
        initialized: false,
      };

      // Initialize the application
      async function initializeApp() {
        try {
          // Set initial case from URL or default
          const urlParams = new URLSearchParams(window.location.search);
          State.currentCase = urlParams.get("case") || "base_case";

          // Update UI
          document.getElementById("caseSelect").value = State.currentCase;

          // Load initial data
          await loadDataForCase(State.currentCase);

          State.initialized = true;
        } catch (error) {
          console.error("Failed to initialize app:", error);
          document.getElementById("contentArea").innerHTML = `
            <div style="text-align: center; padding: 50px; color: var(--danger);">
              <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
              <h2>Failed to Load Data</h2>
              <p>${error.message}</p>
              <p style="margin-top: 20px; color: #666;">
                Make sure you have run the analysis scripts to generate the data files.
              </p>
            </div>
          `;
        }
      }

      // Load data for a specific case
      async function loadDataForCase(caseName) {
        try {
          // Show loading
          document.getElementById("contentArea").innerHTML = `
            <div class="loading">
              <div class="loading-spinner"></div>
              <p>Loading dashboard for ${caseName}...</p>
            </div>
          `;

          // Load base case analysis data
          const baseCaseResponse = await fetch(
            `data/${caseName}_base_case_analysis.json`
          );
          if (!baseCaseResponse.ok) {
            throw new Error(`Failed to load base case data for ${caseName}`);
          }
          const baseCaseData = await baseCaseResponse.json();
          State.data[caseName] = { base_case: baseCaseData };

          // Render the dashboard
          renderDashboard(baseCaseData);
        } catch (error) {
          console.error("Failed to load data:", error);
          document.getElementById("contentArea").innerHTML = `
            <div style="text-align: center; padding: 50px; color: var(--danger);">
              <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
              <h2>Failed to Load Data</h2>
              <p>${error.message}</p>
            </div>
          `;
        }
      }

      // Render the main dashboard
      function renderDashboard(data) {
        const content = document.getElementById("contentArea");
        const results = data.annual_results || {};
        const irr = data.irr_results || {};

        let html = `
          <div class="section">
            <h2 class="section-title">üè† Main Dashboard - ${State.currentCase
              .replace("_", " ")
              .toUpperCase()}</h2>

            <!-- Info Box -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 14px 18px; border-radius: 8px; margin-bottom: 20px;">
              <p style="margin: 0; font-size: 0.85em; line-height: 1.5; opacity: 0.95;">
                üí° <strong>Main Dashboard</strong> ‚Äî Overview of key financial metrics. Use the sidebar to navigate to detailed sensitivity and Monte Carlo analyses.
              </p>
            </div>

            <!-- Key Financial Metrics -->
            <div class="kpi-grid">
              <div class="kpi-card" data-tooltip="Total purchase price of the property including any acquisition costs.">
                <h3>Purchase Price</h3>
                <div class="value">${(
                  results.purchase_price || 0
                ).toLocaleString("en-US", {
                  style: "currency",
                  currency: "CHF",
                  maximumFractionDigits: 0,
                })}</div>
              </div>
              <div class="kpi-card" data-tooltip="Annual gross rental income from Airbnb operations.">
                <h3>Gross Revenue</h3>
                <div class="value">${(
                  results.gross_rental_income || 0
                ).toLocaleString("en-US", {
                  style: "currency",
                  currency: "CHF",
                  maximumFractionDigits: 0,
                })}</div>
                <div class="unit">per year</div>
              </div>
              <div class="kpi-card" data-tooltip="Total annual operating expenses including property management, maintenance, insurance, etc.">
                <h3>Total Expenses</h3>
                <div class="value">${(
                  results.total_operating_expenses || 0
                ).toLocaleString("en-US", {
                  style: "currency",
                  currency: "CHF",
                  maximumFractionDigits: 0,
                })}</div>
                <div class="unit">per year</div>
              </div>
              <div class="kpi-card" data-tooltip="Annual net operating income (revenue minus operating expenses).">
                <h3>Net Operating Income</h3>
                <div class="value">${(
                  (results.gross_rental_income || 0) -
                  (results.total_operating_expenses || 0)
                ).toLocaleString("en-US", {
                  style: "currency",
                  currency: "CHF",
                  maximumFractionDigits: 0,
                })}</div>
                <div class="unit">per year</div>
              </div>
            </div>

            <!-- Cash Flow Analysis -->
            <div class="kpi-grid">
              <div class="kpi-card" data-tooltip="Annual debt service (interest + principal payments).">
                <h3>Debt Service</h3>
                <div class="value">${(results.debt_service || 0).toLocaleString(
                  "en-US",
                  {
                    style: "currency",
                    currency: "CHF",
                    maximumFractionDigits: 0,
                  }
                )}</div>
                <div class="unit">per year</div>
              </div>
              <div class="kpi-card" data-tooltip="Annual cash flow before tax (NOI minus debt service).">
                <h3>Cash Flow (BTCF)</h3>
                <div class="value ${
                  (results.cash_flow_before_tax || 0) >= 0 ? "positive" : "negative"
                }">${(results.cash_flow_before_tax || 0).toLocaleString("en-US", {
                  style: "currency",
                  currency: "CHF",
                  maximumFractionDigits: 0,
                })}</div>
                <div class="unit">per year</div>
              </div>
              <div class="kpi-card" data-tooltip="Annual cash flow per owner before tax.">
                <h3>Cash Flow / Owner</h3>
                <div class="value ${
                  ((results.cash_flow_before_tax || 0) /
                    (data.config?.financing?.num_owners || 1)) >= 0
                    ? "positive"
                    : "negative"
                }">${(
          (results.cash_flow_before_tax || 0) /
          (data.config?.financing?.num_owners || 1)
        ).toLocaleString("en-US", {
          style: "currency",
          currency: "CHF",
          maximumFractionDigits: 0,
        })}</div>
                <div class="unit">per year</div>
              </div>
              <div class="kpi-card" data-tooltip="Monthly cash flow contribution required per owner.">
                <h3>Monthly NCF / Owner</h3>
                <div class="value ${
                  ((results.cash_flow_before_tax || 0) /
                    (data.config?.financing?.num_owners || 1) /
                    12) >= 0
                    ? "positive"
                    : "negative"
                }">${(
          (results.cash_flow_before_tax || 0) /
          (data.config?.financing?.num_owners || 1) /
          12
        ).toLocaleString("en-US", {
          style: "currency",
          currency: "CHF",
          maximumFractionDigits: 0,
        })}</div>
                <div class="unit">per month</div>
              </div>
            </div>

            <!-- Return Metrics -->
            <div class="kpi-grid">
              <div class="kpi-card" data-tooltip="Equity Internal Rate of Return over 15 years including property sale.">
                <h3>Equity IRR (15Y)</h3>
                <div class="value">${(
                  irr.equity_irr_with_sale_pct || 0
                ).toFixed(1)}%</div>
              </div>
              <div class="kpi-card" data-tooltip="Net Present Value at 5% discount rate.">
                <h3>NPV @ 5%</h3>
                <div class="value ${
                  (irr.npv_at_5pct || 0) >= 0 ? "positive" : "negative"
                }">${(irr.npv_at_5pct || 0).toLocaleString("en-US", {
                  style: "currency",
                  currency: "CHF",
                  maximumFractionDigits: 0,
                })}</div>
              </div>
              <div class="kpi-card" data-tooltip="Multiple on invested capital over 15 years.">
                <h3>MOIC</h3>
                <div class="value">${irr.moic.toFixed(2)}√ó</div>
              </div>
              <div class="kpi-card" data-tooltip="Payback period in years.">
                <h3>Payback Period</h3>
                <div class="value">${irr.payback_years.toFixed(1)} years</div>
              </div>
            </div>

            <!-- Main Cash Requirements -->
            <div style="background: #f8f9fa; border-left: 5px solid #667eea; padding: 25px; border-radius: 8px; margin-bottom: 25px;">
              <h3 style="margin-top: 0; color: var(--primary); font-size: 1.2em;">üí∞ Main Cash Requirements per Owner</h3>
              <div style="margin-top: 15px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                  <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6; text-align: center;">
                    <div style="font-size: 1.2em; font-weight: bold; color: var(--primary); margin-bottom: 5px;">CHF ${(
                      results.debt_service /
                      (data.config?.financing?.num_owners || 1)
                    ).toLocaleString()}</div>
                    <div style="font-size: 0.9em; color: #666;">Debt Service / Year</div>
                  </div>
                  <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6; text-align: center;">
                    <div style="font-size: 1.2em; font-weight: bold; color: var(--primary); margin-bottom: 5px;">CHF ${(
                      (data.config?.expenses?.nubbing_costs_annual || 0) /
                      (data.config?.financing?.num_owners || 1)
                    ).toLocaleString()}</div>
                    <div style="font-size: 0.9em; color: #666;">Nabenkosten / Year</div>
                  </div>
                  <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6; text-align: center;">
                    <div style="font-size: 1.2em; font-weight: bold; color: var(--primary); margin-bottom: 5px;">CHF ${(
                      ((data.config?.expenses?.electricity_internet_annual ||
                        0) +
                        (data.config?.expenses?.insurance_annual || 0)) /
                      (data.config?.financing?.num_owners || 1)
                    ).toLocaleString()}</div>
                    <div style="font-size: 0.9em; color: #666;">Utilities & Insurance / Year</div>
                  </div>
                  <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6; text-align: center;">
                    <div style="font-size: 1.2em; font-weight: bold; color: var(--primary); margin-bottom: 5px;">CHF ${(
                      ((data.config?.expenses?.maintenance_rate || 0) *
                        (data.config?.expenses?.property_value || 0)) /
                      (data.config?.financing?.num_owners || 1)
                    ).toLocaleString()}</div>
                    <div style="font-size: 0.9em; color: #666;">Maintenance Reserve / Year</div>
                  </div>
                </div>
                <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                  <strong>Note:</strong> These figures represent minimum annual cash requirements per owner. Property taxes and furniture costs are not included as they vary by location and are typically handled separately. During low-revenue periods, these fixed costs must still be paid.
                </div>
              </div>
            </div>

            <!-- Key Assumptions Summary -->
            <div style="background: #f8f9fa; border-left: 5px solid #28a745; padding: 25px; border-radius: 8px; margin-bottom: 25px;">
              <h3 style="margin-top: 0; color: #28a745; font-size: 1.2em;">üìã Key Assumptions - ${State.currentCase
                .replace("_", " ")
                .toUpperCase()}</h3>
              <div style="margin-top: 15px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                  <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
                    <div style="font-weight: 600; color: var(--primary); margin-bottom: 8px;">üè† Property</div>
                    <div style="font-size: 0.9em; line-height: 1.5;">
                      ‚Ä¢ Purchase Price: CHF ${(
                        data.config?.financing?.purchase_price || 0
                      ).toLocaleString()}<br>
                      ‚Ä¢ Financing: ${
                        (data.config?.financing?.ltv || 0) * 100
                      }% LTV<br>
                      ‚Ä¢ Owners: ${data.config?.financing?.num_owners || 1}<br>
                      ‚Ä¢ Interest Rate: ${
                        (data.config?.financing?.interest_rate || 0) * 100
                      }%
                    </div>
                  </div>
                  <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
                    <div style="font-weight: 600; color: var(--primary); margin-bottom: 8px;">üí∞ Revenue</div>
                    <div style="font-size: 0.9em; line-height: 1.5;">
                      ‚Ä¢ Occupancy: ${
                        (data.config?.rental?.legacy_occupancy_rate || 0) * 100
                      }%<br>
                      ‚Ä¢ Daily Rate: CHF ${
                        data.config?.rental?.legacy_average_daily_rate || 0
                      }<br>
                      ‚Ä¢ Length of Stay: ${
                        data.config?.expenses?.average_length_of_stay || 0
                      } nights<br>
                      ‚Ä¢ Annual Revenue: CHF ${(
                        results.gross_rental_income || 0
                      ).toLocaleString()}
                    </div>
                  </div>
                  <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
                    <div style="font-weight: 600; color: var(--primary); margin-bottom: 8px;">üí∏ Costs</div>
                    <div style="font-size: 0.9em; line-height: 1.5;">
                      ‚Ä¢ Property Management: ${
                        (data.config?.expenses?.property_management_fee_rate ||
                          0) * 100
                      }%<br>
                      ‚Ä¢ Cleaning: CHF ${
                        data.config?.expenses?.cleaning_cost_per_stay || 0
                      }/stay<br>
                      ‚Ä¢ Maintenance: ${
                        (data.config?.expenses?.maintenance_rate || 0) * 100
                      }% of value<br>
                      ‚Ä¢ Insurance: CHF ${(
                        data.config?.expenses?.insurance_annual || 0
                      ).toLocaleString()}/year
                    </div>
                  </div>
                  <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
                    <div style="font-weight: 600; color: var(--primary); margin-bottom: 8px;">üìä Analysis</div>
                    <div style="font-size: 0.9em; line-height: 1.5;">
                      ‚Ä¢ Time Horizon: 15 years<br>
                      ‚Ä¢ Property Appreciation: ${
                        (data.config?.projection?.property_appreciation_rate ||
                          0) * 100
                      }%<br>
                      ‚Ä¢ Inflation: ${
                        (data.config?.projection?.inflation_rate || 0) * 100
                      }%<br>
                      ‚Ä¢ Discount Rate: ${
                        (data.config?.projection?.discount_rate || 0) * 100
                      }%
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Yearly After-Tax Cash Flow Chart -->
            <div style="background: #f8f9fa; border-left: 5px solid #17a2b8; padding: 25px; border-radius: 8px; margin-bottom: 25px;">
              <h3 style="margin-top: 0; color: #17a2b8; font-size: 1.2em;">üìà Yearly After-Tax Cash Flow Projection</h3>
              <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">15-year projection of after-tax cash flow per owner, including tax benefits from interest and amortization deductions.</p>
              <div class="chart-wrapper" id="cashFlowChart" style="height: 350px;"></div>
            </div>
          </div>
        `;

        content.innerHTML = html;

        // Create the cash flow chart
        if (data.projection && data.projection.length > 0) {
          const years = data.projection.map((p) => `Year ${p.year_number}`);
          const afterTaxCashFlow = data.projection.map(
            (p) => p.after_tax_cash_flow_per_owner || 0
          );

          const trace = {
            x: years,
            y: afterTaxCashFlow,
            type: "scatter",
            mode: "lines+markers",
            name: "After-Tax Cash Flow per Owner",
            line: { color: "#17a2b8", width: 3 },
            marker: {
              color: afterTaxCashFlow.map((value) =>
                value >= 0 ? "#28a745" : "#dc3545"
              ),
              size: 8,
              symbol: "circle",
            },
            hovertemplate:
              "<b>%{x}</b><br>" +
              "After-Tax Cash Flow: CHF %{y:,.0f}<br>" +
              "<extra></extra>",
          };

          const layout = {
            title: "",
            xaxis: {
              title: "Year",
              tickangle: -45,
              gridcolor: "#e8ecef",
            },
            yaxis: {
              title: "After-Tax Cash Flow per Owner (CHF)",
              gridcolor: "#e8ecef",
              tickformat: ",.0f",
            },
            showlegend: false,
            paper_bgcolor: "#ffffff",
            plot_bgcolor: "#fafbfc",
            font: { family: "Segoe UI, Arial", size: 11, color: "#2c3e50" },
            margin: { l: 60, r: 30, t: 20, b: 80 },
            shapes: [
              {
                type: "line",
                x0: -0.5,
                y0: 0,
                x1: years.length - 0.5,
                y1: 0,
                line: {
                  color: "#6c757d",
                  width: 2,
                  dash: "dash",
                },
              },
            ],
            annotations: [
              {
                x: years.length - 1,
                y: afterTaxCashFlow[afterTaxCashFlow.length - 1],
                xref: "x",
                yref: "y",
                text: `CHF ${afterTaxCashFlow[
                  afterTaxCashFlow.length - 1
                ].toLocaleString()}`,
                showarrow: true,
                arrowhead: 2,
                arrowsize: 1,
                arrowwidth: 2,
                arrowcolor:
                  afterTaxCashFlow[afterTaxCashFlow.length - 1] >= 0
                    ? "#28a745"
                    : "#dc3545",
                ax: 40,
                ay: 0,
                bgcolor: "rgba(255,255,255,0.9)",
                bordercolor:
                  afterTaxCashFlow[afterTaxCashFlow.length - 1] >= 0
                    ? "#28a745"
                    : "#dc3545",
                borderwidth: 1,
                borderpad: 4,
              },
            ],
          };

          Plotly.newPlot("cashFlowChart", [trace], layout, {
            responsive: true,
            displayModeBar: false,
          });
        }
      }

      // Event listeners
      document
        .getElementById("caseSelect")
        .addEventListener("change", async (e) => {
          const newCase = e.target.value;
          State.currentCase = newCase;

          // Update URL without page reload
          const url = new URL(window.location);
          url.searchParams.set("case", newCase);
          window.history.pushState({}, "", url);

          // Load data for new case
          await loadDataForCase(newCase);
        });

      // Initialize the application
      initializeApp();
    </script>
  </body>
</html>
